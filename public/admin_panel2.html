<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Super Admin Panel 2 - LabLinX DLSU-D</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

 <style>

    /* Add this to your existing styles, near the other .btn styles */
.btn-delete-permanent {
    background-color: #8B0000; /* Dark Red */
    color: white;
    font-weight: 700;
}
.btn-delete-permanent:hover {
    background-color: #A52A2A; 
}
/* --- 1. Global Styles & Variables (DLSU Theme) --- */
:root {
    --primary-dark: #00503B; /* DLSU Deep Green */
    --primary-light: #007A5A; /* DLSU Lighter Green */
    --accent-gold: #FFCD00; /* DLSU Gold */
    --text-light: #f8f9fa;
    --text-dark: #343a40;
    --background-light: #f4f6f9;
    --background-dark: #181a1f;
    --card-bg-light: #ffffff;
    --card-bg-dark: #212529;
    --border-light: #dee2e6;
    --border-dark: #495057;
    --success: #28a745;
    --danger: #dc3545;
    --warning: #f0ad4e;
    --info: #17a2b8;
    --calibration: #9370DB; 
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --font-family: "Avenir", "Helvetica Neue", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}

/* Chart Container styles */
.chart-container {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 2rem;
    margin-top: 2rem;
}
.chart-card {
    background-color: var(--card-bg-light);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-light);
}
body.dark .chart-card {
    background-color: var(--card-bg-dark);
    border-color: var(--border-dark);
}
/* Reset & Base */
* { box-sizing: border-box; margin: 0; padding: 0; }
body, html { font-family: var(--font-family); background-color: var(--background-light); color: var(--text-dark); min-height: 100vh; overflow-x: hidden; transition: background-color 0.3s ease, color 0.3s ease; }
body.dark { background-color: var(--background-dark); color: var(--text-light); }
a { text-decoration: none; color: inherit; }

/* --- 2. Sidebar --- */
#sidebar { width: 250px; background-color: var(--primary-dark); height: 100vh; color: var(--text-light); position: fixed; top: 0; left: 0; display: flex; flex-direction: column; padding: 1.5rem 0; z-index: 200; transition: width 0.3s ease; border-right: 1px solid var(--primary-light); }
#sidebar .logo { display: flex; flex-direction: column; align-items: center; margin-bottom: 2rem; padding: 0 1rem; }
#sidebar .logo img { width: 70px; height: 70px; margin-bottom: 0.5rem; border-radius: 50%; cursor: pointer; }
#sidebar .logo-title { color: var(--accent-gold); font-weight: 700; font-size: 1rem; opacity: 1; transition: opacity 0.2s ease; }
#sidebar nav { display: flex; flex-direction: column; width: 100%; margin-top: 1rem; flex-grow: 1; overflow-y: auto; }
#sidebar nav a { color: #e0e0e0; padding: 14px 25px; font-weight: 500; display: flex; align-items: center; justify-content: space-between; gap: 15px; transition: background-color 0.2s, color 0.2s, border-left-color 0.2s; border-left: 4px solid transparent; cursor: pointer; pointer-events: auto; }
#sidebar nav a .link-content { display: flex; align-items: center; gap: 15px; pointer-events: auto; cursor: pointer; }
#sidebar nav a svg { width: 20px; height: 20px; flex-shrink: 0; }
#sidebar nav a:hover { background-color: var(--primary-light); color: var(--accent-gold); }
#sidebar nav a.active { background-color: var(--accent-gold); color: var(--primary-dark); font-weight: 600; border-left-color: #fff; }
.logout-link { margin-top: auto; }
.notification-badge { background-color: var(--danger); color: white; font-size: 0.75rem; font-weight: bold; padding: 2px 7px; border-radius: 50%; display: none; }
body.sidebar-collapsed #sidebar { width: 80px; }
body.sidebar-collapsed .logo-title, body.sidebar-collapsed nav a span, body.sidebar-collapsed .notification-badge { display: none; }
body.sidebar-collapsed nav a { justify-content: center; }

/* --- 3. Header / Topbar --- */
header { margin-left: 250px; height: 65px; background-color: var(--card-bg-light); display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 150; transition: margin-left 0.3s ease, background-color 0.3s ease; border-bottom: 1px solid var(--border-light); }
body.dark header { background-color: var(--card-bg-dark); border-bottom-color: var(--border-dark); }
body.sidebar-collapsed header { margin-left: 80px; }
.header-left { display: flex; align-items: center; gap: 1rem; }
.toggle-btn { background: none; border: none; cursor: pointer; color: var(--text-dark); }
body.dark .toggle-btn { color: var(--text-light); }
.toggle-btn svg { width: 24px; height: 24px; }
.top-actions { display: flex; align-items: center; gap: 1.5rem; }
.dark-toggle { background: none; border: none; cursor: pointer; color: var(--text-dark); }
body.dark .dark-toggle { color: var(--text-light); }
.dark-toggle svg { width: 22px; height: 22px; }
.profile img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary-dark); }

/* --- 4. Main Content --- */
main { margin-left: 250px; padding: 2.5rem; transition: margin-left 0.3s ease; }
body.sidebar-collapsed main { margin-left: 80px; }
main h1 { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--primary-dark); }
body.dark main h1 { color: var(--accent-gold); }
.page-subtitle { margin-top: 0; margin-bottom: 2.5rem; font-size: 1.1rem; color: #6c757d; font-weight: 500; }
body.dark .page-subtitle { color: #adb5bd; }
.page-content { display: none; }
.page-content.active { display: block; }
#sidebar nav a { user-select: none; -webkit-user-select: none; }

/* --- 5. Dashboard Specific Styles --- */
.dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; }
.card { background-color: var(--card-bg-light); border-radius: 12px; padding: 1.5rem; box-shadow: var(--shadow); transition: transform 0.25s ease, box-shadow 0.25s ease; border: 1px solid var(--border-light); display: flex; flex-direction: column; justify-content: space-between; min-height: 180px; }
body.dark .card { background-color: var(--card-bg-dark); border-color: var(--border-dark); }
.card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
.card-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
.card-icon { width: 48px; height: 48px; border-radius: 8px; display: grid; place-items: center; }
.card-icon svg { width: 28px; height: 28px; color: #fff; }
.icon-aqua { background-color: #1abc9c; } .icon-red { background-color: #e74c3c; } .icon-green { background-color: #2ecc71; }
.card-header-text .title { font-weight: 600; font-size: 1rem; }
.card-header-text .subtitle { font-size: 0.85rem; color: #6c757d; }
body.dark .card-header-text .subtitle { color: #adb5bd; }
.card-body .counter { font-size: 2.8rem; font-weight: 700; line-height: 1; color: var(--primary-dark); }
body.dark .card-body .counter { color: var(--text-light); }
.card-body .items { font-size: 0.9rem; margin-top: 4px; color: #6c757d; }
body.dark .card-body .items { color: #adb5bd; }
.card-footer { margin-top: 1.5rem; font-size: 0.9rem; font-weight: 500; color: var(--primary-light); display: flex; align-items: center; gap: 5px; }
body.dark .card-footer { color: var(--accent-gold); }

/* --- 6. Inventory, Requests & Notifications Styles --- */
.inventory-card { background-color: var(--card-bg-light); border-radius: 8px; width: 100%; padding: 1.5rem 2rem; margin-bottom: 2rem; box-shadow: var(--shadow); border: 1px solid var(--border-light); }
body.dark .inventory-card { background-color: var(--card-bg-dark); border-color: var(--border-dark); }
.inventory-card h2 { margin-top: 0; margin-bottom: 1.5rem; font-size: 1.5rem; color: var(--primary-dark); border-bottom: 1px solid var(--border-light); padding-bottom: 0.75rem; }
body.dark .inventory-card h2 { color: var(--accent-gold); border-bottom-color: var(--border-dark); }
.filter-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; }
.search-bar { flex-grow: 1; min-width: 250px; }
.search-bar input, .filter-select select, .filter-row button {
    width: 100%; padding: 10px 15px;
    border-radius: 6px; border: 1px solid var(--border-light);
    font-size: 1rem; background-color: var(--card-bg-light);
    color: var(--text-dark); transition: all 0.3s ease;
}
.filter-row button { 
    width: auto; cursor: pointer; font-weight: 600;
    background-color: #e9ecef; border-color: #ced4da;
}
.filter-row button:hover { background-color: #dde1e5; }
body.dark .search-bar input, body.dark .filter-select select, body.dark .filter-row button {
    background-color: #2a2a2e; border-color: var(--border-dark); color: var(--text-light);
}
body.dark .inventory-category-select {
    background-color: var(--card-bg-dark); border-color: var(--border-dark); color: var(--text-light);
}
body.dark .inventory-category-select option {
    background-color: var(--card-bg-dark); color: var(--text-light);
}
body.dark .filter-row button { background-color: #343a40; border-color: #495057; }
body.dark .filter-row button:hover { background-color: #495057; }
.search-bar input:focus, .filter-select select:focus {
    outline: none; box-shadow: 0 0 0 3px rgba(0, 80, 59, 0.25);
}
.filter-select { display: flex; flex-direction: column; gap: 0.25rem; }
.filter-select label { font-size: 0.85rem; font-weight: 500; color: var(--text-subtle); }
body.dark .filter-select label { color: var(--text-subtle-dark-mode); }

.add-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; align-items: flex-end; }
.add-form input, .add-form select { padding: 8px 12px; border-radius: 5px; border: 1px solid var(--border-light); font-size: 0.95rem; width: 100%; background-color: var(--card-bg-light); color: var(--text-dark); }
body.dark .add-form input, body.dark .add-form select { background-color: var(--card-bg-dark); border-color: var(--border-dark); color: var(--text-light); }
.add-form button { background-color: var(--primary-dark); color: var(--accent-gold); padding: 9px 20px; border-radius: 5px; border: none; cursor: pointer; font-weight: 600; transition: background-color 0.2s; white-space: nowrap; }
.add-form button:hover { background-color: var(--primary-light); }
table { width: 100%; border-collapse: collapse; font-size: 0.95rem; table-layout: fixed; }
table th, table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-light); word-wrap: break-word; }
body.dark table th, body.dark table td { border-bottom-color: var(--border-dark); }
table th { background-color: var(--background-light); color: var(--primary-dark); font-weight: 600; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; }
body.dark table th { background-color: var(--background-dark); color: var(--text-light); }
table tr:last-child td { border-bottom: none; }
table tbody tr:hover { background-color: #fcf8e3; }
body.dark table tbody tr:hover { background-color: #2c2f33; }
table td .status-select { padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border-light); font-weight: 500; background: transparent; color: var(--text-dark); }
body.dark table td .status-select { border-color: var(--border-dark); color: var(--text-light); }
body.dark table td .status-select option { background-color: var(--card-bg-dark); }
.status-Available {
    background-color: rgba(46, 204, 113, 0.18);
    color: #0f5132;
}
.status-In-Use {
    background-color: rgba(255, 193, 7, 0.22);
    color: #664d03;
}
.status-Maintenance,
.status-Damaged {
    background-color: rgba(220, 53, 69, 0.22);
    color: #842029;
}
.status-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; color: #343a40; text-align: center; }
.status-Pending { background-color: var(--warning); }
.status-Approved { background-color: var(--success); }
.status-Rejected { background-color: var(--danger); }
.status-Returned { background-color: #6c757d; }
/* --- ADDED: Calibration from admin_panel4.html --- */
.status-Calibration {
    background-color: rgba(147, 112, 219, 0.22);
    color: #45307d;
}
    /* .actions-cell { display: flex; gap: 10px; padding: 15px; width: auto; flex-direction: column; justify-content: center; align-items: center;} */

table th:last-child, table td:last-child { 
    width: auto; 
    min-width: 150px; 
    max-width: 300px; 
    overflow: visible; 
}
.btn { padding: 6px 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.8rem; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; transition: opacity 0.2s; white-space: nowrap; flex-shrink: 0; }
.btn:hover { opacity: 0.85; }
.btn svg { width: 14px; height: 14px; }
.btn-edit { background-color: var(--success); color: white; }
.btn-delete { background-color: var(--danger); color: white; }
.btn-restore { background-color: var(--info); color: white; }
#notification-list .notification-item { background-color: var(--card-bg-light); border-left: 5px solid var(--primary-light); margin-bottom: 1rem; padding: 1rem; border-radius: 5px; box-shadow: var(--shadow); }
body.dark #notification-list .notification-item { background-color: var(--card-bg-dark); border-left-color: var(--accent-gold); }
#notification-list .notification-title { font-weight: bold; color: var(--primary-dark); margin-bottom: 0.25rem; }
body.dark #notification-list .notification-title { color: var(--accent-gold); }
#notification-list .notification-message { color: #6c757d; }
body.dark #notification-list .notification-message { color: #adb5bd; }
#notification-list .notification-time { font-size: 0.8rem; color: #6c757d; margin-top: 0.5rem; text-align: right; }
body.dark #notification-list .notification-time { color: #adb5bd; }

/* --- 7. Modal & Toast Styles --- */
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
.modal-content { background-color: var(--card-bg-light); margin: auto; padding: 25px; width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
body.dark .modal-content { background-color: var(--card-bg-dark); }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
.modal-header h2 { margin: 0; color: var(--primary-dark); }
body.dark .modal-header h2 { color: var(--text-light); }
.close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
.close-button:hover, .close-button:focus { color: var(--text-dark); }
body.dark .close-button:hover, body.dark .close-button:focus { color: var(--text-light); }
.modal-content form { display: grid; grid-template-columns: 1fr; gap: 1rem; }
.modal-content form label { font-weight: 600; margin-bottom: -10px; }
.modal-content form input, .modal-content form textarea, .modal-content form select { width: 100%; padding: 10px; border: 1px solid var(--border-light); border-radius: 5px; background-color: var(--card-bg-light); color: var(--text-dark); }
body.dark .modal-content form input, body.dark .modal-content form textarea, body.dark .modal-content form select { background-color: var(--card-bg-dark); border-color: var(--border-dark); color: var(--text-light); }
.modal-content form button { background-color: var(--primary-dark); color: white; padding: 12px; border: none; border-radius: 5px; font-weight: 600; cursor: pointer; margin-top: 1rem; }
#toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
.toast { padding: 12px 20px; background-color: var(--primary-dark); color: white; border-radius: 6px; box-shadow: var(--shadow); }

/* --- ADDED: STYLES for Return Condition Modal (from admin3) --- */
#returnConditionModal .modal-header h2 {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--primary-dark);
}
body.dark #returnConditionModal .modal-header h2 {
    color: var(--text-light);
}
#returnConditionForm select {
    appearance: none; /* Remove default arrow */
    background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 16px;
    padding-right: 30px !important; 
    font-weight: 600;
}
.modal-content p strong { 
    color: var(--primary-dark); 
}
body.dark .modal-content p strong {
    color: var(--accent-gold); 
}
/* --- END ADDED STYLES --- */


/* --- 8. Responsive Design --- */
@media screen and (max-width: 992px) {
    .chart-container { grid-template-columns: 1fr; }
}
@media screen and (max-width: 768px) { body:not(.sidebar-collapsed) #sidebar { width: 80px; } body:not(.sidebar-collapsed) .logo-title, body:not(.sidebar-collapsed) nav a span { display: none; } body:not(.sidebar-collapsed) nav a { justify-content: center; } header, main { margin-left: 80px; } main { padding: 1.5rem; } }
@media screen and (max-width: 600px) { body { padding-bottom: 60px; } #sidebar { bottom: 0; top: auto; width: 100%; height: 60px; flex-direction: row; align-items: center; justify-content: space-around; border-top: 1px solid var(--border-light); padding: 0; } body.dark #sidebar { border-top-color: var(--border-dark); } #sidebar .logo { display: none; } #sidebar nav { margin-top: 0; flex-direction: row; width: 100%; justify-content: space-around; } #sidebar nav a { border-left: none; border-top: 4px solid transparent; } #sidebar nav a.active { border-top-color: #fff; border-left-color: transparent;} .logout-link { display: none; } header, main { margin-left: 0; } }

/* --- Period Buttons --- */
.period-btn {
    background-color: #f0f0f0; color: var(--primary-dark); padding: 8px 16px; border-radius: 5px;
    border: 1px solid var(--border-light); cursor: pointer; font-weight: 600;
    margin-right: 10px; transition: background-color 0.2s, color 0.2s;
}
.period-btn:hover, .period-btn.active { background-color: var(--accent-gold); color: var(--primary-dark); }
body.dark .period-btn { background-color: var(--background-dark); border-color: var(--border-dark); color: var(--text-light); }
body.dark .period-btn:hover, body.dark .period-btn.active { background-color: var(--accent-gold); color: var(--primary-dark); }

/* --- 9. Live Scan Styles --- */
.live-scan-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    max-width: 1200px;
    margin: 0 auto;
}

.live-scan-container .form-group {
    margin-bottom: 1.5rem;
}
.live-scan-container .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
}
.live-scan-container .scan-input {
    font-size: 1.5rem;
    padding: 15px;
    text-align: center;
    border: 2px dashed var(--border-light);
    border-radius: 8px;
    width: 100%;
    background-color: var(--card-bg-light);
    color: var(--text-dark);
}
/* --- ADDED: prefix-input styles (from admin3) --- */
.prefix-input {
    font-size: 1.2rem;
    padding: 12px;
    text-align: center;
    border: 1px solid var(--border-light);
    border-radius: 6px;
    width: 100%;
}
body.dark .prefix-input {
    background-color: var(--card-bg-dark);
    border-color: var(--border-dark);
    color: var(--text-light);
}

body.dark .live-scan-container .scan-input { 
    border-color: var(--border-dark); 
    background-color: var(--card-bg-dark);
    color: var(--text-light);
}
.live-scan-container .scan-input:focus { 
    border-style: solid; 
    border-color: var(--primary-light); 
    outline: none;
}
.live-scan-container .scan-input:read-only {
    background-color: var(--background-light);
    border-style: solid;
    cursor: not-allowed;
}
body.dark .live-scan-container .scan-input:read-only {
    background-color: var(--background-dark);
}

.scan-controls { display: flex; gap: 1rem; align-items: center; margin-bottom: 1.5rem; }
.scan-controls label { font-weight: 600; }
.scan-controls select { padding: 8px; border-radius: 5px; border: 1px solid var(--border-light); }

.auto-submit-toggle {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-left: auto; /* Pushes it to the right */
}
.auto-submit-toggle label {
    cursor: pointer;
    user-select: none;
}

.status-box {
    margin-top: 1.5rem;
    padding: 1.5rem;
    border-radius: 8px;
    font-size: 1.2rem;
    font-weight: 500;
    text-align: center;
    min-height: 100px;
    display: flex;
    flex-direction: column; /* --- ADDED: from admin_panel4.html --- */
    align-items: center;
    justify-content: center;
    background-color: var(--background-light);
    border: 1px solid var(--border-light);
}
body.dark .status-box { background-color: var(--background-dark); border-color: var(--border-dark); }
.status-box.success { border-left: 5px solid var(--success); color: var(--success); }
.status-box.error { border-left: 5px solid var(--danger); color: var(--danger); }
/* --- ADDED: .info style (from admin3) --- */
.status-box.info { border-left: 5px solid var(--info); color: var(--info); }
/* --- ADDED: .equipment-ready style (from admin4) --- */
.status-box.equipment-ready { border-left: 5px solid var(--calibration); color: var(--calibration); }

/* --- ADDED: New Styles for Buttons (from admin3/4) --- */
.scan-action-buttons {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
    justify-content: center;
}
.scan-action-buttons button {
    padding: 10px 20px;
    border-radius: 5px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.2s;
    display: none; /* Initially hidden */
}
#scanAnotherItemBtn {
    background-color: var(--primary-light);
    color: white;
}
#scanAnotherItemBtn:hover {
    background-color: var(--primary-dark);
}
#cancelScanBtn {
    background-color: var(--danger);
    color: white;
}
#cancelScanBtn:hover {
    background-color: #a02c38;
}
/* --- ADDED: #updateStatusBtn style (from admin4) --- */
#updateStatusBtn {
    background-color: var(--calibration);
    color: white;
}
#updateStatusBtn:hover {
    background-color: #7b4fb0;
}


#capturedStudentIdDisplay { font-weight: 600; margin-top: 1rem; color: var(--primary-light); }
body.dark #capturedStudentIdDisplay { color: var(--accent-gold); }

#trackingDetailsContainer h3 { margin-top: 0; margin-bottom: 0.5rem; font-size: 1.25rem; }
#trackingDetailsContainer .detail-item { font-weight: 600; }
#trackingBorrowerInfo {
    background-color: #fff3cd;
    color: #664d03;
    padding: 1rem;
    border-radius: 6px;
    margin-top: 1rem;
    border: 1px solid #ffecb5;
}
body.dark #trackingBorrowerInfo {
    background-color: #332701;
    color: #ffc107;
    border-color: #664d03;
}
#trackingHistoryLog {
    margin-top: 1rem;
    font-family: monospace;
    font-size: 0.9rem;
    max-height: 200px;
    overflow-y: auto;
}
#trackingHistoryLog div {
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border-light);
}
body.dark #trackingHistoryLog div { border-bottom-color: var(--border-dark); }

</style>
</head>
<body>
    <aside id="sidebar">
        <div class="logo">
            <img src="logo.png" alt="LabLinX Logo">
            <div class="logo-title">LabLinX DLSU-D</div>
        </div>
        <nav>
            <a data-page="dashboard" class="active">
                <div class="link-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                    <span>Dashboard</span>
                </div>
            </a>
            <a data-page="live-scan">
                <div class="link-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 013.75 9.375v-4.5zM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 01-1.125-1.125v-4.5zM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0113.5 9.375v-4.5z" /><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 01-1.125-1.125v-4.5z" /></svg>
                    <span>Live Scan</span>
                </div>
            </a>
            <a data-page="super-admin">
                <div class="link-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    <span>Super Admin</span>
                </div>
            </a>
            <a data-page="user-management">
                <div class="link-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197m0 0A5.975 5.975 0 0112 13a5.975 5.975 0 013 1.182M15 21a6 6 0 00-9-5.197" /></svg>
                    <span>User Management</span>
                </div>
            </a>
            <a data-page="profile-requests">
                <div class="link-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
                    <span>Profile Requests</span>
                </div>
            </a>
            <a data-page="registration-requests">
                <div class="link-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z" />
                    </svg>
                    <span>Registration Requests</span>
                </div>
            </a>
            <a data-page="inventory">
                <div class="link-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                    <span>Inventory</span>
                </div>
            </a>
            <a data-page="requests">
                <div class="link-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>
                    <span>Requests</span>
                </div>
            </a>
            <a data-page="incident-reports">
                <div class="link-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    <span>Student Reported Incidents (LF-05)</span>
                </div>
            </a>
            <a data-page="notifications">
                <div class="link-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                    <span>Notifications</span>
                </div>
                <span id="notification-badge" class="notification-badge">0</span>
            </a>
             <a data-page="history">
                <div class="link-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                    <span>History</span>
                </div>
            </a>
            <a data-page="reports">
                <div class="link-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-6a2 2 0 012-2h6M9 17H5a2 2 0 01-2-2v-6a2 2 0 012-2h4m6 10v4m0-4h4m-4 0H9" /></svg>
                    <span>Reports</span>
                </div>
            </a>
            <a href="/logout" class="logout-link">
                <div class="link-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    <span>Log Out</span>
                </div>
            </a>
        </nav>
    </aside>

    <header>
        <div class="header-left">
            <button class="toggle-btn" title="Toggle Sidebar">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>
        <div class="top-actions">
            <button class="dark-toggle" title="Toggle Dark Mode">
                <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                <svg class="moon-icon" style="display:none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
            <a href="#" class="profile">
                <img src="https://i.pravatar.cc/40" alt="User Profile Picture">
            </a>
        </div>
    </header>

    <main>
        <div id="dashboard-content" class="page-content active">
            <h1>Super Admin Dashboard</h1>
            <p class="page-subtitle">Monitoring overview of all admin panels.</p>
            <section class="dashboard-cards">
                 <article class="card">
                     <div class="card-header"><div class="card-icon" style="background-color: #3498db;"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h6.375a.75.75 0 01.75.75v3.375a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75V7.5a.75.75 0 01.75-.75zM9 15h6.375a.75.75 0 01.75.75v3.375a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75V15.75a.75.75 0 01.75-.75z" /></svg></div><div class="card-header-text"><div class="title">Total Facility Items</div><div class="subtitle">Admin Panel 3</div></div></div>
                     <div class="card-body"><h2 class="counter" id="admin3-total-card">0</h2><div class="items">Units</div></div>
                 </article>
                 <article class="card">
                     <div class="card-header"><div class="card-icon" style="background-color: #9b59b6;"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 3v1.5M4.5 8.25H3m18 0h-1.5M4.5 12H3m18 0h-1.5m-15 3.75H3m18 0h-1.5M8.25 21v-1.5M15.75 3v1.5M12 4.5v-1.5m0 18v-1.5M5.636 5.636l1.06-1.06M5.636 18.364l1.06 1.06M18.364 5.636l-1.06-1.06M18.364 18.364l-1.06 1.06M12 12a6 6 0 110-12 6 6 0 010 12z" /></svg></div><div class="card-header-text"><div class="title">Total Robotics Items</div><div class="subtitle">Admin Panel 4</div></div></div>
                     <div class="card-body"><h2 class="counter" id="admin4-total-card">0</h2><div class="items">Units</div></div>
                 </article>
                 <article class="card">
                     <div class="card-header"><div class="card-icon icon-aqua"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 6.087c0-.355.186-.676.401-.959.215-.283.49-.522.799-.68a3.743 3.743 0 011.286-.294c.486-.01.97.086 1.424.275.454.19.868.45 1.226.774a3.732 3.732 0 01.96 1.226c.19.454.285.938.275 1.424a3.743 3.743 0 01-.294 1.286c-.158.309-.397.584-.68.799-.283.215-.604.401-.959.401a3.743 3.743 0 01-1.286.294c-.486.01-.97-.086-1.424-.275a3.732 3.732 0 01-1.226-.96c-.283-.454-.486-.97-.486-1.5z M4.5 12a7.5 7.5 0 0015 0h-15z" /></svg></div><div class="card-header-text"><div class="title">Total Science Items</div><div class="subtitle">Admin Panel 2</div></div></div>
                     <div class="card-body"><h2 class="counter" id="admin2-science-card">0</h2><div class="items">Units</div></div>
                 </article>
                 <article class="card">
                     <div class="card-header"><div class="card-icon" style="background-color: #e67e22;"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 4.5l7.5 7.5-7.5 7.5" /></svg></div><div class="card-header-text"><div class="title">Total Sports Items</div><div class="subtitle">Admin Panel 2</div></div></div>
                     <div class="card-body"><h2 class="counter" id="admin2-sports-card">0</h2><div class="items">Units</div></div>
                 </article>

            </section>
            <div class="chart-container">
                <div class="chart-card">
                    <h2>Inventory Overview</h2>
                    <canvas id="inventoryPieChart"></canvas>
                </div>
                <div class="chart-card">
                    <h2>Request Status Overview</h2>
                    <canvas id="requestStatusBarChart"></canvas>
                </div>
            </div>
        </div>

        <div id="live-scan-content" class="page-content">
            <h1>Live Scan Transaction</h1>
            <p class="page-subtitle">Process transactions and view real-time item status and history.</p>
            <div class="live-scan-container">
                <section class="inventory-card">
                    <h2>Transaction Processor</h2>
                    <div class="scan-controls">
                        <label for="scanMode">Mode:</label>
                        <select id="scanMode">
                            <option value="Borrowing" selected>Borrowing</option>
                            <option value="Returning">Returning</option>
                            <option value="Status Check">Status Check</option>
                            <option value="Equipment">Equipment Mode</option>
                        </select>
                        <div class="auto-submit-toggle">
                            <input type="checkbox" id="autoSubmitCheck" checked>
                            <label for="autoSubmitCheck">Auto-Submit</label>
                        </div>
                    </div>
                    <form id="scanForm">
                        <div class="form-group" id="studentIdPrefixGroup">
                            <label for="studentIdPrefixInput">Prefix/Suffix for Student ID</label>
                            <input type="text" id="studentIdPrefixInput" class="prefix-input" placeholder="">
                        </div>
                        <div class="form-group" id="studentIdGroup">
                            <label for="studentIdInput">1. Scan Student ID</label>
                            <input type="text" id="studentIdInput" class="scan-input" placeholder="Scan Student ID to Borrow..." autocomplete="off">
                        </div>
                        <div id="itemIdGroup" style="display: none;">
                            <div class="form-group" id="itemIdPrefixGroup">
                                <label for="itemIdPrefixInput">Prefix/Suffix for Item</label>
                                <input type="text" id="itemIdPrefixInput" class="prefix-input" placeholder="">
                            </div>
                            <div class="form-group">
                               <label for="itemIdInput">2. Scan Item Barcode</label>
                               <input type="text" id="itemIdInput" class="scan-input" placeholder="Scan Item to Borrow..." autocomplete="off">
                            </div>
                        </div>
                    </form>
                    <div id="scanStatus" class="status-box">
                        Awaiting scan...
                    </div>
                    
                    <div class="scan-action-buttons">
                        <button id="scanAnotherItemBtn" onclick="scanAnotherItem()">Scan Another Item</button>
                        <button id="cancelScanBtn" onclick="cancelTransaction()">Cancel Transaction</button>
                        <button id="updateStatusBtn" style="display: none;" onclick="updateEquipmentStatus()">Update Status</button>
                    </div>
                </section>
                <section class="inventory-card">
                    <h2>Live Tracking Details</h2>
                    <div id="trackingDetailsContainer">
                        <p>Scan an item to see its details here.</p>
                    </div>
                </section>
            </div>
        </div>
        <div id="super-admin-content" class="page-content">
            <h1>Super Admin Overview</h1>
            <p class="page-subtitle">Monitoring all inventories and requests across the system.</p>
            
            <section class="inventory-card">
                <h2>Science Inventory (Admin 2)</h2>
                <div class="filter-row" style="margin-bottom: 1rem;">
                    <div class="filter-select">
                        <label for="superAdmin2ScienceStatusFilter">Filter by Status</label>
                        <select id="superAdmin2ScienceStatusFilter">
                            <option value="All">All Statuses</option>
                            <option value="Available">Available</option>
                            <option value="In-Use">In-Use</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Damaged">Damaged</option>
                            <option value="Calibration">Calibration</option>
                        </select>
                    </div>
                </div>
                <table id="tableAdmin2ScienceInventory">
                    <thead><tr><th>ID</th><th>Name</th><th>Category</th><th>Qty</th><th>Location</th><th>Status</th></tr></thead>
                    <tbody></tbody>
                </table>
            </section>
            <section class="inventory-card">
                <h2>Sports Inventory (Admin 2)</h2>
                <div class="filter-row" style="margin-bottom: 1rem;">
                    <div class="filter-select">
                        <label for="superAdmin2SportsStatusFilter">Filter by Status</label>
                        <select id="superAdmin2SportsStatusFilter">
                            <option value="All">All Statuses</option>
                            <option value="Available">Available</option>
                            <option value="In-Use">In-Use</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Damaged">Damaged</option>
                            <option value="Calibration">Calibration</option>
                        </select>
                    </div>
                </div>
                <table id="tableAdmin2SportsInventory">
                    <thead><tr><th>ID</th><th>Name</th><th>Category</th><th>Qty</th><th>Location</th><th>Status</th></tr></thead>
                    <tbody></tbody>
                </table>
            </section>
            <section class="inventory-card">
                <h2>Facility Inventory (Admin 3) </h2>
                <div class="filter-row" style="margin-bottom: 1rem;">
                    <div class="filter-select">
                        <label for="superAdmin3StatusFilter">Filter by Status</label>
                        <select id="superAdmin3StatusFilter">
                            <option value="All">All Statuses</option>
                            <option value="Available">Available</option>
                            <option value="In-Use">In-Use</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Damaged">Damaged</option>
                            <option value="Calibration">Calibration</option>
                        </select>
                    </div>
                </div>
                <table id="tableAdmin3Inventory">
                    <thead><tr><th>ID</th><th>Name</th><th>Category</th><th>Qty</th><th>Location</th><th>Status</th></tr></thead>
                    <tbody></tbody>
                </table>
            </section>
            <section class="inventory-card">
                <h2>Robotics Inventory (Admin 4)</h2>
                <div class="filter-row" style="margin-bottom: 1rem;">
                    <div class="filter-select">
                        <label for="superAdmin4StatusFilter">Filter by Status</label>
                        <select id="superAdmin4StatusFilter">
                            <option value="All">All Statuses</option>
                            <option value="Available">Available</option>
                            <option value="In-Use">In-Use</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Damaged">Damaged</option>
                            <option value="Calibration">Calibration</option>
                        </select>
                    </div>
                </div>
                <table id="tableAdmin4Inventory">
                    <thead><tr><th>ID</th><th>Name</th><th>Category</th><th>Qty</th><th>Location</th><th>Status</th></tr></thead>
                    <tbody></tbody>
                </table>
            </section>
            
            <section class="inventory-card">
                <h2>All Monitored Requests</h2>
                <table id="tableAllMonitoredRequests">
                     <thead><tr><th>Student Name</th><th>Item Name</th><th>Category</th><th>Status</th><th>Request Date</th></tr></thead>
                     <tbody></tbody>
                </table>
            </section>
        </div>
        
        <div id="user-management-content" class="page-content">
            <h1>User Management</h1>
            <p class="page-subtitle">Create, view, and manage all user accounts in the system.</p>
            <section class="inventory-card">
                <h2>Add New User</h2>
                <form class="add-form" id="addUserForm">
                    <input type="text" name="firstName" placeholder="First Name" required />
                    <input type="text" name="lastName" placeholder="Last Name" required />
                    <input type="text" name="username" placeholder="Username" required />
                    <input type="email" name="email" placeholder="Email" required />
                    <input type="text" name="studentID" placeholder="Student/Employee ID" required />
                    <input type="password" name="password" placeholder="Password (for Admins)" />
                    <select name="role" required>
                        <option value="student">Student</option>
                        <option value="faculty">Faculty</option>
                    </select>
                    <button type="submit">Add User</button>
                </form>
            </section>
            <section class="inventory-card">
                <h2 id="usersTableTitle">All System Users</h2>
                <div class="filter-row">
                    <div class="search-bar">
                        <input type="text" id="searchUsers" placeholder="Search by name, ID, or email..." />
                    </div>
                    <button id="toggleUserArchiveBtn">View Archives</button>
                </div>
                <table id="usersTable">
                    <thead><tr><th>Full Name</th><th>Username</th><th>Student ID</th><th>Email</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </section>
        </div>
        <div id="profile-requests-content" class="page-content">
            <h1>Profile Update Requests</h1>
            <p class="page-subtitle">Review and process student requests to update their profile information.</p>
            <section class="inventory-card">
                <h2>Pending Requests</h2>
                <table id="profileRequestsTable">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Current Name</th>
                            <th>Requested Name</th>
                            <th>Requested Email</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="profileRequestsTableBody"></tbody>
                </table>
            </section>
        </div>

        <div id="registration-requests-content" class="page-content">
            <h1>New User Registration Requests</h1>
            <p class="page-subtitle">Approve or reject new student accounts waiting for activation.</p>
            <section class="inventory-card">
                <h2>Pending Registrations</h2>
                <table id="registrationRequestsTable">
                    <thead>
                        <tr>
                            <th>Full Name</th>
                            <th>Username</th>
                            <th>Student ID</th>
                            <th>Email</th>
                            <th>Registration Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="registrationRequestsTableBody"></tbody>
                </table>
            </section>
        </div>

        <div id="inventory-content" class="page-content">
            <h1>Manage Own Inventories</h1>

          <h2>Add New Science Equipment</h2>
                <form class="add-form" id="addFormScience">
                    <input type="text" name="itemIdPrefix" placeholder="Item ID Prefix (e.g., SCI)" required />
                    <input type="text" name="name" placeholder="Equipment Name" required />
                    <input type="hidden" name="category" value="Science" />
                    <input type="number" name="quantity" placeholder="Quantity" min="0" required />
                    <select name="location" required>
                        <option value="">Select Location</option>
                        <option value="ROOM 143">ROOM 143</option>
                    </select>
                    <button type="submit">Add Item</button>
                </form>
            </section>
            <section class="inventory-card">
                <h2 id="scienceTableTitle">Science Equipment</h2>
                <div class="filter-row">
                    <div class="search-bar">
                        <input type="text" id="searchScience" placeholder="Search science equipment..." />
                    </div>
                     <div class="filter-select">
                        <label for="inventoryStatusFilterScience">Status</label>
                        <select id="inventoryStatusFilterScience">
                            <option value="All">All Statuses</option>
                            <option value="Available">Available</option>
                            <option value="In-Use">In-Use</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Damaged">Damaged</option>
                            <option value="Calibration">Calibration</option>
                        </select>
                    </div>
                    <button id="toggleInventoryArchiveBtn">View Archives</button>
                </div>
                <div id="scienceInventoryContainer">
    <table id="tableScience">
        <thead>
            <tr><th>ID</th><th>Name</th><th>Category</th><th>Total Qty</th><th>Borrowed</th><th>Available</th><th>Location</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody>
             </tbody>
    </table>
</div>
            </section>

            <p class="page-subtitle" style="margin-top: 2.5rem; border-top: 1px solid var(--border-light); padding-top: 2.5rem;">Sports Equipment</p>
            <section class="inventory-card">
                <h2>Add New Sports Equipment</h2>
                <form class="add-form" id="addFormSports">
                  <input type="text" name="itemIdPrefix" placeholder="Item ID Prefix (e.g., SPO)" required />
                    <input type="text" name="name" placeholder="Equipment Name" required />
                    <input type="hidden" name="category" value="Sports" />
                    <input type="number" name="quantity" placeholder="Quantity" min="0" required />
                    <select name="location" required>
                        <option value="">Select Location</option>
                        <option value="ROOM 212">ROOM 212</option>
                    </select>
                    <button type="submit">Add Item</button>
                </form>
            </section>
            <section class="inventory-card">
                <h2 id="sportsTableTitle">Sports Equipment</h2>
                <div class="filter-row">
                    <div class="search-bar">
                        <input type="text" id="searchSports" placeholder="Search sports equipment..." />
                    </div>
                    <div class="filter-select">
                        <label for="inventoryStatusFilterSports">Status</label>
                        <select id="inventoryStatusFilterSports">
                            <option value="All">All Statuses</option>
                            <option value="Available">Available</option>
                            <option value="In-Use">In-Use</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Damaged">Damaged</option>
                            <option value="Calibration">Calibration</option>
                        </select>
                    </div>
                </div>
                <table id="tableSports">
                    <thead><tr><th>ID</th><th>Name</th><th>Category</th><th>Total Qty</th><th>Borrowed</th><th>Available</th><th>Location</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </section>
        </div>

        <div id="requests-content" class="page-content">
            <h1 id="requests-title">Manage Student Requests</h1>
            <p class="page-subtitle">Approve or reject pending equipment requests for Science & Sports.</p>
            <section class="inventory-card">
                     <div class="filter-row">
                         <div class="search-bar">
                             <input type="text" id="requestSearch" placeholder="Search by student, item name, or ID..." />
                         </div>
                         <div class="filter-select">
                             <label for="requestStatusFilter">Filter by Status</label>
                             <select id="requestStatusFilter">
                                 <option value="All">All Statuses</option>
                                 <option value="Pending">Pending</option>
                                 <option value="Approved">Approved</option>
                                 <option value="Rejected">Rejected</option>
                                 <option value="Returned">Returned</option>
                             </select>
                         </div>
                         <button id="toggleTrashViewBtn">View Trash</button>
                     </div>
                <table id="requestsTable">
                    <thead>
                        <tr>
                            <th>Student Name</th><th>Item ID</th><th>Item Name</th><th>Start Date</th><th>Due Date</th><th>Quantity</th><th>Reason</th><th>Status</th><th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="requestsTableBody"></tbody>
                </table>
            </section>
        </div>

        <div id="incident-reports-content" class="page-content">
            <h1>Student Reported Incidents (LF-05)</h1>
            <p class="page-subtitle">Review and resolve student-submitted incident reports.</p>
            <section class="inventory-card">
                <div class="filter-row">
                    <div class="search-bar">
                        <input type="text" id="incidentSearch" placeholder="Search by student name, ID, or item..." />
                    </div>
                    <div class="filter-select">
                        <label for="incidentStatusFilter">Filter by Status</label>
                        <select id="incidentStatusFilter">
                            <option value="All">All Statuses</option>
                            <option value="Pending Review">Pending Review</option>
                            <option value="Submitted">Submitted</option>
                            <option value="Resolved">Resolved</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </div>
                </div>
                <table id="incidentReportsTable">
                    <thead>
                        <tr>
                            <th>Student Name</th>
                            <th>Student ID</th>
                            <th>Item ID</th>
                            <th>Incident Type</th>
                            <th>Date of Incident</th>
                            <th>Date Submitted</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="incidentReportsTableBody"></tbody>
                </table>
            </section>
        </div>

        <div id="notifications-content" class="page-content">
            <h1>Notifications</h1>
            <p class="page-subtitle">Latest activities and alerts.</p>
            <div id="notification-list"></div>
        </div>
        
        <div id="history-content" class="page-content">
            <h1>Admin Action History</h1>
            <p class="page-subtitle">A log of all administrative actions performed in the system.</p>
             <section class="inventory-card">
                <div class="filter-row">
                    <div class="filter-select" style="min-width: 250px;">
                        <label for="historyActionFilter">Filter by Action</label>
                        <select id="historyActionFilter">
                            <option value="All">All Actions</option>
                        </select>
                    </div>
                </div>
                     <table id="historyTable">
                    <thead>
                        <tr>
                            <th>Admin</th>
                            <th>Action</th>
                            <th>Details</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </section>
        </div>

        <div id="reports-content" class="page-content">
            <h1>Generate Reports</h1>
            <p class="page-subtitle">View and print inventory, request, and user reports.</p>
            <section class="inventory-card">
              <label for="reportType">Select Report Type:</label>
              <select id="reportType" required style="padding:8px; border-radius:5px; border:1px solid var(--border-light); margin-bottom:1rem; width: 250px;">
                <option value="">Select Report Type</option>
                <option value="inventory">Inventory Report</option>
                <option value="requests">Requests Report</option>
                <option value="usage">Usage Report</option>
                <option value="registeredStudents">Registered Students Report</option>
                <option value="accountability">User Accountability</option>
              </select>
              <div id="inventoryCategoryGroup" style="display:none; margin-bottom:1rem;">
                <label for="inventoryCategory">Select Inventory Category:</label>
                <select id="inventoryCategory" class="inventory-category-select" style="padding:8px; border-radius:5px; border:1px solid var(--border-light); width: 250px; background-color: var(--card-bg-light); color: var(--text-dark);">
                  <option value="All">All Categories (Science & Sports)</option>
                  <option value="Science">Science Equipment</option>
                  <option value="Sports">Sports Equipment</option>
                </select>
              </div>
              <div style="margin-bottom:1rem;">
                <button id="dailyBtn" class="period-btn active">Daily</button>
                <button id="weeklyBtn" class="period-btn">Weekly</button>
                <button id="yearlyBtn" class="period-btn">Yearly</button>
              </div>
              <button id="generateReportBtn" style="background-color: var(--primary-dark); color: var(--accent-gold); padding: 10px 20px; border-radius: 5px; border:none; cursor:pointer; font-weight:600;">Generate Report</button>
            </section>
            <section class="inventory-card" id="reportResult" style="display:none; white-space: pre-wrap; font-family: monospace; font-size: 0.95rem;"></section>
            <button id="printReportBtn" style="display:none; background-color: var(--primary-dark); color: var(--accent-gold); padding: 10px 20px; border-radius: 5px; border:none; cursor:pointer; font-weight:600; margin-top: 1rem;">Print Report</button>
        </div>
    </main>

    <div id="bulkActionBar" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--primary-dark); padding: 10px 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: none; z-index: 999;">
    <span id="selectedCount" style="color: var(--accent-gold); font-weight: 600; margin-right: 20px;">0 Items Selected</span>
    <button class="btn btn-restore" onclick="bulkRestoreSelected()">Bulk Restore</button>
    <button class="btn btn-delete-permanent" onclick="bulkDeleteSelected()">Delete Permanently</button>
</div>
    
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="editModalTitle">Edit Item</h2>
                <span class="close-button">&times;</span>
            </div>
            <form id="editForm"></form>
        </div>
    </div>

    <div id="statusEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Request Status</h2>
                <span class="close-button">&times;</span>
            </div>
            <form id="statusEditForm">
                <input type="hidden" id="statusRequestId">
                <label for="statusSelect">Status</label>
                <select id="statusSelect" required>
                    <option value="Pending">Pending</option>
                    <option value="Approved">Approved</option>
                    <option value="Rejected">Rejected</option>
                    <option value="Returned">Returned</option>
                </select>
                <button type="submit">Update Status</button>
            </form>
        </div>
    </div>

    <!-- Resolve Incident Modal -->
    <div id="resolveIncidentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Resolve Incident</h2>
                <span class="close-button" onclick="closeResolveModal()">&times;</span>
            </div>
            <form id="resolveIncidentForm">
                <input type="hidden" id="resolve-report-id" />
                <div class="form-group">
                    <label>Student:</label>
                    <input type="text" id="resolve-student-name" readonly style="background-color: #f3f4f6;" />
                </div>
                <div class="form-group">
                    <label>Item:</label>
                    <input type="text" id="resolve-item-name" readonly style="background-color: #f3f4f6;" />
                </div>
                <div class="form-group">
                    <label for="resolve-replacement-item">New Replacement Item ID:</label>
                    <input type="text" id="resolve-replacement-item" required />
                </div>
                <div class="form-group">
                    <label for="resolve-notes">Resolution Note:</label>
                    <textarea id="resolve-notes" rows="4" required></textarea>
                </div>
                <div class="form-actions" style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-cancel" onclick="closeResolveModal()">Cancel</button>
                    <button type="submit" class="btn btn-request">Resolve Incident</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reject Incident Modal -->
    <div id="rejectIncidentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Reject Incident</h2>
                <span class="close-button" onclick="closeRejectModal()">&times;</span>
            </div>
            <form id="rejectIncidentForm">
                <input type="hidden" id="reject-report-id" />
                <div class="form-group">
                    <label>Student:</label>
                    <input type="text" id="reject-student-name" readonly style="background-color: #f3f4f6;" />
                </div>
                <div class="form-group">
                    <label>Item:</label>
                    <input type="text" id="reject-item-name" readonly style="background-color: #f3f4f6;" />
                </div>
                <div class="form-group">
                    <label for="reject-notes">Rejection Reason:</label>
                    <textarea id="reject-notes" rows="4" placeholder="Enter reason for rejection (optional)"></textarea>
                </div>
                <div class="form-actions" style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-cancel" onclick="closeRejectModal()">Cancel</button>
                    <button type="submit" class="btn btn-delete">Reject Incident</button>
                </div>
            </form>
        </div>
    </div>

    <div id="returnConditionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Return Condition Report </h2>
                <span class="close-button" id="closeReturnConditionModal">&times;</span>
            </div>
            <form id="returnConditionForm">
                <input type="hidden" id="returnConditionItemId">
                <input type="hidden" id="returnConditionBorrowerName">

                <p style="margin-bottom: 1rem;">**Item:** <span id="modalItemName" style="font-weight: 600;"></span></p>
                <p style="margin-bottom: 1.5rem;">**Borrowed By:** <span id="modalBorrowerName" style="font-weight: 600;"></span></p>

                <label for="conditionSelect">Select Return Condition</label>
                <select id="conditionSelect" required style="margin-bottom: 1rem;">
                    <option value="Good" selected>1 - Good Condition </option>
                    <option value="Damaged">2 - Damaged </option>
                    <option value="Lost">3 - Lost </option>
                </select>

                <label for="damageNotes" id="damageNotesLabel" style="display: none;">Notes on Damage/Loss (Required)</label>
                <textarea id="damageNotes" placeholder="Enter details about the damage, or confirm the item is lost." style="display: none; height: 80px;"></textarea>

                <button type="submit" id="submitConditionBtn">Submit Return</button>
            </form>
        </div>
    </div>

    <!-- View Request Details Modal -->
    <div id="viewRequestDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Request Details</h2>
                <span class="close-button" id="closeViewRequestDetailsModal">&times;</span>
            </div>
            <div id="viewRequestDetailsContent" style="padding: 1rem 0;">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div style="margin-top: 1.5rem; text-align: right;">
                <button class="btn" style="background-color: var(--primary-dark); color: white;" onclick="closeViewRequestDetailsModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

     <script>

        // --- NEW FUNCTIONS FOR HEADER BUTTONS ---

// Handles clicks on "Archive All" button in the ACTIVE inventory view
window.archiveInventoryModel = (itemId, groupName, type) => {
    if (!confirm(`Are you sure you want to archive ALL units of the model '${groupName}'? This action can be undone by restoring from the Archive View.`)) return;
    
    // We rely on the core single-item archive logic, but would require server-side changes
    // to archive all items by model name. For now, we will perform the single item archive
    // as a symbolic gesture until the server is updated for bulk operations.
    
    // To make it functional on the client, we will fetch the list and archive them one by one.
    // NOTE: This approach is INEFFICIENT but ensures the button does *something*
    const config = inventoryTypes[type];
    const itemsToArchive = config.store.filter(i => i.name === groupName).map(i => i.itemId);

    if (itemsToArchive.length > 0) {
        let archivedCount = 0;
        itemsToArchive.forEach(unitId => {
             // In a real setup, a bulk API call should happen here.
             archiveInventoryItem(type, unitId); // Calling the single archive function
             archivedCount++;
        });
        showToast(`Attempting to archive ${archivedCount} units of ${groupName}... Please refresh/wait.`, 'warning');
        setTimeout(() => fetchInventory(type), 1500);
    }
};

// Handles clicks on the "Delete Permanently" button in the ARCHIVE view
window.deleteInventoryModelPermanently = async (itemId, groupName, type) => {
    if (!confirm(`WARNING: This will permanently delete ALL units of model '${groupName}' and all related history! Are you absolutely sure?`)) return;
    
    const config = inventoryTypes[type];
    const itemsToDelete = config.store.filter(i => i.name === groupName).map(i => i.itemId);
    
    if (itemsToDelete.length > 0) {
        let deletedCount = 0;
        for (const unitId of itemsToDelete) {
             const res = await fetch(`/api/inventory/permanent/${unitId}`, { method: 'DELETE' });
             if (res.ok) {
                 deletedCount++;
             }
        }
        showToast(`Successfully permanently deleted ${deletedCount} units of ${groupName}.`, 'success');
        fetchArchivedInventory(); // Refresh the archive view
    }
};
    // --- Helper Function for Sequential ID Generation (NEWLY ADDED) ---
    function findNextSequenceId(prefix, items) {
        let maxNum = 0;
        // Normalize prefix to uppercase for consistent comparison
        const normalizedPrefix = String(prefix).toUpperCase().trim();
        // Escape special regex characters in prefix
        const escapedPrefix = normalizedPrefix.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        // Regex to match the prefix followed by a hyphen and digits, case insensitive
        const prefixPattern = new RegExp(`^${escapedPrefix}-(\\d+)$`, 'i');

        items.forEach(item => {
            const match = item.itemId.match(prefixPattern);
            if (match) {
                const num = parseInt(match[1]);
                if (!isNaN(num) && num > maxNum) {
                    maxNum = num;
                }
            }
        });
        // Start the next sequence one step higher than the maximum found
        return maxNum + 1;
    }

    // ADD THESE FUNCTIONS TO THE VERY TOP OF YOUR <script> BLOCK (Global Scope)

// --- NEW/MODIFIED GLOBAL HELPER FUNCTIONS ---

let selectedArchivedItems = [];

// --- Add this helper function definition as well ---
function updateMasterAndBulkActionUI() {
    // Note: You must ensure renderBulkActionBar() is defined in the window scope
    renderBulkActionBar();
    
    const allUnits = document.querySelectorAll('.inventory-item-detail input[type="checkbox"]');
    const masterCheckbox = document.getElementById('checkAllUnits');
    
    if (masterCheckbox) {
        // If every single checkbox is checked, check the master box
        masterCheckbox.checked = allUnits.length > 0 && selectedArchivedItems.length === allUnits.length;
    }
}
// --- NEW/MODIFIED GLOBAL BULK ACTION FUNCTIONS ---

// ADD THESE GLOBAL FUNCTIONS TO THE VERY TOP OF YOUR <script> BLOCK

// --- NEW/MODIFIED GLOBAL BULK ACTION FUNCTIONS ---

window.bulkRestoreSelected = async () => {
    if (selectedArchivedItems.length === 0) return window.showToast('No items selected.', 'warning');
    if (!confirm(`Are you sure you want to RESTORE ${selectedArchivedItems.length} item(s)?`)) return;

    try {
        let successfulRestores = 0;
        for (const itemId of selectedArchivedItems) {
            const res = await fetch(`/api/inventory/restore/${itemId}`, { method: 'PUT' });
            if (res.ok) {
                successfulRestores++;
            }
        }
        window.showToast(`Successfully restored ${successfulRestores} item(s).`, 'success');
        // Assuming fetchArchivedInventory is globally defined
        window.fetchArchivedInventory(); 
    } catch (error) {
        window.showToast('Error during bulk restore. Check console.', 'error');
    }
};

window.bulkDeleteSelected = async () => {
    if (selectedArchivedItems.length === 0) return window.showToast('No items selected.', 'warning');
    if (!confirm(`WARNING: This will permanently DELETE ${selectedArchivedItems.length} item(s) and all their history. Are you absolutely sure?`)) return;

    try {
        let successfulDeletes = 0;
        for (const itemId of selectedArchivedItems) {
            const res = await fetch(`/api/inventory/permanent/${itemId}`, { method: 'DELETE' });
            if (res.ok) {
                successfulDeletes++;
            }
        }
        window.showToast(`Successfully permanently deleted ${successfulDeletes} item(s).`, 'success');
        window.fetchArchivedInventory(); 
    } catch (error) {
        window.showToast('Error during bulk deletion. Check console.', 'error');
    }
};

window.bulkArchiveSelected = async () => {
    if (selectedArchivedItems.length === 0) return window.showToast('No items selected.', 'warning');
    if (!confirm(`Are you sure you want to ARCHIVE ${selectedArchivedItems.length} item(s)? They will be moved to the Archive View.`)) return;

    try {
        let successfulArchives = 0;
        const firstItemId = selectedArchivedItems[0];
        let targetType = '';
        
        // Find the inventory type based on the first selected item
        for (const type in inventoryTypes) {
            if (inventoryTypes[type].store.some(i => i.itemId === firstItemId)) {
                targetType = type;
                break;
            }
        }
        
        if (!targetType) return window.showToast('Error: Could not determine item category for bulk archive.', 'error');
        
        for (const itemId of selectedArchivedItems) {
            const response = await fetch(`${inventoryTypes[targetType].api}/${itemId}`, { method: 'DELETE' });
            if (response.ok) {
                successfulArchives++;
            }
        }
        
        window.showToast(`Successfully archived ${successfulArchives} item(s).`, 'success');
        window.fetchInventory(targetType); 
    } catch (error) {
        window.showToast('Error during bulk archiving. Check console.', 'error');
    }
};

// This helper must also be global
function updateMasterAndBulkActionUI() {
    // Note: renderBulkActionBar is defined inside the DOMContentLoaded block
    // Assuming you have defined window.renderBulkActionBar = () => { ... } 
    // to be accessible globally.
    window.renderBulkActionBar();
    
    const allUnits = document.querySelectorAll('.inventory-item-detail input[type="checkbox"]');
    const masterCheckbox = document.getElementById('checkAllUnits');
    
    if (masterCheckbox) {
        masterCheckbox.checked = allUnits.length > 0 && selectedArchivedItems.length === allUnits.length;
    }
}

// --- END ADDED GLOBAL FUNCTIONS ---

    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. CONFIGURATION & STATE ---
        const apiBaseUrl = 'http://localhost:3000';
        const originalFetch = window.fetch.bind(window);
        window.fetch = (input, init) => {
            if (typeof input === 'string' && input.startsWith('/')) {
                return originalFetch(`${apiBaseUrl}${input}`, init);
            }
            if (input && typeof input === 'object' && 'url' in input && input.url.startsWith('/')) {
                const clonedRequest = new Request(`${apiBaseUrl}${input.url}`, input);
                return originalFetch(clonedRequest, init);
            }
            return originalFetch(input, init);
        };

        const inventoryTypes = {
            Science: {
                api: '/api/inventory2', store: [], tableBody: document.querySelector('#tableScience tbody'),
                searchInput: document.getElementById('searchScience'), addForm: document.getElementById('addFormScience'),
                statusFilter: document.getElementById('inventoryStatusFilterScience')
            },
            Sports: {
                api: '/api/inventory3', store: [], tableBody: document.querySelector('#tableSports tbody'),
                searchInput: document.getElementById('searchSports'), addForm: document.getElementById('addFormSports'),
                statusFilter: document.getElementById('inventoryStatusFilterSports')
            }
        };
           
        // --- MODIFIED: Removed allIncidentsData ---
        let allRequestsData = [], allUsersData = [], allHistoryLogs = [], notifications = [];
        let isViewingTrash = false;
        let isViewingUserArchive = false;
        let isViewingInventoryArchive = false;
        // Super Admin inventory data storage
        let superAdmin2ScienceData = [];
        let superAdmin2SportsData = [];
        let superAdmin3InventoryData = [];
        let superAdmin4InventoryData = [];
        let inventoryPieChartInstance = null;
        let requestStatusBarChartInstance = null;
        selectedArchivedItems = [];

        const body = document.body;
        const logoutLink = document.querySelector('.logout-link');
        if (logoutLink) {
            logoutLink.addEventListener('click', (event) => {
                event.preventDefault();
                window.location.href = `${apiBaseUrl}/logout`;
            });
        }
        const editModal = document.getElementById('editModal');
        const statusEditModal = document.getElementById('statusEditModal');
        const editForm = document.getElementById('editForm');
        const requestsTableBody = document.getElementById('requestsTableBody');
        const notificationList = document.getElementById('notification-list');
        const notificationBadge = document.getElementById('notification-badge');
        const requestSearch = document.getElementById('requestSearch');
        const requestStatusFilter = document.getElementById('requestStatusFilter');
        const toggleTrashViewBtn = document.getElementById('toggleTrashViewBtn');
        const requestsTitle = document.getElementById('requests-title');
        const logo = document.querySelector('.logo img');

        // --- LIVE SCAN (MODIFIED) ---
        const scanForm = document.getElementById('scanForm');
        const scanMode = document.getElementById('scanMode');
        const scanStatus = document.getElementById('scanStatus');
        const trackingDetailsContainer = document.getElementById('trackingDetailsContainer');
           
        const autoSubmitCheck = document.getElementById('autoSubmitCheck');
        const studentIdPrefixInput = document.getElementById('studentIdPrefixInput');
        const studentIdInput = document.getElementById('studentIdInput');
        const itemIdPrefixInput = document.getElementById('itemIdPrefixInput');
        const itemIdInput = document.getElementById('itemIdInput');
           
        const studentIdPrefixGroup = document.getElementById('studentIdPrefixGroup');
        const studentIdGroup = document.getElementById('studentIdGroup');
        const itemIdGroup = document.getElementById('itemIdGroup');
        let currentBorrowingStudentId = null;
        let scanDebounceTimer = null;
        let scannedEquipmentId = null; // --- ADDED (from admin4) ---
           
        // --- MODIFIED: Added updateStatusBtn selector ---
        const scanAnotherItemBtn = document.getElementById('scanAnotherItemBtn');
        const cancelScanBtn = document.getElementById('cancelScanBtn');
        const updateStatusBtn = document.getElementById('updateStatusBtn'); // --- ADDED (from admin4) ---

        // User Management Elements
        const addUserForm = document.getElementById('addUserForm');
        const usersTableBody = document.getElementById('usersTableBody');
        const searchUsersInput = document.getElementById('searchUsers');
        const toggleUserArchiveBtn = document.getElementById('toggleUserArchiveBtn');
        const usersTableTitle = document.getElementById('usersTableTitle');

        // Inventory Archive Elements
        const toggleInventoryArchiveBtn = document.getElementById('toggleInventoryArchiveBtn');
        const scienceTableTitle = document.getElementById('scienceTableTitle');
        const sportsTableTitle = document.getElementById('sportsTableTitle');

        // --- REMOVED: Incident Elements ---

        // History Filter
        const historyActionFilter = document.getElementById('historyActionFilter');
           
        // --- 2. INITIALIZATION ---
        function initializeApp() {
            setupEventListeners();
            // Initialize dashboard page after a small delay to ensure showPage is defined
            setTimeout(() => {
                if (typeof window.showPage === 'function') {
                    window.showPage('dashboard');
                }
            }, 10);
            fetchAdminNotifications();
        }

        // --- ADDED: Auto-submit handlers from admin_panel3.html ---
        const handleAutoSubmit = (event) => {
            clearTimeout(scanDebounceTimer);
            if (autoSubmitCheck.checked) {
                scanDebounceTimer = setTimeout(() => {
                          if (event.target.value.trim() !== '') {
                                      processScan(event.target);
                                    }
                }, 100);
            }
        };
        const disableAutoSubmit = () => {
            itemIdInput.removeEventListener('input', handleAutoSubmit);
            studentIdInput.removeEventListener('input', handleAutoSubmit);
        };
        const enableAutoSubmit = () => {
            itemIdInput.addEventListener('input', handleAutoSubmit);
            studentIdInput.addEventListener('input', handleAutoSubmit);
        };

        // --- MODIFIED: setupEventListeners ---
        function setupEventListeners() {
            document.querySelector(".toggle-btn").addEventListener("click", () => body.classList.toggle("sidebar-collapsed"));
                 
            const darkToggle = document.querySelector(".dark-toggle");
            darkToggle.addEventListener("click", () => {
                body.classList.toggle("dark");
                const isDarkMode = body.classList.contains("dark");
                localStorage.setItem("dark-mode", isDarkMode);
                darkToggle.querySelector('.sun-icon').style.display = isDarkMode ? 'none' : 'block';
                darkToggle.querySelector('.moon-icon').style.display = isDarkMode ? 'block' : 'none';
                if(document.getElementById('dashboard-content').classList.contains('active')) {
                    updateSuperAdminDashboard();
                }
            });
                 
            if (localStorage.getItem("dark-mode") === "true") {
                body.classList.add("dark");
                darkToggle.querySelector('.sun-icon').style.display = 'none';
                darkToggle.querySelector('.moon-icon').style.display = 'block';
            }

            // Sidebar navigation - use event delegation
            const sidebarNav = document.querySelector("#sidebar nav");
            if (sidebarNav) {
                sidebarNav.addEventListener('click', (e) => {
                    const link = e.target.closest('a[data-page]');
                    if (link) {
                        e.preventDefault();
                        e.stopPropagation();
                        const pageId = link.getAttribute('data-page');
                        if (pageId && typeof window.showPage === 'function') {
                            window.showPage(pageId);
                        }
                    }
                }, true); // Use capture phase to ensure it fires
            }
            
            // Also add direct event listeners as backup
            document.querySelectorAll("#sidebar nav a[data-page]").forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const pageId = link.getAttribute('data-page');
                    if (pageId && typeof window.showPage === 'function') {
                        window.showPage(pageId);
                    }
                }, true); // Use capture phase
            });

            // --- MODIFIED: Live scan click listener (from admin3) ---
            const mainContentArea = document.querySelector('main');
            mainContentArea.addEventListener('click', (event) => {
                const liveScanPage = document.getElementById('live-scan-content');
                if (liveScanPage.classList.contains('active') && !event.target.closest('.live-scan-container form, .live-scan-container select, .scan-action-buttons')) {
                    if (itemIdGroup.style.display !== 'none') {
                        itemIdPrefixInput.focus();
                    }
                    else if (studentIdGroup.style.display !== 'none') {
                        studentIdPrefixInput.focus();
                    }
                }
            });


            for (const type in inventoryTypes) {
                inventoryTypes[type].addForm.addEventListener('submit', (e) => handleAddItem(e, type));
                inventoryTypes[type].searchInput.addEventListener('input', () => renderTable(type));
                inventoryTypes[type].statusFilter.addEventListener('change', () => renderTable(type));
            }

            logo.addEventListener('click', () => showPage('dashboard'));

            // Requests Tab Listeners
            requestSearch.addEventListener('input', renderRequestsTable);
            requestStatusFilter.addEventListener('change', renderRequestsTable);
            toggleTrashViewBtn.addEventListener('click', toggleRequestView);

            // History Filter Listener
            historyActionFilter.addEventListener('change', renderHistoryLogs);

            // User Management Listeners
            addUserForm.addEventListener('submit', handleCreateUser);
            searchUsersInput.addEventListener('input', renderUsersTable);
            toggleUserArchiveBtn.addEventListener('click', toggleUserArchiveView);

            // Inventory Archive Listener
            toggleInventoryArchiveBtn.addEventListener('click', toggleInventoryArchiveView);

            editForm.addEventListener('submit', handleUpdateItem);
            editModal.querySelector('.close-button').onclick = () => editModal.style.display = 'none';
            statusEditModal.querySelector('.close-button').onclick = () => statusEditModal.style.display = 'none';
                            
            document.getElementById('closeReturnConditionModal').onclick = () => document.getElementById('returnConditionModal').style.display = 'none';
            document.getElementById('closeViewRequestDetailsModal').onclick = () => closeViewRequestDetailsModal();
                 
            // --- REMOVED: Incident Modal Listeners ---


            window.addEventListener('click', (event) => { 
                if (event.target == editModal) editModal.style.display = 'none'; 
                if (event.target == statusEditModal) statusEditModal.style.display = 'none';
                if (event.target == document.getElementById('returnConditionModal')) document.getElementById('returnConditionModal').style.display = 'none';
                if (event.target == document.getElementById('viewRequestDetailsModal')) closeViewRequestDetailsModal();
                // --- REMOVED: Incident modal window click ---
            });
                 
            document.getElementById('statusEditForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const requestId = document.getElementById('statusRequestId').value;
                const newStatus = document.getElementById('statusSelect').value;
                handleRequest(requestId, newStatus); // --- MODIFIED (simplified) ---
                statusEditModal.style.display = 'none';
            });

            // --- LIVE SCAN Event Listeners (REPLACED) ---
            scanMode.addEventListener('change', resetScannerUI);

            scanForm.addEventListener('submit', (e) => {
                e.preventDefault();
                processScan(document.activeElement);
            });

            // --- MODIFIED: Use the new auto-submit handlers ---
            enableAutoSubmit();
                 
            // --- ADDED: Listeners for new scan buttons ---
            scanAnotherItemBtn.addEventListener('click', scanAnotherItem);
            cancelScanBtn.addEventListener('click', cancelTransaction);
            updateStatusBtn.addEventListener('click', updateEquipmentStatus); // --- ADDED ---

            // --- ADDED: Event Listeners for Return Condition Modal ---
            document.getElementById('returnConditionForm').addEventListener('submit', window.handleReturnConditionSubmission);
                 
            document.getElementById('conditionSelect').addEventListener('change', (e) => {
                const notesLabel = document.getElementById('damageNotesLabel');
                const notesTextarea = document.getElementById('damageNotes');
                if (['Damaged', 'Lost'].includes(e.target.value)) {
                    notesLabel.style.display = 'block';
                    notesTextarea.style.display = 'block';
                    notesTextarea.required = true;
                } else {
                    notesLabel.style.display = 'none';
                    notesTextarea.style.display = 'none';
                    notesTextarea.required = false;
                }
            });
            
            // --- ADDED: Super Admin Inventory Filter Listeners ---
            const superAdmin2ScienceFilter = document.getElementById('superAdmin2ScienceStatusFilter');
            const superAdmin2SportsFilter = document.getElementById('superAdmin2SportsStatusFilter');
            const superAdmin3Filter = document.getElementById('superAdmin3StatusFilter');
            const superAdmin4Filter = document.getElementById('superAdmin4StatusFilter');
            
            if (superAdmin2ScienceFilter) {
                superAdmin2ScienceFilter.addEventListener('change', () => {
                    const filterValue = superAdmin2ScienceFilter.value;
                    renderSuperAdminInventoryTable(
                        superAdmin2ScienceData, 
                        document.getElementById('tableAdmin2ScienceInventory').querySelector('tbody'),
                        filterValue
                    );
                });
            }
            
            if (superAdmin2SportsFilter) {
                superAdmin2SportsFilter.addEventListener('change', () => {
                    const filterValue = superAdmin2SportsFilter.value;
                    renderSuperAdminInventoryTable(
                        superAdmin2SportsData, 
                        document.getElementById('tableAdmin2SportsInventory').querySelector('tbody'),
                        filterValue
                    );
                });
            }
            
            if (superAdmin3Filter) {
                superAdmin3Filter.addEventListener('change', () => {
                    const filterValue = superAdmin3Filter.value;
                    renderSuperAdminInventoryTable(
                        superAdmin3InventoryData, 
                        document.getElementById('tableAdmin3Inventory').querySelector('tbody'),
                        filterValue
                    );
                });
            }
            
            if (superAdmin4Filter) {
                superAdmin4Filter.addEventListener('change', () => {
                    const filterValue = superAdmin4Filter.value;
                    renderSuperAdminInventoryTable(
                        superAdmin4InventoryData, 
                        document.getElementById('tableAdmin4Inventory').querySelector('tbody'),
                        filterValue
                    );
                });
            }
        }
              
        // --- 3. PAGE NAVIGATION & CONTENT LOADING (MODIFIED) ---
        window.showPage = function(pageId) {
            if (!pageId) {
                return;
            }
            
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(p => {
                p.classList.remove('active');
            });
            
            // Show the selected page
            const page = document.getElementById(`${pageId}-content`);
            if (page) {
                page.classList.add('active');
            }
            
            // Update active state in sidebar
            document.querySelectorAll("#sidebar nav a[data-page]").forEach(l => {
                l.classList.toggle('active', l.dataset.page === pageId);
            });

            if (pageId === 'dashboard') {
                updateSuperAdminDashboard();
            } else if (pageId === 'inventory') {
                isViewingInventoryArchive = false;
                // --- ADDED: Reset inventory view ---
                inventoryTypes.Science.statusFilter.style.display = 'block';
                inventoryTypes.Sports.statusFilter.style.display = 'block';
                document.getElementById('scienceTableTitle').textContent = 'Science Equipment';
                document.getElementById('sportsTableTitle').textContent = 'Sports Equipment';
                toggleInventoryArchiveBtn.textContent = 'View Archives';
                for (const type in inventoryTypes) fetchInventory(type);
            } else if (pageId === 'requests') {
                isViewingTrash = false;
                fetchAllRequests();
            } else if (pageId === 'notifications') {
                renderNotifications();
            } else if (pageId === 'history') {
                fetchHistoryLogs();
            } else if (pageId === 'super-admin') {
                loadSuperAdminData();
            } else if (pageId === 'user-management') {
                isViewingUserArchive = false; // User archive is not supported by server.js
                fetchAllUsers();
            } else if (pageId === 'profile-requests') {
                fetchProfileUpdateRequests();
            } else if (pageId === 'registration-requests') {
                fetchPendingRegistrations();
            } else if (pageId === 'incident-reports') {
                fetchIncidentReports();
            } else if (pageId === 'live-scan') { // --- REMOVED: 'incidents' else if ---
                initializeLiveScan();
            }
        };

        // --- 4. DASHBOARD & CHARTS ---
        async function updateSuperAdminDashboard() {
            try {
                const [
                    admin2InvRes,
                    admin3InvRes,
                    admin4InvRes,
                    admin2ReqRes,
                    admin3ReqRes,
                    admin4ReqRes
                ] = await Promise.all([
                    Promise.all([fetch('/api/inventory2'), fetch('/api/inventory3')]),
                    Promise.all([fetch('/api/inventory4'), fetch('/api/inventory5'), fetch('/api/inventory6'), fetch('/api/inventory8')]),
                    fetch('/api/inventory7'),
                    fetch('/api/admin2-requests'),
                    fetch('/api/admin3-requests'),
                    fetch('/api/admin-requests/Robotics')
                ]);

                const admin2InventoriesJson = await Promise.all(admin2InvRes.map(res => res.json()));
                const admin2Inventories = [].concat(...admin2InventoriesJson);
                const admin3InventoriesJson = await Promise.all(admin3InvRes.map(res => res.json()));
                const admin3Inventories = [].concat(...admin3InventoriesJson);
                const admin4Inventories = await admin4InvRes.json();
                     
                const admin2ScienceTotal = admin2Inventories.filter(i => i.category === 'Science').reduce((sum, item) => sum + (item.originalQuantity || 0), 0);
                const admin2SportsTotal = admin2Inventories.filter(i => i.category === 'Sports').reduce((sum, item) => sum + (item.originalQuantity || 0), 0);
                const admin3Total = admin3Inventories.reduce((sum, item) => sum + (item.originalQuantity || 0), 0);
                const admin4Total = admin4Inventories.reduce((sum, item) => sum + (item.originalQuantity || 0), 0);

                document.getElementById('admin2-science-card').setAttribute('data-target', admin2ScienceTotal);
                document.getElementById('admin2-sports-card').setAttribute('data-target', admin2SportsTotal);
                document.getElementById('admin3-total-card').setAttribute('data-target', admin3Total);
                document.getElementById('admin4-total-card').setAttribute('data-target', admin4Total);
                animateCounters();
                     
                const allMonitoredInventories = [...admin2Inventories, ...admin3Inventories, ...admin4Inventories];
                renderInventoryPieChart(allMonitoredInventories);
                     
                const allMonitoredRequests = [
                    ...(await admin2ReqRes.json()),
                    ...(await admin3ReqRes.json()),
                    ...(await admin4ReqRes.json())
                ];
                renderRequestStatusBarChart(allMonitoredRequests);

            } catch (error) {
                console.error("Super Admin Dashboard Error:", error);
                showToast("Error loading monitoring data.");
            }
        }

        function animateCounters() {
            document.querySelectorAll(".counter").forEach(counter => {
                counter.innerText = '0';
                const update = () => {
                    const target = +counter.getAttribute("data-target") || 0;
                    const count = +counter.innerText;
                    const increment = Math.max(1, Math.ceil((target - count) / 10));
                    if (count < target) {
                        counter.innerText = `${Math.min(target, count + increment)}`;
                        setTimeout(update, 40);
                    } else { counter.innerText = target; }
                };
                update();
            });
        }
             
        function renderInventoryPieChart(inventories) {
            const ctx = document.getElementById('inventoryPieChart').getContext('2d');
            if (inventoryPieChartInstance) inventoryPieChartInstance.destroy();

            const categoryTotals = inventories.reduce((acc, item) => {
                acc[item.category] = (acc[item.category] || 0) + (item.originalQuantity || 0);
                return acc;
            }, {});

            inventoryPieChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryTotals),
                    datasets: [{
                        label: 'Total Items',
                        data: Object.values(categoryTotals),
                        backgroundColor: ['#3498db', '#9b59b6', '#f1c40f', '#e74c3c', '#2ecc71', '#34495e', '#1abc9c', '#e67e22'],
                        borderColor: body.classList.contains('dark') ? 'var(--card-bg-dark)' : 'var(--card-bg-light)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: body.classList.contains('dark') ? 'var(--text-light)' : 'var(--text-dark)'
                            }
                        }
                    }
                }
            });
        }

        function renderRequestStatusBarChart(requests) {
            const ctx = document.getElementById('requestStatusBarChart').getContext('2d');
            if (requestStatusBarChartInstance) requestStatusBarChartInstance.destroy();

            const statusCounts = requests.reduce((acc, req) => {
                acc[req.status] = (acc[req.status] || 0) + 1;
                return acc;
            }, {});

            const labels = ['Pending', 'Approved', 'Rejected', 'Returned'];
            const data = labels.map(label => statusCounts[label] || 0);
            const textColor = body.classList.contains('dark') ? 'var(--text-light)' : 'var(--text-dark)';

            requestStatusBarChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Requests',
                        data: data,
                        backgroundColor: ['rgba(240, 173, 78, 0.8)', 'rgba(40, 167, 69, 0.8)', 'rgba(220, 53, 69, 0.8)', 'rgba(108, 117, 125, 0.8)'],
                        borderColor: ['#f0ad4e', '#28a745', '#dc3545', '#6c757d'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1, color: textColor }
                        },
                        x: {
                            ticks: { color: textColor }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- 5. LIVE SCAN FUNCTIONS (REPLACED/ADDED from admin4) ---
        function initializeLiveScan() {
            resetScannerUI();
        }
             
        function clearTrackingDetails() {
            trackingDetailsContainer.innerHTML = '<p>Scan an item to see its details here.</p>';
        }

        function resetScannerUI() {
            currentBorrowingStudentId = null;
            scannedEquipmentId = null;
            studentIdInput.value = '';
            itemIdInput.value = '';
            studentIdPrefixInput.value = '';
            itemIdPrefixInput.value = '';
            studentIdInput.readOnly = false;
                 
            scanStatus.textContent = 'Awaiting scan...';
            scanStatus.className = 'status-box';
                 
            scanAnotherItemBtn.style.display = 'none';
            cancelScanBtn.style.display = 'none';
            updateStatusBtn.style.display = 'none'; // --- ADDED ---

            const mode = scanMode.value;

            // Hide all groups by default
            studentIdPrefixGroup.style.display = 'none';
            studentIdGroup.style.display = 'none';
            itemIdGroup.style.display = 'none';

            if (mode === 'Borrowing') {
                studentIdPrefixGroup.style.display = 'block';
                studentIdGroup.style.display = 'block';
                itemIdGroup.style.display = 'none';
                studentIdInput.placeholder = 'Scan student ID to BORROW...';
                studentIdPrefixInput.focus();
            } else if (mode === 'Returning' || mode === 'Status Check' || mode === 'Equipment') {
                studentIdPrefixGroup.style.display = 'none';
                studentIdGroup.style.display = 'none';
                itemIdGroup.style.display = 'block';
                if (mode === 'Returning') { itemIdInput.placeholder = 'Scan item to RETURN...'; }
                else if (mode === 'Status Check') { itemIdInput.placeholder = 'Scan item for STATUS CHECK...'; }
                else if (mode === 'Equipment') { itemIdInput.placeholder = 'Scan item to change status...'; }
                itemIdPrefixInput.focus();
            }
                 
            clearTrackingDetails();
        }

        window.scanAnotherItem = () => {
            const mode = scanMode.value;
            if (mode === 'Borrowing' && currentBorrowingStudentId) {
                itemIdInput.value = '';
                itemIdPrefixInput.value = '';
                scanStatus.textContent = `Student ID **${currentBorrowingStudentId}** captured. Scan next item.`;
                scanStatus.className = 'status-box info';
                scanAnotherItemBtn.style.display = 'none';
                cancelScanBtn.style.display = 'inline-block';
                itemIdPrefixInput.focus();
            } else if (mode === 'Equipment' || mode === 'Returning' || mode === 'Status Check') {
                scannedEquipmentId = null;
                itemIdInput.value = '';
                itemIdPrefixInput.value = '';
                scanStatus.textContent = `Awaiting scan for next item...`;
                scanStatus.className = 'status-box';
                updateStatusBtn.style.display = 'none';
                scanAnotherItemBtn.style.display = 'none';
                cancelScanBtn.style.display = 'none';
                clearTrackingDetails();
                itemIdPrefixInput.focus();
            } else {
                resetScannerUI();
            }
        };
             
        window.cancelTransaction = () => {
            showToast('Transaction cancelled. Scanner reset.');
            resetScannerUI();
        };

        // --- ADDED: Equipment Mode functions from admin4 ---
        function renderEquipmentStatusChange(itemData) {
            scannedEquipmentId = itemData.itemId;
            const statusClass = itemData.status.replace(/[^a-zA-Z0-9]/g, '');
            trackingDetailsContainer.innerHTML = `
                <h3>${itemData.name} (${itemData.itemId})</h3>
                <p>
                    <strong>Current Status:</strong> <span class="status-badge status-${statusClass}">${itemData.status}</span><br>
                    <strong>Available Qty:</strong> ${itemData.quantity || 0} / ${itemData.originalQuantity || 0}
                </p>
                <div class="form-group" style="margin-top: 1.5rem;">
                    <label for="newEquipmentStatus">Change Status To:</label>
                    <select id="newEquipmentStatus" class="prefix-input">
                        <option value="Available" ${itemData.status === 'Available' ? 'selected' : ''}>Available</option>
                        <option value="Maintenance" ${itemData.status === 'Maintenance' ? 'selected' : ''}>Maintenance</option>
                        <option value="Calibration" ${itemData.status === 'Calibration' ? 'selected' : ''}>Calibration</option>
                        <option value="Damaged" ${itemData.status === 'Damaged' ? 'selected' : ''}>Damaged</option>
                        <option value="In-Use" disabled>In-Use (System-managed)</option>
                    </select>
                </div>`;
            scanStatus.textContent = `Item **${itemData.itemId}** is ready for status change.`;
            scanStatus.className = 'status-box equipment-ready';
            updateStatusBtn.style.display = 'inline-block';
            scanAnotherItemBtn.style.display = 'none';
            cancelScanBtn.style.display = 'inline-block';
        }

        window.updateEquipmentStatus = async () => {
            const newStatus = document.getElementById('newEquipmentStatus').value;
            const itemId = scannedEquipmentId;
            if (!itemId || !newStatus || newStatus === 'In-Use') return;
                 
            // Find the item in any of the stores
            let originalItem = null;
            let apiToCall = null;
            for (const type in inventoryTypes) {
                originalItem = inventoryTypes[type].store.find(i => i.itemId === itemId);
                if (originalItem) {
                    apiToCall = inventoryTypes[type].api;
                    break;
                }
            }

            if (!originalItem) {
                showToast(`Error: Item ${itemId} not found locally.`, 'error');
                return;
            }

            try {
                scanStatus.textContent = `Updating status for ${itemId}...`;
                scanStatus.className = 'status-box info';
                updateStatusBtn.style.display = 'none';
                     
                const isNowAvailable = newStatus === 'Available';
                const isNowUnavailable = ['Maintenance', 'Calibration', 'Damaged'].includes(newStatus);
                     
                const updateData = {
                    status: newStatus,
                    quantity: isNowUnavailable ? 0 : (isNowAvailable ? originalItem.originalQuantity : originalItem.quantity)
                };

                const response = await fetch(`${apiToCall}/${itemId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                if (!response.ok) throw new Error((await response.json()).message || 'Failed to update equipment status.');
                     
                showToast(`Status for ${itemId} updated to **${newStatus}**!`, 'success');
                scanStatus.textContent = `Success: Item **${itemId}** is now **${newStatus}**.`;
                scanStatus.className = 'status-box success';
                     
                for (const type in inventoryTypes) {
                    if (inventoryTypes[type].api === apiToCall) {
                        fetchInventory(type);
                        break;
                    }
                }
                     
                setTimeout(() => fetchAndDisplayItemDetails(itemId), 500);
                scanAnotherItemBtn.style.display = 'inline-block';
                cancelScanBtn.style.display = 'inline-block';
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
                scanStatus.textContent = `Error: ${error.message}`;
                scanStatus.className = 'status-box error';
                updateStatusBtn.style.display = 'inline-block';
            }
        };

        async function fetchAndDisplayItemDetails(itemId) {
            trackingDetailsContainer.innerHTML = '<p>Loading item details...</p>';
            try {
                const response = await fetch(`/api/item-details/${itemId}`);
                if (!response.ok) {
                    if (response.status === 404) { throw new Error(`Item ID **${itemId}** not found in the database.`); }
                    throw new Error(`Failed to fetch details for ${itemId}.`);
                }
                const data = await response.json();
                const originalQty = data.originalQuantity || data.quantity || 0;
                const availableQty = data.quantity || 0;
                const borrowedQty = originalQty - availableQty;
                // Use the item's status, but default to In-Use if borrowed
                const currentStatus = (borrowedQty > 0 && data.status !== 'Maintenance' && data.status !== 'Calibration' && data.status !== 'Damaged') ? 'In-Use' : (data.status || 'Available');
                const statusClass = currentStatus.replace(/[^a-zA-Z0-9]/g, '');
                     
                let trackingHTML = `
                    <h3>${data.name}</h3>
                    <p>
                        <strong>ID:</strong> ${data.itemId} |
                        <strong>Category:</strong> ${data.category} |
                        <strong>Location:</strong> ${data.location}
                    </p>
                    <p>
                        <strong>Current Status:</strong> <span class="status-badge status-${statusClass}">${currentStatus}</span> |
                        <strong>Available Qty:</strong> ${availableQty} / ${originalQty}
                    </p>`;
                if (borrowedQty > 0 && data.currentLoan) {
                    trackingHTML += `<div id="trackingBorrowerInfo"><p class="detail-item">Currently Borrowed By:</p><span>${data.currentLoan.studentName} (${data.currentLoan.studentID})</span><br><span><strong>Due Date:</strong> ${new Date(data.currentLoan.dueDate).toLocaleDateString()}</span></div>`;
                } else if (currentStatus === 'Maintenance' || currentStatus === 'Calibration' || currentStatus === 'Damaged') {
                    trackingHTML += `<div id="trackingBorrowerInfo" style="background-color: var(${currentStatus === 'Maintenance' ? '--warning' : (currentStatus === 'Damaged' ? '--danger' : '--calibration')}); color: white; border-color: #d1d5db;"><p class="detail-item">ITEM UNDER ${currentStatus.toUpperCase()}</p></div>`;
                }
                trackingHTML += `<h4>History</h4><div id="trackingHistoryLog">`;
                if(data.history && data.history.length > 0) {
                    data.history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(log => {
                        trackingHTML += `<div><strong>${log.action}</strong> by ${log.studentName || 'N/A'} on ${new Date(log.timestamp).toLocaleString()}</div>`;
                    });
                } else {
                    trackingHTML += `<div><div>No transaction history for this item.</div>`;
                }
                trackingHTML += `</div>`;
                trackingDetailsContainer.innerHTML = trackingHTML;
                return { success: true, status: currentStatus, itemData: data };
            } catch (error) {
                trackingDetailsContainer.innerHTML = `<p style="color: var(--danger);">**Error:** ${error.message}</p>`;
                return { success: false, message: error.message };
            }
        }
             
        // --- *** KEY FIX *** ---
        // --- THIS FUNCTION WAS MISSING ---
        // --- ADDED: Global function to handle modal submission (from admin_panel3.html) ---
        window.handleReturnConditionSubmission = async (e) => {
            e.preventDefault();
            const modal = document.getElementById('returnConditionModal');
            const finalItemId = document.getElementById('returnConditionItemId').value;
            const returnCondition = document.getElementById('conditionSelect').value;
            let damageNotes = document.getElementById('damageNotes').value.trim();
                 
            if (['Damaged', 'Lost'].includes(returnCondition) && damageNotes === '') {
                showToast('Notes on damage/loss are required for non-Good conditions.', 'error');
                return;
            }

            modal.style.display = 'none';
            disableAutoSubmit();

            try {
                const response = await fetch('/api/return-by-barcode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        itemId: finalItemId,
                        condition: returnCondition,
                        damageNotes: damageNotes
                    })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Failed to process return.');

                scanStatus.textContent = result.message;
                scanStatus.className = 'status-box success';
                showToast(result.message, 'success');
                fetchAndDisplayItemDetails(finalItemId); // Re-fetch details after return
                     
                // Refetch all inventories
                for (const type in inventoryTypes) fetchInventory(type);

            } catch (error) {
                scanStatus.textContent = error.message;
                scanStatus.className = 'status-box error';
                showToast(error.message, 'error');
            } finally {
                // Reset UI for next scan
                scanAnotherItemBtn.style.display = 'inline-block';
                cancelScanBtn.style.display = 'inline-block';
                enableAutoSubmit();
                itemIdPrefixInput.focus();
            }
        };
        // --- *** END OF FIX *** ---


        async function processScan(triggeredInput) {
            const mode = scanMode.value;
            const isStudentInput = triggeredInput === studentIdInput;
            const isItemInput = triggeredInput === itemIdInput;
                 
            // Consolidate prefix/suffix logic
            const finalItemId = (itemIdPrefixInput.value || '') + (itemIdInput.value || '');
            const finalStudentId = (studentIdPrefixInput.value || '') + (studentIdInput.value || '');

            if (mode === 'Borrowing' && isStudentInput && finalStudentId.trim() !== '') {
                currentBorrowingStudentId = finalStudentId.trim();
                studentIdInput.readOnly = true;
                scanStatus.textContent = `Student ID **${currentBorrowingStudentId}** captured. Now scan the item.`;
                scanStatus.className = 'status-box info';
                itemIdGroup.style.display = 'block';
                itemIdPrefixInput.focus();
                cancelScanBtn.style.display = 'inline-block';
                return;
            }

            if (isItemInput && finalItemId.trim() !== '') {
                const itemId = finalItemId.trim();
                disableAutoSubmit();
                itemIdInput.value = '';
                itemIdPrefixInput.value = '';

                const itemDetailsResult = await fetchAndDisplayItemDetails(itemId);
                if (!itemDetailsResult.success) {
                    scanStatus.textContent = `Error: ${itemDetailsResult.message}`;
                    scanStatus.className = 'status-box error';
                    scanAnotherItemBtn.style.display = 'inline-block';
                    cancelScanBtn.style.display = 'inline-block';
                    enableAutoSubmit();
                    itemIdPrefixInput.focus();
                    return;
                }

                if (mode === 'Borrowing' && currentBorrowingStudentId) {
                    const studentID = currentBorrowingStudentId;
                    if (itemDetailsResult.status === 'Maintenance' || itemDetailsResult.status === 'Calibration' || itemDetailsResult.status === 'Damaged') {
                        scanStatus.textContent = `Error: Item **${itemId}** is under ${itemDetailsResult.status} and cannot be borrowed.`;
                        scanStatus.className = 'status-box error';
                        showToast(`Error: Item ${itemId} under ${itemDetailsResult.status}.`, 'error');
                    } else {
                        try {
                            const response = await fetch('/api/borrow-by-barcode', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({ itemId: itemId, studentID })
                            });
                            const result = await response.json();
                            if (!response.ok) throw new Error(result.message || 'Failed to process borrowing.');
                            scanStatus.textContent = result.message;
                            scanStatus.className = 'status-box success';
                            showToast(result.message, 'success');
                            for (const type in inventoryTypes) fetchInventory(type);
                        } catch(error) {
                            scanStatus.textContent = error.message;
                            scanStatus.className = 'status-box error';
                            showToast(error.message, 'error');
                        }
                    }
                    scanAnotherItemBtn.style.display = 'inline-block';
                    cancelScanBtn.style.display = 'inline-block';

                } else if (mode === 'Returning') {
                    if (itemDetailsResult.itemData && itemDetailsResult.itemData.currentLoan) {
                        const borrowerName = itemDetailsResult.itemData.currentLoan.studentName;
                        const modal = document.getElementById('returnConditionModal');
                        document.getElementById('returnConditionItemId').value = itemId;
                        document.getElementById('modalItemName').textContent = itemDetailsResult.itemData.name;
                        document.getElementById('modalBorrowerName').textContent = `${borrowerName} (${itemDetailsResult.itemData.currentLoan.studentID})`;
                             
                        document.getElementById('conditionSelect').value = 'Good';
                        document.getElementById('damageNotes').value = '';
                        document.getElementById('damageNotesLabel').style.display = 'none';
                        document.getElementById('damageNotes').style.display = 'none';
                        document.getElementById('damageNotes').required = false;

                        modal.style.display = 'flex';
                    } else {
                        scanStatus.textContent = `Error: No active loan found for item ID ${itemId}. Cannot return.`;
                        scanStatus.className = 'status-box error';
                        showToast(`Error: No active loan found for ${itemId}.`, 'error');
                        scanAnotherItemBtn.style.display = 'inline-block';
                        cancelScanBtn.style.display = 'inline-block';
                    }
                } else if (mode === 'Status Check') {
                    scanStatus.textContent = `Item **${itemId}** Status: **${itemDetailsResult.status}**`;
                    scanStatus.className = `status-box info`;
                    scanAnotherItemBtn.style.display = 'inline-block';
                    cancelScanBtn.style.display = 'inline-block';
                } else if (mode === 'Equipment') {
                    renderEquipmentStatusChange(itemDetailsResult.itemData);
                }
                     
                enableAutoSubmit();
                if(mode !== 'Returning') itemIdPrefixInput.focus();
            }
        }


        // --- 6. INCIDENT MANAGEMENT (REMOVED) ---
             

        // --- 7. INVENTORY CRUD & RENDERING ---
        async function fetchInventory(type) {
            const config = inventoryTypes[type];
            try {
                const response = await fetch(config.api);
                if (!response.ok) throw new Error(`Failed to fetch ${type} inventory`);
                config.store = await response.json();
                     
                if (document.getElementById('inventory-content').classList.contains('active')) {
                    // isViewingInventoryArchive = false; // This line is handled by showPage
                    renderTable(type);
                }
            } catch (error) { showToast(error.message); renderTable(type); }
        }

        async function fetchArchivedInventory() {
            try {
                const response = await fetch('/api/archived-inventory');
                if (!response.ok) throw new Error('Failed to fetch archived inventory');
                const archivedItems = await response.json();
                     
                inventoryTypes.Science.store = archivedItems.filter(item => item.category === 'Science');
                inventoryTypes.Sports.store = archivedItems.filter(item => item.category === 'Sports');
                     
                if (document.getElementById('inventory-content').classList.contains('active')) {
                    isViewingInventoryArchive = true;
                    renderTable('Science');
                    renderTable('Sports');
                }
            } catch (error) {
                showToast(error.message);
                inventoryTypes.Science.store = [];
                inventoryTypes.Sports.store = [];
                renderTable('Science');
                renderTable('Sports');
            }
        }

/// --- MODIFIED FUNCTION: renderTable with Group-Specific Checkbox ---
function renderTable(type) {
    const config = inventoryTypes[type];
    const tableBody = config.tableBody;
    const table = tableBody.closest('table');
    const thead = table.querySelector('thead');

    const isArchiveView = isViewingInventoryArchive; 
    
    // Clear previous selections and update UI on render
    selectedArchivedItems = [];
    renderBulkActionBar(); 

    if (type === 'Science' || type === 'Sports') {
        scienceTableTitle.textContent = isArchiveView ? 'Archived Science Equipment' : 'Science Equipment';
        sportsTableTitle.textContent = isArchiveView ? 'Archived Sports Equipment' : 'Sports Equipment';
        toggleInventoryArchiveBtn.textContent = isArchiveView ? 'View Active Inventory' : 'View Archives';
    }

    const searchTerm = config.searchInput.value.toLowerCase();
    const statusFilterValue = config.statusFilter.value;

    const filteredData = config.store.filter(item => {
        const originalQty = item.originalQuantity || item.quantity || 0;
        const borrowedQty = originalQty - (item.quantity || 0);
        const displayStatus = (borrowedQty > 0 && item.status !== 'Maintenance' && item.status !== 'Damaged' && item.status !== 'Calibration') ? 'In-Use' : (item.status || 'Available');
        
        const matchesSearch = Object.values(item).some(val => String(val).toLowerCase().includes(searchTerm));
        const matchesStatus = isArchiveView || statusFilterValue === 'All' || 
                                item.status === statusFilterValue ||
                                (statusFilterValue === 'In-Use' && displayStatus === 'In-Use');
        return matchesSearch && matchesStatus;
    });

    // 1. Group the filtered items by their Name (e.g., "Ammeter", "Mbot Kit")
    const groupedData = filteredData.reduce((groups, item) => {
        const key = item.name; 
        if (!groups[key]) {
            const prefixMatch = item.itemId.match(/^([A-Z]+)-\d+$/i);
            const prefix = prefixMatch ? prefixMatch[1].toUpperCase() : 'N/A';
            
            groups[key] = {
                items: [],
                prefix: prefix,
                category: item.category, 
                totalQuantity: 0,
                totalBorrowed: 0,
                location: item.location,
                modelItemId: item.itemId 
            };
        }
        groups[key].items.push(item);
        groups[key].totalQuantity += item.originalQuantity || 0;
        groups[key].totalBorrowed += (item.originalQuantity || 0) - (item.quantity || 0);
        return groups;
    }, {});

    tableBody.innerHTML = '';
    
    if (filteredData.length === 0) {
        const msg = isArchiveView ? 'No archived equipment found.' : 'No equipment found.';
        tableBody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding: 20px;">${msg}</td></tr>`;
        return;
    }
    
    // --- FIX: CLEAR THE EXISTING HEADER BEFORE INSERTING THE NEW ONE ---
    if (thead) {
        thead.innerHTML = ''; 
    }
    
    let groupIndex = 0;
    
    // --- 2. Rebuild Table Header ---
    const headerRow = thead.insertRow(0);
    
    // Master Checkbox in header
    const masterCheckboxHtml = isArchiveView || !isArchiveView ? 
                           `<input type="checkbox" id="checkAllUnits" onclick="toggleAllUnits(this)"> ID` : 'ID';
    
    headerRow.innerHTML = `
        <th>${masterCheckboxHtml}</th>
        <th>NAME</th>
        <th>CATEGORY</th>
        <th>TOTAL QTY</th>
        <th>BORROWED</th>
        <th>AVAILABLE</th>
        <th>LOCATION</th>
        <th>STATUS</th>
        <th>ACTIONS</th>
    `;
    
    // 3. Render the Group Headers and Collapsible Rows
    Object.keys(groupedData).sort().forEach(groupName => {
        const group = groupedData[groupName];
        groupIndex++;
        const groupId = `group-${type}-${groupIndex}`;
        const totalAvailable = group.totalQuantity - group.totalBorrowed;
        const modelIdForActions = group.modelItemId;

        // Check if all items in this group are currently selected
        const isGroupChecked = group.items.every(item => selectedArchivedItems.includes(item.itemId));


        // --- Group Header Row (Summary) ---
        const groupHeaderRow = tableBody.insertRow();
        groupHeaderRow.id = groupId + '-header';
        groupHeaderRow.classList.add('inventory-group-header');
        
        let headerActionsHtml = '';
        if (isArchiveView) {
            headerActionsHtml = `
                
            `;
        } else {
            // Active View: Only Edit Model remains
            headerActionsHtml = `
                <button
                    class="btn btn-edit"
                    data-item-ids="${group.items.map(i => i.itemId).join('|')}"
                    onclick="handleModelEditClick(event, '${type}', '${modelIdForActions}')"
                >
                    Edit Model
                </button>
            `;
        }
        
        // Structure for Group Header
        groupHeaderRow.innerHTML = `
            <td colspan="2" style="cursor: pointer; font-weight: 700;">
                <input type="checkbox" id="checkGroup-${groupId}"
                       onclick="event.stopPropagation(); toggleGroupUnits(this, '${groupId}', '${type}')"
                       style="margin-right: 5px;" 
                       ${isGroupChecked ? 'checked' : ''}>
                <span onclick="toggleGroup('${groupId}', this.parentNode)">
                     <strong>${group.prefix} (${groupName})</strong>
                </span>
            </td>
            <td>${group.category}</td>
            <td>${group.totalQuantity}</td>
            <td>${group.totalBorrowed}</td>
            <td>${totalAvailable}</td>
            <td>${group.location}</td>
            <td></td>
            <td class="actions-cell">
                ${headerActionsHtml}
            </td>
        `;

        // --- Individual Item Rows (Collapsible) ---
        group.items.sort((a, b) => a.itemId.localeCompare(b.itemId)).forEach(item => {
            const borrowedQty = (item.originalQuantity || 0) - (item.quantity || 0);
            const availableQty = item.quantity || 0;
            const displayStatus = (borrowedQty > 0 && item.status !== 'Maintenance' && item.status !== 'Damaged' && item.status !== 'Calibration') ? 'In-Use' : (item.status || 'Available');
            const statusClass = displayStatus.replace(/[^a-zA-Z0-9]/g, '');
            
            let actionsHtml = '';
            
            // **MODIFICATION for Detail Actions**
            if (isArchiveView) {
                actionsHtml = `
                    <button class="btn btn-restore" onclick="restoreInventoryItem('${item.itemId}')">Restore</button>
                    <button class="btn btn-delete-permanent" onclick="deleteInventoryItemPermanently('${item.itemId}')">Delete Permanently</button>
                `;
            } else {
                 // Active View Detail Actions (Archive Button for single unit)
                actionsHtml = `
                    <button class="btn btn-edit" onclick="openEditModal('${type}', '${item.itemId}')">Edit</button>
                    <button class="btn btn-delete" onclick="archiveInventoryItem('${type}', '${item.itemId}')">Archive</button>
                `;
            }
            
            const itemRow = tableBody.insertRow();
            itemRow.classList.add('inventory-item-detail', groupId); 
            itemRow.style.display = 'none'; 
            
  
            itemRow.innerHTML = `
                <td style="padding-left: 15px; width: 100px;">
                    <input type="checkbox" data-item-id="${item.itemId}" data-group-id="${groupId}"
                           onclick="event.stopPropagation(); toggleItemSelection('${item.itemId}')"
                           ${selectedArchivedItems.includes(item.itemId) ? 'checked' : ''}>
                    <span style="padding-left: 5px;">${item.itemId}</span>
                </td>
                <td>${item.name}</td> 
                
                <td colspan="4" style="color: #6c757d; font-style: italic; text-align: left;">
                     Unit Detail 
                </td> 
                
                <td>${item.location}</td>
                <td><span class="status-badge status-${statusClass}">${displayStatus}</span></td>
                <td class="actions-cell">${actionsHtml}</td>`;
        });
    });
}


// --- NEW GLOBAL FUNCTION DEFINITIONS (FOR GROUP SELECT) ---

// NEW FUNCTION: Toggle all individual units within a specific collapsed group
window.toggleGroupUnits = (masterCheckbox, groupId, type) => {
    // 1. Get all individual checkboxes belonging to this group
    const individualCheckboxes = document.querySelectorAll(`.inventory-item-detail input[type="checkbox"][data-group-id="${groupId}"]`);
    
    // 2. Determine action and process selections
    const isChecking = masterCheckbox.checked;

    individualCheckboxes.forEach(cb => {
        cb.checked = isChecking;
        const itemId = cb.getAttribute('data-item-id');
        const index = selectedArchivedItems.indexOf(itemId);

        if (isChecking && index === -1) {
            selectedArchivedItems.push(itemId);
        } else if (!isChecking && index > -1) {
            selectedArchivedItems.splice(index, 1);
        }
    });

    // 3. Update the global "Select All" checkbox status and action bar
    updateMasterAndBulkActionUI();
};

// --- HELPER FUNCTION: Consolidates logic to update the top master checkbox ---
function updateMasterAndBulkActionUI() {
    renderBulkActionBar();
    
    const allUnits = document.querySelectorAll('.inventory-item-detail input[type="checkbox"]');
    const masterCheckbox = document.getElementById('checkAllUnits');
    
    if (masterCheckbox) {
        // If every single checkbox is checked, check the master box
        masterCheckbox.checked = allUnits.length > 0 && selectedArchivedItems.length === allUnits.length;
    }
}
             
        // --- NEW HELPER FUNCTION FOR ID GENERATION ---
        function findNextSequenceId(prefix, items) {
            let maxNum = 0;
            // Normalize prefix to uppercase for consistent comparison
            const normalizedPrefix = String(prefix).toUpperCase().trim();
            // Escape special regex characters in prefix
            const escapedPrefix = normalizedPrefix.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            // Regex to match the prefix followed by a hyphen and digits, case insensitive
            const prefixPattern = new RegExp(`^${escapedPrefix}-(\\d+)$`, 'i');

            items.forEach(item => {
                const match = item.itemId.match(prefixPattern);
                if (match) {
                    const num = parseInt(match[1]);
                    if (!isNaN(num) && num > maxNum) {
                        maxNum = num;
                    }
                }
            });
            // Start the next sequence one step higher than the maximum found
            return maxNum + 1;
        }

        // --- MODIFIED handleAddItem FUNCTION (Replaces original version) ---
        async function handleAddItem(e, type) {
            e.preventDefault();
            const config = inventoryTypes[type];
            const form = e.target;

            // Get form data using the new input names
            const prefix = form.querySelector('[name="itemIdPrefix"]').value.toUpperCase().trim();
            const name = form.querySelector('[name="name"]').value;
            const category = form.querySelector('[name="category"]').value;
            const quantity = parseInt(form.querySelector('[name="quantity"]').value);
            const location = form.querySelector('[name="location"]').value;
            
            if (quantity <= 0) {
                showToast('Quantity must be 1 or more.', 'error');
                return;
            }
            if (!prefix) {
                showToast('Item ID Prefix cannot be empty.', 'error');
                return;
            }

            // CRITICAL: Refresh inventory store before calculating next sequence ID
            // This ensures we have the latest data including any recently created items
            try {
                const refreshResponse = await fetch(config.api);
                if (refreshResponse.ok) {
                    config.store = await refreshResponse.json();
                }
            } catch (refreshError) {
                console.warn('Failed to refresh inventory before adding item:', refreshError);
                // Continue anyway - server will catch duplicates
            }

            // 1. Determine the starting sequence number
            const nextSequenceNumber = findNextSequenceId(prefix, config.store);
            
            const itemsToCreate = [];
            
            // Calculate how many digits are needed for formatting (at least 2 digits)
            const maxDigits = Math.max(2, String(nextSequenceNumber + quantity - 1).length);

            for (let i = 0; i < quantity; i++) {
                const currentNumber = nextSequenceNumber + i;
                
                // 2. Format the sequential number with leading zeros (e.g., 1 -> 01, 10 -> 10, 100 -> 100)
                let sequence = String(currentNumber).padStart(maxDigits, '0');
                
                // 3. Construct the unique Item ID (normalize to uppercase for consistency)
                const uniqueItemId = `${prefix}-${sequence}`.toUpperCase().trim();

                itemsToCreate.push({
                    itemId: uniqueItemId,
                    name: name,
                    category: category,
                    quantity: 1, // Crucial: Each record represents one item
                    originalQuantity: 1,
                    location: location,
                    status: 'Available'
                });
            }

            try {
                // Send the array of uniquely generated items to the server
                const response = await fetch(config.api, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(itemsToCreate) // The server must be able to handle an array
                });
                
                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({}));
                    const errorMessage = errorBody.message || `Failed to add ${quantity} items.`;
                    
                    // Check if it's a duplicate Item ID error (409 Conflict)
                    if (response.status === 409) {
                        showToast(` ${errorMessage} Item ID already exists in this inventory table. Cannot create duplicate.`, 'error');
                        // Refresh inventory to show current state
                        fetchInventory(type);
                        return; // Stop execution - do not reset form or refresh inventory again
                    } else {
                        throw new Error(errorMessage);
                    }
                }
                
                // Success - only reached if no duplicates found
                showToast(` Successfully added ${quantity} items (IDs: ${itemsToCreate[0].itemId} to ${itemsToCreate[itemsToCreate.length - 1].itemId})!`, 'success');
                form.reset();
                fetchInventory(type);

            } catch (error) { 
                // Network or other errors
                if (error.message.includes('already exist') || error.message.includes('Duplicate')) {
                    showToast(` ${error.message} Item ID already exists. Cannot create duplicate.`, 'error');
                } else {
                    showToast(` Error: ${error.message}`, 'error');
                }
            }
        }
        // --- END OF MODIFIED handleAddItem FUNCTION ---

        async function handleUpdateItem(e) {
            e.preventDefault();
            const editFormElement = document.getElementById('editForm');
            const formType = editFormElement.dataset.type;
            if (formType === 'inventory') {
                const itemId = document.getElementById('editItemId').value;
                const type = document.getElementById('editItemType').value;
                const config = inventoryTypes[type];
                const itemIdsAttr = editFormElement.dataset.itemIds || itemId;
                const itemIds = itemIdsAttr.split(',').filter(Boolean);

                const updatedData = {
                    name: document.getElementById('editItemName').value,
                    category: document.getElementById('editCategory').value,
                    location: document.getElementById('editLocation').value,
                };

                try {
                    const updateRequests = itemIds.map(async (id) => {
                        const response = await fetch(`${config.api}/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(updatedData),
                        });
                        if (!response.ok) {
                            const errorBody = await response.json().catch(() => ({}));
                            throw new Error(errorBody.message || `Failed to update item ${id}`);
                        }
                    });

                    await Promise.all(updateRequests);
                    showToast('Item updated successfully!');
                    editModal.style.display = 'none';
                    fetchInventory(type);
                } catch (error) { showToast(`Error: ${error.message}`); }
            } else if (formType === 'request') {
                const requestId = document.getElementById('editRequestId').value;
                const updatedData = {
                    itemName: document.getElementById('editItemName').value,
                    quantity: parseInt(document.getElementById('editQuantity').value),
                    reason: document.getElementById('editReason').value,
                    startDate: document.getElementById('editStartDate').value,
                    dueDate: document.getElementById('editDueDate').value,
                };
                try {
                    const response = await fetch(`/api/edit-request/${requestId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(updatedData) });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message || 'Failed to update request');
                    showToast('Request updated successfully!');
                    editModal.style.display = 'none';
                    fetchAllRequests();
                } catch (error) { showToast(`Error: ${error.message}`); }
            } else if(formType === 'user') {
                handleUpdateUser(e);
            }
        }
             
        // --- 8. REQUESTS ---
        const toggleRequestView = () => {
            isViewingTrash = !isViewingTrash;
            if (isViewingTrash) {
                fetchDeletedRequests();
            } else {
                fetchAllRequests();
            }
        };
             
        const toggleInventoryArchiveView = () => {
            isViewingInventoryArchive = !isViewingInventoryArchive;
            if (isViewingInventoryArchive) {
                fetchArchivedInventory();
            } else {
                fetchInventory('Science');
                fetchInventory('Sports');
            }
        };

        async function fetchAllRequests() {
            try {
                const response = await fetch('/api/admin2-requests');
                if (!response.ok) throw new Error('Failed to fetch requests');
                allRequestsData = await response.json();
                if (document.getElementById('requests-content').classList.contains('active')) {
                    isViewingTrash = false;
                    renderRequestsTable();
                }
            } catch (error) {
                showToast(error.message);
                if (document.getElementById('requests-content').classList.contains('active')) {
                    requestsTableBody.innerHTML = `<tr><td colspan="9" style="text-align:center;">Failed to load requests.</td></tr>`;
                }
            }
        }

        async function fetchDeletedRequests() {
            try {
                const response = await fetch('/api/deleted-requests');
                if (!response.ok) throw new Error('Failed to fetch deleted requests');
                allRequestsData = await response.json();
                if (document.getElementById('requests-content').classList.contains('active')) {
                    isViewingTrash = true;
                    renderRequestsTable();
                }
            } catch (error) {
                showToast(error.message);
            }
        }

        const renderRequestsTable = () => {
            requestsTitle.textContent = isViewingTrash ? 'Deleted Requests (Trash)' : 'Manage Student Requests';
            toggleTrashViewBtn.textContent = isViewingTrash ? 'View Active Requests' : 'View Trash';
            requestStatusFilter.style.display = isViewingTrash ? 'none' : 'block';

            const searchTerm = requestSearch.value.toLowerCase();
            const currentStatus = requestStatusFilter.value;
            let filtered = allRequestsData.filter(req => {
                const matchesSearch = (req.studentName.toLowerCase().includes(searchTerm) || req.itemName.toLowerCase().includes(searchTerm) || req.itemId.toLowerCase().includes(searchTerm));
                const matchesStatus = isViewingTrash || currentStatus === 'All' || req.status === currentStatus;
                return matchesSearch && matchesStatus;
            });

            requestsTableBody.innerHTML = '';
            const sortedData = filtered.sort((a, b) => new Date(b.requestDate) - new Date(a.requestDate));

            if (sortedData.length === 0) {
                const message = isViewingTrash ? 'The trash is empty.' : 'No student requests found.';
                requestsTableBody.innerHTML = `<tr><td colspan="9" style="text-align:center;">${message}</td></tr>`;
                return;
            }

            sortedData.forEach(req => {
                const row = requestsTableBody.insertRow();
                const startDate = req.startDate ? new Date(req.startDate).toLocaleDateString() : 'N/A';
                const dueDate = req.dueDate ? new Date(req.dueDate).toLocaleDateString() : 'N/A';
                            
                let actions;
                if (isViewingTrash) {
                    actions = `
                        <button class="btn btn-restore" onclick="restoreRequest('${req._id}')">Restore</button>
                        <button class="btn btn-delete" onclick="deleteRequestPermanently('${req._id}')">Delete Permanently</button>`;
                } else if (req.status === 'Returned') {
                    // For Returned status, only show View Details button
                    actions = `
                        <button class="btn btn-edit" onclick="openViewRequestDetailsModal('${req._id}')">View Details</button>`;
                } else {
                    actions = `
                        <button class="btn btn-edit" onclick="openEditRequestModal('${req._id}')">Edit</button>
                        <button class="btn" style="background-color:var(--primary-light); color:white;" onclick="openStatusEditModal('${req._id}')">Status</button>
                        <button class="btn btn-delete" onclick="moveRequestToTrash('${req._id}')">Delete</button>`;
                }

                row.innerHTML = `
                    <td>${req.studentName}</td><td>${req.itemId}</td><td>${req.itemName}</td>
                    <td>${startDate}</td><td>${dueDate}</td><td>${req.quantity}</td><td>${req.reason}</td>
                    <td><span class="status-badge status-${req.status.replace(/[^a-zA-Z0-9]/g, '')}">${req.status}</span></td>
                    <td class="actions-cell">${actions}</td>`;
            });
        };
             
        window.handleRequest = async (requestId, newStatus) => {
            try {
                const response = await fetch(`/api/update-request/${requestId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: newStatus }) });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || `Failed to update request`);
                showToast(result.message || `Request updated successfully.`);
                fetchAllRequests();
                fetchAdminNotifications();
                for (const type in inventoryTypes) fetchInventory(type);
            } catch (error) { showToast(`Error: ${error.message}`); }
        };

        window.moveRequestToTrash = async (requestId) => {
            if (!confirm('Are you sure you want to move this request to the trash?')) return;
            try {
                const res = await fetch(`/api/requests/${requestId}/delete`, { method: 'PUT' });
                const result = await res.json();
                if (!res.ok) throw new Error(result.message);
                showToast(result.message);
                fetchAllRequests();
            } catch (error) { showToast(`Error: ${error.message}`); }
        };

        window.restoreRequest = async (requestId) => {
            if (!confirm('Are you sure you want to restore this request?')) return;
            try {
                const res = await fetch(`/api/requests/${requestId}/restore`, { method: 'PUT' });
                const result = await res.json();
                if (!res.ok) throw new Error(result.message);
                showToast(result.message);
                fetchDeletedRequests();
            } catch (error) { showToast(`Error: ${error.message}`); }
        };

        window.deleteRequestPermanently = async (requestId) => {
            if (!confirm('WARNING: This will permanently delete the request and cannot be undone. Are you sure?')) return;
            try {
                const res = await fetch(`/api/requests/${requestId}/permanent`, { method: 'DELETE' });
                const result = await res.json();
                if (!res.ok) throw new Error(result.message);
                showToast(result.message);
                fetchDeletedRequests();
            } catch (error) { showToast(`Error: ${error.message}`); }
        };
             
        // --- 9. SUPER ADMIN & USER MANAGEMENT FUNCTIONS ---
        async function loadSuperAdminData() {
            try {
                const [admin2InvRes, admin3InvRes, admin4InvRes, admin2ReqRes, admin3ReqRes, admin4ReqRes] = await Promise.all([
                    Promise.all([fetch('/api/inventory2'), fetch('/api/inventory3')]),
                    Promise.all([fetch('/api/inventory4'), fetch('/api/inventory5'), fetch('/api/inventory6'), fetch('/api/inventory8')]),
                    fetch('/api/inventory7'),
                    fetch('/api/admin2-requests'),
                    fetch('/api/admin3-requests'),
                    fetch('/api/admin-requests/Robotics')
                ]);

                const admin2InventoriesJson = await Promise.all(admin2InvRes.map(res => res.json()));
                const admin2Science = admin2InventoriesJson[0];
                const admin2Sports = admin2InventoriesJson[1];

                const admin3InventoriesJson = await Promise.all(admin3InvRes.map(res => res.json()));
                const admin3Inventories = [].concat(...admin3InventoriesJson);
                const admin4Inventories = await admin4InvRes.json();
                     
                // Store data for filtering
                superAdmin2ScienceData = admin2Science;
                superAdmin2SportsData = admin2Sports;
                superAdmin3InventoryData = admin3Inventories;
                superAdmin4InventoryData = admin4Inventories;
                     
                // Render tables with current filter values
                const scienceFilter = document.getElementById('superAdmin2ScienceStatusFilter')?.value || 'All';
                const sportsFilter = document.getElementById('superAdmin2SportsStatusFilter')?.value || 'All';
                const admin3Filter = document.getElementById('superAdmin3StatusFilter')?.value || 'All';
                const admin4Filter = document.getElementById('superAdmin4StatusFilter')?.value || 'All';
                     
                renderSuperAdminInventoryTable(admin2Science, document.getElementById('tableAdmin2ScienceInventory').querySelector('tbody'), scienceFilter);
                renderSuperAdminInventoryTable(admin2Sports, document.getElementById('tableAdmin2SportsInventory').querySelector('tbody'), sportsFilter);
                renderSuperAdminInventoryTable(admin3Inventories, document.getElementById('tableAdmin3Inventory').querySelector('tbody'), admin3Filter);
                renderSuperAdminInventoryTable(admin4Inventories, document.getElementById('tableAdmin4Inventory').querySelector('tbody'), admin4Filter);

                const allMonitoredRequests = [
                    ...(await admin2ReqRes.json()),
                    ...(await admin3ReqRes.json()),
                    ...(await admin4ReqRes.json())
                ];
                renderSuperAdminRequestsTable(allMonitoredRequests, document.getElementById('tableAllMonitoredRequests').querySelector('tbody'));
            } catch (error) {
                console.error("Super Admin Page Load Error:", error);
                showToast("Error loading Super Admin data.");
            }
        }

        function renderSuperAdminInventoryTable(data, tableBody, statusFilter = 'All') {
            tableBody.innerHTML = '';
            if (!data || data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No inventory data.</td></tr>`;
                return;
            }
            
            // Filter data by status
            let filteredData = data;
            if (statusFilter !== 'All') {
                filteredData = data.filter(item => {
                    const originalQty = item.originalQuantity || item.quantity || 0;
                    const borrowedQty = originalQty - (item.quantity || 0);
                    const displayStatus = (borrowedQty > 0 && item.status !== 'Maintenance' && item.status !== 'Damaged' && item.status !== 'Calibration') 
                        ? 'In-Use' 
                        : (item.status || 'Available');
                    return displayStatus === statusFilter || (statusFilter === 'In-Use' && displayStatus === 'In-Use');
                });
            }
            
            if (filteredData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No items found with status "${statusFilter}".</td></tr>`;
                return;
            }
            
            filteredData.forEach(item => {
                const originalQty = item.originalQuantity || item.quantity || 0;
                const borrowedQty = originalQty - (item.quantity || 0);
                const displayStatus = (borrowedQty > 0 && item.status !== 'Maintenance' && item.status !== 'Damaged' && item.status !== 'Calibration') 
                    ? 'In-Use' 
                    : (item.status || 'Available');
                const statusClass = displayStatus.replace(/[^a-zA-Z0-9]/g, '');
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${item.itemId}</td><td>${item.name}</td><td>${item.category}</td>
                    <td>${item.originalQuantity || item.quantity}</td><td>${item.location}</td><td><span class="status-badge status-${statusClass}">${displayStatus}</span></td>`;
            });
        }
             
        function renderSuperAdminRequestsTable(data, tableBody) {
            tableBody.innerHTML = '';
            if (!data || data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No request data.</td></tr>`;
                return;
            }
            data.sort((a,b) => new Date(b.requestDate) - new Date(a.requestDate)).forEach(req => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${req.studentName}</td><td>${req.itemName}</td><td>${req.category}</td>
                    <td><span class="status-badge status-${req.status.replace(/[^a-zA-Z0-9]/g, '')}">${req.status}</span></td>
                    <td>${new Date(req.requestDate).toLocaleDateString()}</td>`;
            });
        }

        async function fetchAllUsers() {
            // --- MODIFIED: Hide archive button as server.js doesn't support user archive ---
            toggleUserArchiveBtn.style.display = 'none';
            usersTableTitle.textContent = 'All System Users';
            try {
                const response = await fetch('/api/all-users');
                if (!response.ok) throw new Error('Failed to fetch users. You may not have super admin rights.');
                allUsersData = await response.json();
                if (document.getElementById('user-management-content').classList.contains('active')) {
                    renderUsersTable();
                }
            } catch(error) {
                showToast(error.message);
            }
        }
             
        // --- REMOVED: fetchArchivedUsers() ---
             
        // --- MODIFIED: toggleUserArchiveView (to just hide the button) ---
        function toggleUserArchiveView() {
            showToast('User archiving is not supported.');
            toggleUserArchiveBtn.style.display = 'none';
        }

        // --- MODIFIED: renderUsersTable (removed archive logic) ---
        function renderUsersTable() {
            usersTableTitle.textContent = 'All System Users';
            toggleUserArchiveBtn.style.display = 'none'; // Ensure it's hidden
            searchUsersInput.placeholder = 'Search by name, ID, or email...';

            const searchTerm = searchUsersInput.value.toLowerCase();
            const filtered = allUsersData.filter(user =>
                user.firstName.toLowerCase().includes(searchTerm) ||
                user.lastName.toLowerCase().includes(searchTerm) ||
                user.username.toLowerCase().includes(searchTerm) ||
                user.email.toLowerCase().includes(searchTerm) ||
                user.studentID.toLowerCase().includes(searchTerm)
            );

            usersTableBody.innerHTML = '';
                 
            if (filtered.length === 0) {
                usersTableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">No active users found.</td></tr>`;
                return;
            }
                 
            filtered.forEach(user => {
                const row = usersTableBody.insertRow();
                     
                let actionsHtml = `
                    <button class="btn btn-edit" onclick="openEditUserModal('${user._id}')">Edit</button>
                    <button class="btn btn-delete" onclick="deleteUser('${user._id}')">Delete</button>
                `;
                     
                row.innerHTML = `
                    <td>${user.firstName} ${user.lastName}</td>
                    <td>${user.username}</td>
                    <td>${user.studentID}</td>
                    <td>${user.email}</td>
                    <td>${user.role}</td>
                    <td><span class="status-badge status-${user.status}">${user.status}</span></td>
                    <td class="actions-cell">
                        ${actionsHtml}
                    </td>
                `;
            });
        }

        // --- MODIFIED: handleCreateUser (password is not required) ---
        async function handleCreateUser(e) {
            e.preventDefault();
            const form = e.target;
            const newUser = {
                firstName: form.querySelector('[name="firstName"]').value,
                lastName: form.querySelector('[name="lastName"]').value,
                username: form.querySelector('[name="username"]').value,
                email: form.querySelector('[name="email"]').value,
                studentID: form.querySelector('[name="studentID"]').value,
                password: form.querySelector('[name="password"]').value, // Send password (or empty string)
                role: form.querySelector('[name="role"]').value,
                gradeLevel: form.querySelector('[name="role"]').value === 'student' ? 'N/A' : 'N/A'
            };

            // Password is only required if the role is admin
            if (newUser.role === 'admin' && !newUser.password) {
                showToast('Error: Password is required for admin accounts.');
                return;
            }
                 
            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newUser)
                });
                if (!response.ok) throw new Error((await response.text()) || 'Failed to create user');
                showToast('User created successfully!');
                form.reset();
                fetchAllUsers();
            } catch (error) { showToast(`Error: ${error.message}`); }
        }
             
        window.openEditUserModal = (userId) => {
            const user = allUsersData.find(u => u._id === userId);
            if (user) {
                document.getElementById('editModalTitle').innerText = 'Edit User';
                editForm.innerHTML = `
                    <input type="hidden" id="editUserId" value="${user._id}">
                    <label for="editUserRole">Role</label>
                    <select id="editUserRole">
                        <option value="student" ${user.role === 'student' ? 'selected' : ''}>Student</option>
                        <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                        <option value="faculty" ${user.role === 'faculty' ? 'selected' : ''}>Faculty</option>

                    </select>
                    <label for="editUserPassword">New Password (optional)</label>
                    <input type="password" id="editUserPassword" placeholder="Leave blank to keep current password">
                    <button type="submit">Save Changes</button>`;
                editForm.dataset.type = 'user';
                delete editForm.dataset.itemIds;
                editForm.onsubmit = handleUpdateUser;
                editModal.style.display = 'flex';
            }
        };
             
        async function handleUpdateUser(e) {
            e.preventDefault();
            const userId = document.getElementById('editUserId').value;
            const newRole = document.getElementById('editUserRole').value;
            const newPassword = document.getElementById('editUserPassword').value;
                 
            try {
                const roleRes = await fetch(`/api/users/${userId}/role`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: newRole })
                });
                if (!roleRes.ok) throw new Error('Failed to update role');

                if (newPassword) {
                    const passRes = await fetch(`/api/users/${userId}/reset-password`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ newPassword: newPassword })
                    });
                    if (!passRes.ok) throw new Error('Failed to reset password');
                }
                     
                showToast('User updated successfully!');
                editModal.style.display = 'none';
                fetchAllUsers();
            } catch(error) {
                showToast(`Error: ${error.message}`);
            }
        }

        // --- MODIFIED: Replaced archive/restore/permanent with single deleteUser ---
        window.deleteUser = async (userId) => {
            if (!confirm('Are you sure you want to permanently delete this user? This action cannot be undone.')) return;
            try {
                const response = await fetch(`/api/users/${userId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error(await response.text());
                showToast('User deleted successfully.');
                fetchAllUsers();
            } catch(error) {
                showToast(`Error: ${error.message}`);
            }
        };
        // --- END: User Management Mods ---


        // --- 10. PROFILE & REGISTRATION REQUESTS ---
        async function fetchProfileUpdateRequests() {
            try {
                const response = await fetch('/api/profile-update-requests');
                if (!response.ok) throw new Error('Failed to fetch profile update requests.');
                const requests = await response.json();
                renderProfileUpdateRequests(requests);
            } catch (error) {
                showToast(error.message);
                document.getElementById('profileRequestsTableBody').innerHTML = `<tr><td colspan="6" style="text-align:center;">${error.message}</td></tr>`;
            }
        }

        function renderProfileUpdateRequests(requests) {
            const tableBody = document.getElementById('profileRequestsTableBody');
            tableBody.innerHTML = '';
            if (requests.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No pending profile update requests.</td></tr>`;
                return;
            }
            requests.forEach(req => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${req.username}</td>
                    <td>${req.currentFullName}</td>
                    <td>${req.newFirstName} ${req.newLastName}</td>
                    <td>${req.newEmail}</td>
                    <td>${new Date(req.requestedAt).toLocaleDateString()}</td>
                    <td class="actions-cell">
                        <button class="btn btn-edit" onclick="handleProfileRequest('${req._id}', 'approve')">Approve</button>
                        <button class="btn btn-delete" onclick="handleProfileRequest('${req._id}', 'reject')">Reject</button>
                    </td>
                `;
            });
        }

        window.handleProfileRequest = async (requestId, action) => {
            if (!confirm(`Are you sure you want to ${action} this request?`)) return;
            try {
                const response = await fetch(`/api/profile-update-requests/${requestId}/${action}`, {
                    method: 'PUT'
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || `Failed to ${action} request.`);
                showToast(result.message);
                fetchProfileUpdateRequests();
            } catch (error) {
                showToast(`Error: ${error.message}`);
            }
        };

        async function fetchPendingRegistrations() {
            try {
                const response = await fetch('/api/pending-registrations');
                if (!response.ok) throw new Error('Failed to fetch pending registrations.');
                const users = await response.json();
                renderPendingRegistrations(users);
            } catch (error) {
                showToast(error.message);
                document.getElementById('registrationRequestsTableBody').innerHTML = `<tr><td colspan="6" style="text-align:center;">${error.message}</td></tr>`;
            }
        }

        function renderPendingRegistrations(users) {
            const tableBody = document.getElementById('registrationRequestsTableBody');
            tableBody.innerHTML = '';
            if (users.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No pending registrations.</td></tr>`;
                return;
            }
            users.forEach(user => {
                const row = tableBody.insertRow();
                // Use creation date from _id
                const registrationDate = new Date(parseInt(user._id.substring(0, 8), 16) * 1000).toLocaleDateString();
                row.innerHTML = `
                    <td>${user.firstName} ${user.lastName}</td>
                    <td>${user.username}</td>
                    <td>${user.studentID}</td>
                    <td>${user.email}</td>
                    <td>${registrationDate}</td>
                    <td class="actions-cell">
                        <button class="btn btn-edit" onclick="handleRegistration('${user._id}', 'approve')">Approve</button>
                        <button class="btn btn-delete" onclick="handleRegistration('${user._id}', 'reject')">Reject</button>
                    </td>
                `;
            });
        }

        window.handleRegistration = async (userId, action) => {
            const confirmationText = action === 'reject'
                ? 'Are you sure you want to reject and delete this registration? This is irreversible.'
                : `Are you sure you want to ${action} this registration?`;
            if (!confirm(confirmationText)) return;

            const url = `/api/registrations/${userId}/${action}`;
            const method = action === 'approve' ? 'PUT' : 'DELETE';

            try {
                const response = await fetch(url, { method });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || `Failed to ${action} registration.`);
                showToast(result.message);
                fetchPendingRegistrations();
            } catch (error) {
                showToast(`Error: ${error.message}`);
            }
        };

        // --- 11. NOTIFICATIONS, HISTORY & UTILITIES ---
        const updateNotificationBadge = () => {
            const unreadCount = notifications.filter(n => !n.isRead).length;
            notificationBadge.textContent = unreadCount;
            notificationBadge.style.display = unreadCount > 0 ? 'inline-block' : 'none';
        };
             
        const renderNotifications = () => {
            notificationList.innerHTML = '';
            if (notifications.length === 0) {
                notificationList.innerHTML = '<p>No new notifications.</p>';
            } else {
                notifications.forEach(n => {
                    const item = document.createElement('div');
                    item.className = 'notification-item';
                    item.innerHTML = `<div class="notification-title">${n.title}</div><div class="notification-message">${n.message}</div><div class="notification-time">${new Date(n.createdAt).toLocaleString()}</div>`;
                    notificationList.appendChild(item);
                });
            }
            fetch('/api/notifications/mark-read', { method: 'POST' });
            notifications.forEach(n => n.isRead = true);
            updateNotificationBadge();
        };

        async function fetchAdminNotifications() {
            try {
                const response = await fetch('/api/admin/notifications');
                if (!response.ok) throw new Error('Could not fetch notifications.');
                notifications = await response.json();
                if (document.getElementById('notifications-content').classList.contains('active')) {
                    renderNotifications();
                }
                updateNotificationBadge();
            } catch (error) {
                console.error(error);
                showToast(error.message);
            }
        }
             
        async function fetchHistoryLogs() {
            try {
                const response = await fetch('/api/admin/history');
                if (!response.ok) throw new Error('Failed to fetch history logs.');
                allHistoryLogs = await response.json();
                     
                const actions = [...new Set(allHistoryLogs.map(log => log.action))];
                historyActionFilter.innerHTML = '<option value="All">All Actions</option>';
                actions.sort().forEach(action => {
                    const option = document.createElement('option');
                    option.value = action;
                    option.textContent = action;
                    historyActionFilter.appendChild(option);
                });

                renderHistoryLogs();
            } catch (error) {
                showToast(error.message);
            }
        }

        function renderHistoryLogs() {
            const tableBody = document.getElementById('historyTableBody');
            const selectedAction = historyActionFilter.value;

            const logs = selectedAction === 'All'
                ? allHistoryLogs
                : allHistoryLogs.filter(log => log.action === selectedAction);

            tableBody.innerHTML = '';
            if (logs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No history found for this filter.</td></tr>';
                return;
            }
            logs.forEach(log => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${log.adminUsername}</td>
                    <td>${log.action}</td>
                    <td>${log.details}</td>
                    <td>${new Date(log.timestamp).toLocaleString()}</td>
                `;
            });
        }

window.openEditModal = (type, itemId, itemIds = [itemId]) => {
    const config = inventoryTypes[type];
    const itemsToEdit = config.store.filter(i => itemIds.includes(i.itemId));
    const item = itemsToEdit[0];

    if (!item) return;

    const totalQuantityToShow = itemsToEdit.reduce((sum, currentItem) => {
        return sum + (currentItem.originalQuantity || currentItem.quantity || 0);
    }, 0);

    document.getElementById('editModalTitle').innerText = `Edit ${type} Model: ${item.name}`;
    
    // Generate location dropdown based on category
    let locationOptions = '';
    if (item.category === 'Science') {
        locationOptions = '<option value="ROOM 143" ' + (item.location === 'ROOM 143' ? 'selected' : '') + '>ROOM 143</option>';
    } else if (item.category === 'Sports') {
        locationOptions = '<option value="ROOM 212" ' + (item.location === 'ROOM 212' ? 'selected' : '') + '>ROOM 212</option>';
    }
    
    editForm.innerHTML = `
            <input type="hidden" id="editItemId" value="${item.itemId}">
            <input type="hidden" id="editItemType" value="${type}">
            <label for="editItemName">Equipment Name</label><input type="text" id="editItemName" value="${item.name}" required />
            <label for="editCategory">Category</label><input type="text" id="editCategory" value="${item.category}" readonly />
            <label for="editQuantity" style="display:none;">Total Quantity</label><input type="hidden" id="editQuantity" value="${totalQuantityToShow}" />
            <label for="editLocation">Location</label><select id="editLocation" required>${locationOptions}</select>
            <button type="submit">Save Changes</button>`;
    editForm.dataset.type = 'inventory';
    editForm.dataset.itemIds = itemIds.join(',');
    editForm.onsubmit = handleUpdateItem;
    editModal.style.display = 'flex';
};
             
        window.openEditRequestModal = (requestId) => {
            const request = allRequestsData.find(r => r._id === requestId);
            if (request) {
                document.getElementById('editModalTitle').innerText = 'Edit Request';
                editForm.innerHTML = `
                    <input type="hidden" id="editRequestId" value="${request._id}">
                    <label for="editItemName">Item Name</label><input type="text" id="editItemName" value="${request.itemName}" required />
                    <label for="editQuantity" style="display:none;">Quantity</label><input type="hidden" id="editQuantity" value="${request.quantity}" />
                    <label for="editReason">Reason</label><textarea id="editReason" required>${request.reason}</textarea>
                    <label for="editStartDate">Start Date</label><input type="date" id="editStartDate" value="${request.startDate ? new Date(request.startDate).toISOString().split('T')[0] : ''}" required />
                    <label for="editDueDate">Due Date</label><input type="date" id="editDueDate" value="${request.dueDate ? new Date(request.dueDate).toISOString().split('T')[0] : ''}" required />
                    <button type="submit">Save Changes</button>`;
                editForm.dataset.type = 'request';
                delete editForm.dataset.itemIds;
                editForm.onsubmit = handleUpdateItem;
                editModal.style.display = 'flex';
            }
        };

        window.openStatusEditModal = (requestId) => {
            const request = allRequestsData.find(r => r._id === requestId);
            if (request) {
                document.getElementById('statusRequestId').value = request._id;
                document.getElementById('statusSelect').value = request.status;
                statusEditModal.style.display = 'flex';
            }
        };

        window.openViewRequestDetailsModal = (requestId) => {
            const request = allRequestsData.find(r => r._id === requestId);
            if (!request) {
                showToast('Request not found.', 'error');
                return;
            }

            const modal = document.getElementById('viewRequestDetailsModal');
            const content = document.getElementById('viewRequestDetailsContent');
            
            const startDate = request.startDate ? new Date(request.startDate).toLocaleDateString() : 'N/A';
            const dueDate = request.dueDate ? new Date(request.dueDate).toLocaleDateString() : 'N/A';
            const requestDate = request.requestDate ? new Date(request.requestDate).toLocaleDateString() : 'N/A';
            const returnDate = request.returnDate ? new Date(request.returnDate).toLocaleDateString() : 'N/A';
            const statusClass = request.status.replace(/[^a-zA-Z0-9]/g, '');

            content.innerHTML = `
                <div style="display: grid; gap: 1rem;">
                    <div>
                        <strong>Student Name:</strong> ${request.studentName || 'N/A'}
                    </div>
                    <div>
                        <strong>Student ID:</strong> ${request.studentId || request.studentID || 'N/A'}
                    </div>
                    <div>
                        <strong>Item ID:</strong> ${request.itemId || 'N/A'}
                    </div>
                    <div>
                        <strong>Item Name:</strong> ${request.itemName || 'N/A'}
                    </div>
                    <div>
                        <strong>Category:</strong> ${request.category || 'N/A'}
                    </div>
                    <div>
                        <strong>Quantity:</strong> ${request.quantity || 'N/A'}
                    </div>
                    <div>
                        <strong>Reason:</strong> ${request.reason || 'N/A'}
                    </div>
                    <div>
                        <strong>Start Date:</strong> ${startDate}
                    </div>
                    <div>
                        <strong>Due Date:</strong> ${dueDate}
                    </div>
                    <div>
                        <strong>Request Date:</strong> ${requestDate}
                    </div>
                    ${request.returnDate ? `<div><strong>Return Date:</strong> ${returnDate}</div>` : ''}
                    <div>
                        <strong>Status:</strong> <span class="status-badge status-${statusClass}">${request.status}</span>
                    </div>
                    ${request.returnCondition ? `<div><strong>Return Condition:</strong> ${request.returnCondition}</div>` : ''}
                    ${request.damageNotes ? `<div><strong>Damage/Loss Notes:</strong> ${request.damageNotes}</div>` : ''}
                    ${request.adminNotes ? `<div><strong>Admin Notes:</strong> ${request.adminNotes}</div>` : ''}
                </div>
            `;

            modal.style.display = 'flex';
        };

        window.closeViewRequestDetailsModal = () => {
            document.getElementById('viewRequestDetailsModal').style.display = 'none';
        };

        window.archiveInventoryItem = async (type, itemId) => {
            if (!confirm(`Are you sure you want to archive item ${itemId}?`)) return;
            try {
                const response = await fetch(`${inventoryTypes[type].api}/${itemId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Failed to archive item');
                showToast('Item archived successfully.');
                fetchInventory(type);
            } catch (error) { showToast(`Error: ${error.message}`); }
        };

        window.restoreInventoryItem = async (itemId) => {
            if (!confirm('Are you sure you want to restore this item?')) return;
            try {
                const res = await fetch(`/api/inventory/restore/${itemId}`, { method: 'PUT' });
                const result = await res.json();
                if (!res.ok) throw new Error(result.message);
                showToast(result.message);
                fetchArchivedInventory();
            } catch (error) { showToast(`Error: ${error.message}`); }
        };

        window.deleteInventoryItemPermanently = async (itemId) => {
            if (!confirm('WARNING: This will permanently delete the item and all its history. Are you sure?')) return;
            try {
                const res = await fetch(`/api/inventory/permanent/${itemId}`, { method: 'DELETE' });
                const result = await res.json();
                if (!res.ok) throw new Error(result.message);
                showToast(result.message);
                fetchArchivedInventory();
            } catch (error) { showToast(`Error: ${error.message}`); }
        };

        // --- MODIFIED: updateStatus (from admin4) ---
        window.updateStatus = async (type, selectElement, itemId) => {
            const newStatus = selectElement.value;
            const currentItem = inventoryTypes[type].store.find(i => i.itemId === itemId);
            if (!currentItem) return;

            const originalQty = currentItem.originalQuantity || currentItem.quantity || 0;
            const borrowedQty = originalItem.originalQuantity - (currentItem.quantity || 0);
                 
            if (newStatus === 'In-Use' || (borrowedQty > 0 && newStatus !== 'In-Use')) {
                showToast("Status 'In-Use' is set automatically. To change status, all items must be returned first.");
                const actualStatus = borrowedQty > 0 ? 'In-Use' : (currentItem.status || 'Available');
                selectElement.value = actualStatus;
                return;
            }
                 
            try {
                const isNowAvailable = newStatus === 'Available';
                const isNowUnavailable = ['Maintenance', 'Calibration', 'Damaged'].includes(newStatus);
                     
                const updateData = {
                    status: newStatus,
                    quantity: isNowUnavailable ? 0 : (isNowAvailable ? currentItem.originalQuantity : currentItem.quantity)
                };

                const response = await fetch(`${inventoryTypes[type].api}/${itemId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                if (!response.ok) throw new Error('Failed to update status');
                showToast(`Status for ${itemId} updated to ${newStatus}.`);
                selectElement.className = `status-select status-${newStatus.replace(/[^a-zA-Z0-9]/g, '')}`;
                fetchInventory(type);
            } catch (error) {
                showToast(`Error: ${error.message}`);
                fetchInventory(type);
            }
        };
             
        window.showToast = (message) => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 3000);
        };

        // --- 12. Reports Feature ---
        const reportTypeSelect = document.getElementById('reportType');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const reportResult = document.getElementById('reportResult');
        const printReportBtn = document.getElementById('printReportBtn');
        const inventoryCategoryGroup = document.getElementById('inventoryCategoryGroup');
        const inventoryCategorySelect = document.getElementById('inventoryCategory');
        let selectedPeriod = 'daily';
        
        // Show/hide inventory category dropdown based on report type
        reportTypeSelect.addEventListener('change', () => {
            const reportType = reportTypeSelect.value;
            // Show category dropdown for reports that need inventory filtering
            if (reportType === 'inventory' || reportType === 'requests' || reportType === 'usage' || reportType === 'accountability') {
                inventoryCategoryGroup.style.display = 'block';
            } else {
                inventoryCategoryGroup.style.display = 'none';
            }
        });
        
        const periodBtns = document.querySelectorAll('.period-btn');
        periodBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                periodBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedPeriod = btn.id.replace('Btn', '');
            });
        });

        generateReportBtn.addEventListener('click', async () => {
            const selectedReportType = reportTypeSelect.value;
            reportResult.style.display = 'none';
            printReportBtn.style.display = 'none';
            if (!selectedReportType) {
                showToast('Please select a report type.');
                return;
            }
                 
            try {
                await fetch('/api/reports', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reportType: selectedReportType })
                });
            } catch (e) { console.error("Failed to log report generation", e); }


            showToast('Generating report...');

            try {
                const now = new Date();
                let startDate;
                switch(selectedPeriod) {
                    case 'daily': startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()); break;
                    case 'weekly': const day = now.getDay(); startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - (day === 0 ? 6 : day - 1)); break;
                    case 'yearly': startDate = new Date(now.getFullYear(), 0, 1); break;
                    default: startDate = new Date(0);
                }
                     
                const startDateStr = startDate.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric' });
                const endDateStr = now.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric' });

                // Get selected inventory category (default to "All" if not applicable)
                const selectedCategory = inventoryCategorySelect ? inventoryCategorySelect.value : 'All';
                const categoryLabel = selectedCategory === 'All' ? 'Science & Sports' : selectedCategory;
                
                let reportText = `<b>Report Type:</b> ${reportTypeSelect.options[reportTypeSelect.selectedIndex].text} (${selectedPeriod})<br>`;
                reportText += `<b>Date Range:</b> ${startDateStr} - ${endDateStr}<br>`;
                if (selectedCategory !== 'All') {
                    reportText += `<b>Category:</b> ${categoryLabel}<br>`;
                }
                reportText += `<br>`;
                     
                // This data is specific to Admin 2 (Science & Sports)
                const inventoryDataArrays = await Promise.all(
                    Object.values(inventoryTypes).map(type => fetch(type.api).then(res => res.json()))
                );
                let allInventory = [].concat(...inventoryDataArrays);
                
                // Filter inventory by selected category
                if (selectedCategory !== 'All') {
                    allInventory = allInventory.filter(item => item.category === selectedCategory);
                }
                
                const requestsResponse = await fetch('/api/admin2-requests');
                if (!requestsResponse.ok) throw new Error('Failed to fetch requests');
                let allRequests = await requestsResponse.json();
                
                // Filter requests by selected category
                if (selectedCategory !== 'All') {
                    allRequests = allRequests.filter(req => req.category === selectedCategory);
                }
                     
                const filteredRequests = allRequests.filter(r => new Date(r.requestDate) >= startDate);
                const filteredReturnedRequests = allRequests.filter(r => r.status === 'Returned' && new Date(r.requestDate) >= startDate);

                if (selectedReportType === 'inventory') {
                    const totalItems = allInventory.reduce((sum, i) => sum + (i.originalQuantity || i.quantity || 0), 0);
                    const availableItems = allInventory.reduce((sum, i) => sum + (i.quantity || 0), 0);
                    const inUseItems = totalItems - availableItems;
                    // --- MODIFIED: Include Damaged & Calibration ---
                    const maintenanceItems = allInventory.filter(i => i.status === 'Maintenance' || i.status === 'Damaged' || i.status === 'Calibration').length;
                    reportText += `<b>Summary (${categoryLabel}):</b><br>`;
                    reportText += `Total Items: ${totalItems}<br>`;
                    reportText += `Available Items: ${availableItems}<br>`;
                    reportText += `Items In Use: ${inUseItems}<br>`;
                    reportText += `Items Under Maintenance/Damaged/Calibration: ${maintenanceItems}<br><br>`;
                    reportText += `<table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; width: 100%;">`;
                    reportText += `<thead><tr><th>ID</th><th>Name</th><th>Category</th><th>Total Quantity</th><th>Borrowed</th><th>Available</th><th>Location</th><th>Status</th></tr></thead><tbody>`;
                    allInventory.forEach(item => {
                        const originalQty = item.originalQuantity || item.quantity || 0;
                        const availableQty = item.quantity || 0;
                        const borrowedQty = originalQty - availableQty;
                        const displayStatus = borrowedQty > 0 ? 'In-Use' : (item.status || 'Available');
                        reportText += `<tr><td>${item.itemId}</td><td>${item.name}</td><td>${item.category}</td><td>${originalQty}</td><td>${borrowedQty}</td><td>${availableQty}</td><td>${item.location}</td><td>${displayStatus}</td></tr>`;
                    });
                    reportText += `</tbody></table>`;
                } else if (selectedReportType === 'requests') {
                    reportText += `<b>Summary (${categoryLabel}):</b><br>`;
                    reportText += `Pending: ${filteredRequests.filter(r => r.status === 'Pending').length}<br>`;
                    reportText += `Approved: ${filteredRequests.filter(r => r.status === 'Approved').length}<br>`;
                    reportText += `Rejected: ${filteredRequests.filter(r => r.status === 'Rejected').length}<br>`;
                    reportText += `Returned: ${filteredRequests.filter(r => r.status === 'Returned').length}<br><br>`;
                    reportText += `<table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; width: 100%;">`;
                    reportText += `<thead><tr><th>Requester</th><th>Item</th><th>Quantity</th><th>Status</th><th>Date</th></tr></thead><tbody>`;
                    filteredRequests.forEach(req => {
                        reportText += `<tr><td>${req.studentName}</td><td>${req.itemName}</td><td>${req.quantity}</td><td>${req.status}</td><td>${new Date(req.requestDate).toLocaleDateString()}</td></tr>`;
                    });
                    reportText += `</tbody></table>`;
                } else if (selectedReportType === 'usage') {
                    const approvedRequestsInPeriod = filteredRequests.filter(r => r.status === 'Approved');
                    const usageMap = {};
                    approvedRequestsInPeriod.forEach(req => {
                        usageMap[req.itemName] = (usageMap[req.itemName] || 0) + req.quantity;
                    });
                    reportText += `<b>Summary (${categoryLabel}):</b><br>Total Items Borrowed (Approved) in Period: ${approvedRequestsInPeriod.reduce((sum, r) => sum + r.quantity, 0)}<br><br>`;
                    reportText += `<b>Most Used Items:</b><br>`;
                    reportText += `<table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; width: 100%;">`;
                    reportText += `<thead><tr><th>Item Name</th><th>Quantity Borrowed</th></tr></thead><tbody>`;
                    const usageData = Object.entries(usageMap).sort((a,b) => b[1] - a[1]);
                    if(usageData.length === 0) {
                        reportText += `<tr><td colspan="2" style="text-align:center;">No items approved for borrowing in this period.</td></tr>`;
                    } else {
                        usageData.forEach(([name, count]) => {
                            reportText += `<tr><td>${name}</td><td>${count}</td></tr>`;
                        });
                    }
                    reportText += `</tbody></table>`;
                } else if (selectedReportType === 'registeredStudents') {
                    // Re-fetch users for the report, as 'allUsersData' might be stale
                    const usersResponse = await fetch('/api/all-users');
                    if (!usersResponse.ok) throw new Error('Failed to fetch users for report.');
                    const reportUsersData = await usersResponse.json();

                    const filteredUsers = reportUsersData.filter(user => {
                        if (user.role !== 'student') return false;
                        const registrationDate = new Date(parseInt(user._id.substring(0, 8), 16) * 1000);
                        return registrationDate >= startDate;
                    });

                    reportText += `<b>Total New Students: ${filteredUsers.length}</b><br><br>`;
                    reportText += `<table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; width: 100%;">`;
                    reportText += `<thead><tr><th>Full Name</th><th>Student ID</th><th>Email</th><th>Registration Date</th></tr></thead><tbody>`;
                    filteredUsers.forEach(user => {
                        const regDate = new Date(parseInt(user._id.substring(0, 8), 16) * 1000).toLocaleDateString();
                        reportText += `<tr><td>${user.firstName} ${user.lastName}</td><td>${user.studentID}</td><td>${user.email}</td><td>${regDate}</td></tr>`;
                    });
                    reportText += `</tbody></table>`;
                         
                } else if (selectedReportType === 'accountability') {
                    const accountabilityMap = filteredReturnedRequests.reduce((acc, req) => {
                        const studentId = req.studentId;
                        if (!acc[studentId]) {
                            acc[studentId] = { studentName: req.studentName, totalReturned: 0, damaged: 0, good: 0, incidents: [] };
                        }
                        const isDamagedOrLost = req.returnCondition === 'Damaged' || req.returnCondition === 'Lost';
                        const conditionKey = isDamagedOrLost ? 'damaged' : 'good';
                        acc[studentId][conditionKey] += req.quantity;
                        acc[studentId].totalReturned += req.quantity;

                        if (isDamagedOrLost) {
                            acc[studentId].incidents.push({
                                itemName: req.itemName,
                                condition: req.returnCondition,
                                notes: req.damageNotes || 'No notes provided.',
                                date: new Date(req.requestDate).toLocaleDateString()
                            });
                        }
                        return acc;
                    }, {});

                    const accountabilityData = await fetch('/api/reports/user-accountability').then(res => res.json());
                    const adminCategories = selectedCategory === 'All' ? ['Science', 'Sports'] : [selectedCategory];
                    const relevantStudentIds = new Set(allRequests.map(r => r.studentId.toString()));
                    const filteredAccountabilityData = accountabilityData.filter(acc => relevantStudentIds.has(acc.studentId.toString()));

                    reportText += `<b>Summary (${categoryLabel}):</b><br>Total Items Returned in Period: ${filteredReturnedRequests.reduce((sum, r) => sum + r.quantity, 0)}<br><br>`;
                    reportText += `<h2>User Accountability Report Summary (Time-Filtered Returns)</h2>`;
                    reportText += `<p>Data reflects the quantity of items marked 'Returned' in the selected period, grouped by condition.</p><br>`;
                    reportText += `<table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; width: 100%;">`;
                    reportText += `<thead><tr><th>Student Name</th><th>Total Returned</th><th style="color:var(--success);">Returned Good</th><th style="color:var(--danger);">Damaged/Lost</th></tr></thead><tbody>`;
                         
                    const finalData = Object.values(accountabilityMap).sort((a, b) => a.studentName.localeCompare(b.studentName));
                         
                    if (finalData.length === 0) {
                        reportText += `<tr><td colspan="4" style="text-align:center;">No items were returned during this period.</td></tr>`;
                    } else {
                        finalData.forEach(student => {
                            reportText += `<tr>
                                <td>${student.studentName}</td>
                                <td>${student.totalReturned}</td>
                                <td style="color:var(--success); font-weight:600;">${student.good}</td>
                                <td style="color:var(--danger); font-weight:600;">${student.damaged}</td>
                            </tr>`;
                            if (student.incidents && student.incidents.length > 0) {
                                reportText += `
                                <tr style="background-color: ${body.classList.contains('dark') ? '#343a40' : '#f8f9fa'};">
                                    <td colspan="4" style="padding-left: 30px; border-bottom: none;">
                                        <details open>
                                            <summary style="font-weight: 600; color: var(--danger);">View Damaged/Lost Items (${student.incidents.length} items)</summary>
                                            <table style="width: 95%; margin: 10px 0; border: 1px solid var(--border-light);">
                                                <thead>
                                                    <tr style="font-size: 0.8rem;">
                                                        <th style="width: 30%; background-color: #fcebeb; color: var(--text-dark);">Item Name</th>
                                                        <th style="width: 15%; background-color: #fcebeb; color: var(--text-dark);">Condition</th>
                                                        <th style="width: 45%; background-color: #fcebeb; color: var(--text-dark);">Notes</th>
                                                        <th style="width: 10%; background-color: #fcebeb; color: var(--text-dark);">Date</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${student.incidents.map(inc => `
                                                        <tr>
                                                            <td>${inc.itemName}</td>
                                                            <td style="color: ${inc.condition === 'Lost' ? 'var(--danger)' : 'var(--warning)'}; font-weight: 600;">${inc.condition}</td>
                                                            <td>${inc.notes}</td>
                                                            <td>${inc.date}</td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </details>
                                    </td>
                                </tr>`;
                            }
                        });
                    }
                    reportText += `</tbody></table>`;
                         
                    reportText += `<br><h2>All-Time Pending Incidents Summary (${categoryLabel})</h2>`;
                    reportText += `<p>This table shows all students with **currently pending** (unresolved) damaged/lost item incidents from ${selectedCategory === 'All' ? 'your categories' : 'the ' + selectedCategory + ' category'}.</p><br>`;
                    reportText += `<table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; width: 100%;">`;
                    reportText += `<thead><tr><th>Student Name</th><th>Pending Incidents</th></tr></thead><tbody>`;
                         
                    const pendingIncidents = filteredAccountabilityData.filter(s => s.pendingIncidents > 0);
                    if (pendingIncidents.length === 0) {
                        reportText += `<tr><td colspan="2" style="text-align:center;">No pending incidents found for your categories.</td></tr>`;
                    } else {
                        pendingIncidents.forEach(student => {
                            reportText += `<tr><td>${student.studentName}</td><td style="color:var(--danger); font-weight:600;">${student.pendingIncidents}</td></tr>`;
                        });
                    }
                    reportText += `</tbody></table>`;
                }
                     
                reportResult.innerHTML = reportText;
                reportResult.style.display = 'block';
                printReportBtn.style.display = 'inline-block';
                showToast('Report generated.');
            } catch (error) { showToast(`Error generating report: ${error.message}`); }
        });


        printReportBtn.addEventListener('click', () => {
            const reportContent = reportResult.innerHTML;
            const selectedReportText = reportTypeSelect.options[reportTypeSelect.selectedIndex].text;
                 
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            printWindow.document.write(`
                <html>
                <head>
                    <title>LabLinX Report - ${selectedReportText}</title>
                    <style>
                        body { font-family: 'Times New Roman', serif; padding: 20px; font-size: 11pt; }
                        table { border-collapse: collapse; width: 100%; margin-top: 15px; font-size: 10pt; }
                        th, td { border: 1px solid #000; padding: 6px; text-align: left; }
                        th { background-color: #f0f0f0; color: #000; font-weight: bold; text-transform: uppercase; }
                        b { color: #000; }
                        .report-header { text-align: center; margin-bottom: 25px; }
                        .report-header img { width: 80px; height: 80px; margin-bottom: 10px; }
                        .report-header h2 { margin: 0; font-size: 18pt; color: #00503B; font-weight: bold; }
                        .report-header h3 { margin: 5px 0 0 0; font-size: 14pt; color: #007A5A; }
                        .report-info { text-align: left; margin-top: 15px; border-bottom: 2px solid #000; padding-bottom: 10px; }
                        .report-info b { font-weight: 700; }
                    </style>
                </head>
                <body>
                    <div class="report-header">
                        <img src="logo.png" alt="DLSU-D HS Logo">
                        <h2>De La Salle University - Dasmarias</h2>
                        <h3>LabLinX Inventory Management System</h3>
                    </div>
                    <div class="report-info">
                        <b>GENERATED REPORT:</b> ${selectedReportText.toUpperCase()}<br>
                        <b>DATE GENERATED:</b> ${new Date().toLocaleString()}<br>
                    </div>
                    ${reportContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.onload = () => {
                printWindow.print();
                printWindow.onafterprint = () => printWindow.close();
            };
        });

        

        // --- NEW FUNCTION: To toggle visibility of grouped rows ---
window.toggleGroup = (groupId) => {
    const detailRows = document.querySelectorAll(`.${groupId}`);
    const headerRow = document.getElementById(groupId + '-header');
    
    // Check the current state of the first detail row to decide action
    const isVisible = detailRows.length > 0 && detailRows[0].style.display !== 'none';
    
    detailRows.forEach(row => {
        row.style.display = isVisible ? 'none' : '';
    });
    
    // Update the arrow icon in the header
    const arrow = headerRow.cells[0].innerHTML.includes('') ? '' : '';
    headerRow.cells[0].innerHTML = headerRow.cells[0].innerHTML.replace(/[]/, arrow);
};
// --- NEW FUNCTION: Toggle all individual units within a specific collapsed group ---
window.toggleGroupUnits = (masterCheckbox, groupId, type) => {
    // 1. Get all individual checkboxes belonging to this group
    const individualCheckboxes = document.querySelectorAll(`.inventory-item-detail input[type="checkbox"][data-group-id="${groupId}"]`);
    
    // 2. Determine action and process selections
    const isChecking = masterCheckbox.checked;

    individualCheckboxes.forEach(cb => {
        cb.checked = isChecking;
        const itemId = cb.getAttribute('data-item-id');
        const index = selectedArchivedItems.indexOf(itemId);

        if (isChecking && index === -1) {
            selectedArchivedItems.push(itemId);
        } else if (!isChecking && index > -1) {
            selectedArchivedItems.splice(index, 1);
        }
    });

    // 3. Update the global "Select All" checkbox status and action bar
    updateMasterAndBulkActionUI();
};

// --- HELPER FUNCTION: Consolidates logic to update the top master checkbox ---
function updateMasterAndBulkActionUI() {
    renderBulkActionBar();
    
    const allUnits = document.querySelectorAll('.inventory-item-detail input[type="checkbox"]');
    const masterCheckbox = document.getElementById('checkAllUnits');
    
    if (masterCheckbox) {
        masterCheckbox.checked = allUnits.length > 0 && selectedArchivedItems.length === allUnits.length;
    }
}

// --- MODIFIED toggleItemSelection to update master checkbox status ---
window.toggleItemSelection = (itemId) => {
    const index = selectedArchivedItems.indexOf(itemId);
    if (index > -1) {
        selectedArchivedItems.splice(index, 1); // Deselect
    } else {
        selectedArchivedItems.push(itemId); // Select
    }
    updateMasterAndBulkActionUI(); // Call the helper to update the UI globally
};

// --- MODIFIED toggleAllUnits to use the new helper ---
window.toggleAllUnits = (checkbox) => {
    const allUnitCheckboxes = document.querySelectorAll('.inventory-item-detail input[type="checkbox"]');
    selectedArchivedItems = []; 

    allUnitCheckboxes.forEach(cb => {
        cb.checked = checkbox.checked;
        if (checkbox.checked) {
            selectedArchivedItems.push(cb.getAttribute('data-item-id'));
        }
    });
    updateMasterAndBulkActionUI(); 
};

/// --- MODIFIED renderBulkActionBar and NEW bulkArchiveSelected ---

// Locate this inside the DOMContentLoaded block:

function renderBulkActionBar() {
    const actionBar = document.getElementById('bulkActionBar');
    const countSpan = document.getElementById('selectedCount');
    const restoreBtn = actionBar.querySelector('.btn-restore');
    const deleteBtn = actionBar.querySelector('.btn-delete-permanent');
    const count = selectedArchivedItems.length;

    countSpan.textContent = `${count} Item${count !== 1 ? 's' : ''} Selected`;
    actionBar.style.display = count > 0 ? 'flex' : 'none';

    if (isViewingInventoryArchive) {
        // Archive View: Restore and Permanent Delete
        restoreBtn.textContent = 'Bulk Restore';
        restoreBtn.onclick = window.bulkRestoreSelected; // Explicit global reference
        deleteBtn.textContent = 'Delete Permanently';
        deleteBtn.onclick = window.bulkDeleteSelected; // Explicit global reference
        restoreBtn.style.backgroundColor = 'var(--info)';
        deleteBtn.style.display = 'inline-block'; // Ensure delete button is visible
    } else {
        // Active View: Bulk Archive
        restoreBtn.textContent = 'Bulk Archive';
        restoreBtn.onclick = window.bulkArchiveSelected; // Explicit global reference
        deleteBtn.textContent = 'Cancel Selection';
        deleteBtn.onclick = () => {
             selectedArchivedItems = [];
             document.querySelectorAll('.inventory-item-detail input[type="checkbox"]').forEach(cb => cb.checked = false);
             const masterCheckbox = document.getElementById('checkAllUnits');
             if (masterCheckbox) masterCheckbox.checked = false;
             window.updateMasterAndBulkActionUI();
             window.showToast('Selection cancelled.', 'warning');
        };
        restoreBtn.style.backgroundColor = 'var(--danger)';
        deleteBtn.style.display = 'inline-block';
    }
}

window.toggleAllUnits = (checkbox) => {
    const allUnitCheckboxes = document.querySelectorAll('.inventory-item-detail input[type="checkbox"]');
    selectedArchivedItems = []; // Start fresh

    allUnitCheckboxes.forEach(cb => {
        // Only select items that are visible/currently rendered
        if (checkbox.checked) {
            cb.checked = true;
            selectedArchivedItems.push(cb.getAttribute('data-item-id'));
        } else {
            cb.checked = false;
        }
    });
    renderBulkActionBar();
};

window.bulkArchiveSelected = async () => {
    if (selectedArchivedItems.length === 0) return showToast('No items selected.', 'warning');
    if (!confirm(`Are you sure you want to ARCHIVE ${selectedArchivedItems.length} item(s)? They will be moved to the Archive View.`)) return;

    try {
        let successfulArchives = 0;
        const firstItemId = selectedArchivedItems[0];
        let targetType = '';
        for (const type in inventoryTypes) {
            // Find the model to determine the correct API route
            if (inventoryTypes[type].store.some(i => i.itemId === firstItemId)) {
                targetType = type;
                break;
            }
        }
        
        if (!targetType) return showToast('Error: Could not determine item category for bulk archive.', 'error');
        
        // Loop and archive each selected item individually
        for (const itemId of selectedArchivedItems) {
            const response = await fetch(`${inventoryTypes[targetType].api}/${itemId}`, { method: 'DELETE' });
            if (response.ok) {
                successfulArchives++;
            }
        }
        
        showToast(`Successfully archived ${successfulArchives} item(s).`, 'success');
        fetchInventory(targetType); // Refresh the active inventory view
    } catch (error) {
        showToast('Error during bulk archiving. Check console.', 'error');
    }
};

// --- Your existing bulkRestoreSelected and bulkDeleteSelected should remain the same ---
// --- FIX: Updated handleModelArchiveClick for correct dispatch ---
window.handleModelArchiveClick = (event, itemId, groupName, type) => {
    event.stopPropagation(); // Prevents row collapse
    
    if (isViewingInventoryArchive) {
        restoreInventoryItem(itemId); 
        
    } else {
        archiveInventoryModel(itemId, groupName, type);
    }
};

window.handleModelDeleteClick = (event, itemId, groupName, type) => {
    event.stopPropagation(); // Prevents row collapse
    deleteInventoryModelPermanently(itemId, groupName, type);
};

window.handleModelEditClick = (event, type, itemId) => {
    event.stopPropagation(); // Prevents row collapse
    const button = event.currentTarget;
    const itemIdsAttr = button.getAttribute('data-item-ids');
    const itemIds = itemIdsAttr ? itemIdsAttr.split('|') : [itemId];
    openEditModal(type, itemId, itemIds);
};

// ... (Rest of your existing JavaScript follows)
             
        // --- 13. WEBSOCKET REAL-TIME REFRESH ---
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const host = window.location.host;
            const ws = new WebSocket(`${protocol}://${host}`);

            ws.onopen = () => {
                console.log('WebSocket Connected');
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    if (message.type === 'refresh') {
                        console.log('Refresh signal received from WebSocket');
                        showToast('Data refreshed in real-time.');
                        const activePage = document.querySelector('.page-content.active');
                        if (activePage) {
                            const pageId = activePage.id.replace('-content', '');
                            if (pageId === 'dashboard') {
                                updateSuperAdminDashboard();
                            } else if (pageId === 'inventory') {
                                if (isViewingInventoryArchive) { fetchArchivedInventory(); } else { for (const type in inventoryTypes) fetchInventory(type); }
                            } else if (pageId === 'requests') {
                                if (isViewingTrash) { fetchDeletedRequests(); } else { fetchAllRequests(); }
                            } else if (pageId === 'notifications') {
                                fetchAdminNotifications();
                            } else if (pageId === 'history') {
                                fetchHistoryLogs();
                            } else if (pageId === 'super-admin') {
                                loadSuperAdminData();
                            } else if (pageId === 'user-management') {
                                fetchAllUsers(); // Removed archive check
                            } else if (pageId === 'profile-requests') {
                                fetchProfileUpdateRequests();
                            } else if (pageId === 'registration-requests') {
                                fetchPendingRegistrations();
                            } else if (pageId === 'incident-reports') {
                                fetchIncidentReports();
                            } else {
                                // If no page is active, default to dashboard
                                updateSuperAdminDashboard();
                            }
                        } else {
                            // If no active page, refresh notifications
                            if (!activePage || activePage.id !== 'notifications-content') {
                                fetchAdminNotifications();
                            }
                        }
                    }
                } catch (e) {
                    console.error('Error processing WebSocket message:', e);
                }
            };

                ws.onclose = () => {
                    console.log('WebSocket Disconnected. Reconnecting in 3s...');
                    setTimeout(connectWebSocket, 3000);
                };

                ws.onerror = (err) => {
                    console.error('WebSocket Error:', err);
                    ws.close();
                };
            }

        window.fetchInventory = fetchInventory;
        window.fetchArchivedInventory = fetchArchivedInventory;

        // --- INCIDENT REPORTS FUNCTIONS ---
        let incidentReports = [];

        const fetchIncidentReports = async () => {
            try {
                const response = await fetch('/api/admin2/incident-reports');
                if (!response.ok) {
                    // Check if it's a 403 (permission denied) - don't show error for this
                    if (response.status === 403) {
                        incidentReports = [];
                        renderIncidentReports();
                        return;
                    }
                    const errorData = await response.json().catch(() => ({ message: 'Failed to load incident reports.' }));
                    throw new Error(errorData.message || 'Failed to load incident reports.');
                }
                const data = await response.json();
                incidentReports = Array.isArray(data) ? data : [];
                // Don't show notification if there are 0 reports - it's normal
                renderIncidentReports();
            } catch (error) {
                console.error('Error fetching incident reports:', error);
                // Only show error toast for actual server errors, not for empty results or permission issues
                if (error.message && !error.message.includes('403') && !error.message.includes('permission')) {
                    showToast(error.message || 'Failed to load incident reports.', 'error');
                }
                // Set empty array on error to prevent further issues
                incidentReports = [];
                renderIncidentReports();
            }
        };

        const renderIncidentReports = () => {
            const tbody = document.getElementById('incidentReportsTableBody');
            if (!tbody) return;
            
            // Ensure incidentReports is an array
            if (!Array.isArray(incidentReports)) {
                incidentReports = [];
            }
            
            const searchTerm = (document.getElementById('incidentSearch')?.value || '').toLowerCase();
            const statusFilter = document.getElementById('incidentStatusFilter')?.value || 'All';

            let filtered = incidentReports.filter((report) => {
                if (!report) return false;
                const matchesSearch = 
                    (report.studentName || '').toLowerCase().includes(searchTerm) ||
                    (report.studentID || '').toLowerCase().includes(searchTerm) ||
                    (report.itemId || '').toLowerCase().includes(searchTerm) ||
                    (report.itemName && report.itemName.toLowerCase().includes(searchTerm));
                const matchesStatus = statusFilter === 'All' || report.status === statusFilter;
                return matchesSearch && matchesStatus;
            });

            tbody.innerHTML = '';
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem;">No incident reports found.</td></tr>';
                return;
            }

            filtered.forEach((report) => {
                const row = tbody.insertRow();
                const dateOfIncident = report.dateOfIncident ? new Date(report.dateOfIncident).toLocaleDateString() : 'N/A';
                const dateSubmitted = report.dateSubmitted ? new Date(report.dateSubmitted).toLocaleDateString() + ' ' + new Date(report.dateSubmitted).toLocaleTimeString() : 'N/A';
                const statusClass = report.status === 'Pending Review' || report.status === 'Submitted' ? 'status-Pending' :
                                  report.status === 'Resolved' ? 'status-Approved' :
                                  report.status === 'Rejected' ? 'status-Rejected' : 'status-Returned';

                row.innerHTML = `
                    <td>${report.studentName}</td>
                    <td>${report.studentID}</td>
                    <td>${report.itemId}</td>
                    <td>${report.incidentType}</td>
                    <td>${dateOfIncident}</td>
                    <td>${dateSubmitted}</td>
                    <td><span class="status-badge ${statusClass}">${report.status}</span></td>
                    <td class="actions-cell">
                        ${report.status === 'Pending Review' || report.status === 'Submitted' ? `
                            <button class="btn btn-edit" onclick="openResolveModal('${report._id}')">View Details</button>
                            <button class="btn btn-delete" onclick="openRejectModal('${report._id}')">Reject</button>
                        ` : report.status === 'Resolved' || report.status === 'Rejected' ? `
                            <button class="btn btn-edit" onclick="openResolveModal('${report._id}')">View Details</button>
                        ` : ''}
                    </td>
                `;
            });
        };

        const openResolveModal = async (reportId) => {
            try {
                console.log('Opening resolve modal for report:', reportId);
                const response = await fetch(`/api/admin2/incident-reports/${reportId}`);
                
                if (!response.ok) {
                    let errorMessage = 'Failed to load report details.';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        errorMessage = `Server error: ${response.status} ${response.statusText}`;
                    }
                    console.error('API error:', response.status, errorMessage);
                    throw new Error(errorMessage);
                }
                
                const report = await response.json();
                console.log('Report data received:', report);

                // Check if required elements exist
                const reportIdInput = document.getElementById('resolve-report-id');
                const studentNameInput = document.getElementById('resolve-student-name');
                const itemNameInput = document.getElementById('resolve-item-name');
                const replacementItemInput = document.getElementById('resolve-replacement-item');
                const notesInput = document.getElementById('resolve-notes');
                const modal = document.getElementById('resolveIncidentModal');

                if (!reportIdInput || !studentNameInput || !itemNameInput || !replacementItemInput || !notesInput || !modal) {
                    console.error('Modal elements not found:', {
                        reportIdInput: !!reportIdInput,
                        studentNameInput: !!studentNameInput,
                        itemNameInput: !!itemNameInput,
                        replacementItemInput: !!replacementItemInput,
                        notesInput: !!notesInput,
                        modal: !!modal
                    });
                    throw new Error('Modal elements not found. Please refresh the page.');
                }

                // Safely access report data with fallbacks
                reportIdInput.value = reportId;
                studentNameInput.value = report.student?.name || 'Unknown Student';
                itemNameInput.value = report.item?.name && report.item?.itemId 
                    ? `${report.item.name} (${report.item.itemId})`
                    : report.item?.name || report.item?.itemId || 'N/A';
                
                // Check if report is already resolved or rejected
                const isResolved = report.status === 'Resolved';
                const isRejected = report.status === 'Rejected';
                const isReadOnly = isResolved || isRejected;
                
                if (isReadOnly) {
                    // For resolved/rejected reports, show read-only information
                    replacementItemInput.value = report.replacementItemId || 'N/A';
                    replacementItemInput.readOnly = true;
                    replacementItemInput.style.backgroundColor = '#f3f4f6';
                    notesInput.value = report.admin2ReviewNotes || 'N/A';
                    notesInput.readOnly = true;
                    notesInput.style.backgroundColor = '#f3f4f6';
                    
                    // Hide submit button
                    const submitBtn = modal.querySelector('button[type="submit"]');
                    if (submitBtn) submitBtn.style.display = 'none';
                    
                    // Update modal title
                    const modalTitle = modal.querySelector('.modal-header h2');
                    if (modalTitle) {
                        modalTitle.textContent = isResolved ? 'Resolved Incident Details' : 'Rejected Incident Details';
                    }
                } else {
                    // For pending reports, allow editing
                    replacementItemInput.value = '';
                    replacementItemInput.readOnly = false;
                    replacementItemInput.style.backgroundColor = '';
                    notesInput.value = '';
                    notesInput.readOnly = false;
                    notesInput.style.backgroundColor = '';
                    
                    // Show submit button
                    const submitBtn = modal.querySelector('button[type="submit"]');
                    if (submitBtn) submitBtn.style.display = 'inline-block';
                    
                    // Update modal title
                    const modalTitle = modal.querySelector('.modal-header h2');
                    if (modalTitle) {
                        modalTitle.textContent = 'Resolve Incident';
                    }
                }

                modal.style.display = 'flex';
                console.log('Modal opened successfully');
            } catch (error) {
                console.error('Error opening resolve modal:', error);
                showToast(error.message || 'Failed to load report details.', 'error');
            }
        };

        const closeResolveModal = () => {
            const modal = document.getElementById('resolveIncidentModal');
            const form = document.getElementById('resolveIncidentForm');
            const replacementItemInput = document.getElementById('resolve-replacement-item');
            const notesInput = document.getElementById('resolve-notes');
            const submitBtn = form?.querySelector('button[type="submit"]');
            const modalTitle = modal?.querySelector('.modal-header h2');
            
            // Reset form
            form?.reset();
            
            // Reset read-only states
            if (replacementItemInput) {
                replacementItemInput.readOnly = false;
                replacementItemInput.style.backgroundColor = '';
            }
            if (notesInput) {
                notesInput.readOnly = false;
                notesInput.style.backgroundColor = '';
            }
            
            // Reset submit button visibility
            if (submitBtn) submitBtn.style.display = 'inline-block';
            
            // Reset modal title
            if (modalTitle) modalTitle.textContent = 'Resolve Incident';
            
            modal.style.display = 'none';
        };

        window.openResolveModal = openResolveModal;
        window.closeResolveModal = closeResolveModal;
        window.fetchIncidentReports = fetchIncidentReports;
        
        const openRejectModal = async (reportId) => {
            try {
                console.log('Opening reject modal for report:', reportId);
                const response = await fetch(`/api/admin2/incident-reports/${reportId}`);
                
                if (!response.ok) {
                    let errorMessage = 'Failed to load report details.';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        errorMessage = `Server error: ${response.status} ${response.statusText}`;
                    }
                    console.error('API error:', response.status, errorMessage);
                    throw new Error(errorMessage);
                }
                
                const report = await response.json();
                console.log('Report data received:', report);

                // Check if required elements exist
                const reportIdInput = document.getElementById('reject-report-id');
                const studentNameInput = document.getElementById('reject-student-name');
                const itemNameInput = document.getElementById('reject-item-name');
                const notesInput = document.getElementById('reject-notes');
                const modal = document.getElementById('rejectIncidentModal');

                if (!reportIdInput || !studentNameInput || !itemNameInput || !notesInput || !modal) {
                    console.error('Modal elements not found:', {
                        reportIdInput: !!reportIdInput,
                        studentNameInput: !!studentNameInput,
                        itemNameInput: !!itemNameInput,
                        notesInput: !!notesInput,
                        modal: !!modal
                    });
                    throw new Error('Modal elements not found. Please refresh the page.');
                }

                // Safely access report data with fallbacks
                reportIdInput.value = reportId;
                studentNameInput.value = report.student?.name || 'Unknown Student';
                itemNameInput.value = report.item?.name && report.item?.itemId 
                    ? `${report.item.name} (${report.item.itemId})`
                    : report.item?.name || report.item?.itemId || 'N/A';
                notesInput.value = '';

                modal.style.display = 'flex';
                console.log('Reject modal opened successfully');
            } catch (error) {
                console.error('Error opening reject modal:', error);
                showToast(error.message || 'Failed to load report details.', 'error');
            }
        };

        const closeRejectModal = () => {
            document.getElementById('rejectIncidentModal').style.display = 'none';
            document.getElementById('rejectIncidentForm').reset();
        };

        window.openRejectModal = openRejectModal;
        window.closeRejectModal = closeRejectModal;
        window.rejectIncident = openRejectModal;

        document.getElementById('resolveIncidentForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const reportId = document.getElementById('resolve-report-id').value;
            const replacementItemId = document.getElementById('resolve-replacement-item').value;
            const resolutionNote = document.getElementById('resolve-notes').value;

            try {
                const response = await fetch(`/api/admin2/incident-reports/${reportId}/resolve`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ replacementItemId, resolutionNote }),
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Failed to resolve incident.');

                showToast('Incident resolved successfully!', 'success');
                closeResolveModal();
                await fetchIncidentReports();
            } catch (error) {
                console.error('Error resolving incident:', error);
                showToast(`Error: ${error.message}`, 'error');
            }
        });

        // Add event listeners for filters
        document.getElementById('incidentSearch')?.addEventListener('input', renderIncidentReports);
        document.getElementById('incidentStatusFilter')?.addEventListener('change', renderIncidentReports);

        // Close modal when clicking outside
        document.getElementById('resolveIncidentModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'resolveIncidentModal') {
                closeResolveModal();
            }
        });

        document.getElementById('rejectIncidentModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'rejectIncidentModal') {
                closeRejectModal();
            }
        });

        // Reject incident form submission
        document.getElementById('rejectIncidentForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const reportId = document.getElementById('reject-report-id').value;
            const rejectionNote = document.getElementById('reject-notes').value.trim();

            try {
                const response = await fetch(`/api/admin2/incident-reports/${reportId}/reject`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        rejectionNote: rejectionNote || 'Report rejected by Admin 2.' 
                    }),
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Failed to reject incident.');

                showToast('Incident rejected successfully!', 'success');
                closeRejectModal();
                await fetchIncidentReports();
            } catch (error) {
                console.error('Error rejecting incident:', error);
                showToast(`Error: ${error.message}`, 'error');
            }
        });

        // --- GO! ---
            initializeApp();
            connectWebSocket(); // --- ADDED ---
        });
</script>
</body>
</html>  

