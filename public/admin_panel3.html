<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Panel 3 - LabLinX DLSU-D</title>

    <style>
      /* --- 1. Global Styles & Variables (DLSU Theme from Admin Panel 2) --- */
      :root {
        --primary-dark: #00503b; /* DLSU Deep Green */
        --primary-light: #007a5a; /* DLSU Lighter Green */
        --accent-gold: #ffcd00; /* DLSU Gold */
        --text-light: #f8f9fa;
        --text-dark: #343a40;
        --background-light: #f4f6f9;
        --background-dark: #181a1f;
        --card-bg-light: #ffffff;
        --card-bg-dark: #212529;
        --border-light: #dee2e6;
        --border-dark: #495057;
        --success: #28a745;
        --danger: #dc3545;
        --warning: #f0ad4e;
        --info: #17a2b8;
        --calibration: #9370db; /* <-- ADDED FROM ADMIN 4 */
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --font-family: 'Avenir', 'Helvetica Neue', -apple-system,
          BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      }

      /* Chart Container styles */
      .chart-container {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 2rem;
        margin-top: 2rem;
      }
      .chart-card {
        background-color: var(--card-bg-light);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-light);
      }
      body.dark .chart-card {
        background-color: var(--card-bg-dark);
        border-color: var(--border-dark);
      }
      /* Reset & Base */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body,
      html {
        font-family: var(--font-family);
        background-color: var(--background-light);
        color: var(--text-dark);
        min-height: 100vh;
        overflow-x: hidden;
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      body.dark {
        background-color: var(--background-dark);
        color: var(--text-light);
      }
      a {
        text-decoration: none;
        color: inherit;
      }

      /* --- 2. Sidebar --- */
      #sidebar {
        width: 250px;
        background-color: var(--primary-dark);
        height: 100vh;
        color: var(--text-light);
        position: fixed;
        top: 0;
        left: 0;
        display: flex;
        flex-direction: column;
        padding: 1.5rem 0;
        z-index: 200;
        transition: width 0.3s ease;
        border-right: 1px solid var(--primary-light);
      }
      #sidebar .logo {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 2rem;
        padding: 0 1rem;
      }
      #sidebar .logo img {
        width: 70px;
        height: 70px;
        margin-bottom: 0.5rem;
        border-radius: 50%;
        cursor: pointer;
      }
      #sidebar .logo-title {
        color: var(--accent-gold);
        font-weight: 700;
        font-size: 1rem;
        opacity: 1;
        transition: opacity 0.2s ease;
      }
      #sidebar nav {
        display: flex;
        flex-direction: column;
        width: 100%;
        margin-top: 1rem;
        flex-grow: 1;
        overflow-y: auto;
      }
      #sidebar nav a {
        color: #e0e0e0;
        padding: 14px 25px;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 15px;
        transition: background-color 0.2s, color 0.2s, border-left-color 0.2s;
        border-left: 4px solid transparent;
        cursor: pointer;
      }
      #sidebar nav a .link-content {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      #sidebar nav a svg {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
      }
      #sidebar nav a:hover {
        background-color: var(--primary-light);
        color: var(--accent-gold);
      }
      #sidebar nav a.active {
        background-color: var(--accent-gold);
        color: var(--primary-dark);
        font-weight: 600;
        border-left-color: #fff;
      }
      .logout-link {
        margin-top: auto;
      }
      .notification-badge {
        background-color: var(--danger);
        color: white;
        font-size: 0.75rem;
        font-weight: bold;
        padding: 2px 7px;
        border-radius: 50%;
        display: none;
      }
      body.sidebar-collapsed #sidebar {
        width: 80px;
      }
      body.sidebar-collapsed .logo-title,
      body.sidebar-collapsed nav a span,
      body.sidebar-collapsed .notification-badge {
        display: none;
      }
      body.sidebar-collapsed nav a {
        justify-content: center;
      }

      /* --- 3. Header / Topbar --- */
      header {
        margin-left: 250px;
        height: 65px;
        background-color: var(--card-bg-light);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 2rem;
        box-shadow: var(--shadow);
        position: sticky;
        top: 0;
        z-index: 150;
        transition: margin-left 0.3s ease, background-color 0.3s ease;
        border-bottom: 1px solid var(--border-light);
      }
      body.dark header {
        background-color: var(--card-bg-dark);
        border-bottom-color: var(--border-dark);
      }
      body.sidebar-collapsed header {
        margin-left: 80px;
      }
      .header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      .toggle-btn {
        background: none;
        border: none;
        cursor: pointer;
        color: var(--text-dark);
      }
      body.dark .toggle-btn {
        color: var(--text-light);
      }
      .toggle-btn svg {
        width: 24px;
        height: 24px;
      }
      .top-actions {
        display: flex;
        align-items: center;
        gap: 1.5rem;
      }
      .dark-toggle {
        background: none;
        border: none;
        cursor: pointer;
        color: var(--text-dark);
      }
      body.dark .dark-toggle {
        color: var(--text-light);
      }
      .dark-toggle svg {
        width: 22px;
        height: 22px;
      }
      .profile img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid var(--primary-dark);
      }

      /* --- 4. Main Content --- */
      main {
        margin-left: 250px;
        padding: 2.5rem;
        transition: margin-left 0.3s ease;
      }
      body.sidebar-collapsed main {
        margin-left: 80px;
      }
      main h1 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: var(--primary-dark);
      }
      body.dark main h1 {
        color: var(--accent-gold);
      }
      .page-subtitle {
        margin-top: 0;
        margin-bottom: 2.5rem;
        font-size: 1.1rem;
        color: #6c757d;
        font-weight: 500;
      }
      body.dark .page-subtitle {
        color: #adb5bd;
      }
      .page-content {
        display: none;
      }
      .page-content.active {
        display: block;
      }

      /* --- 5. Dashboard Specific Styles --- */
      .dashboard-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 2rem;
      }
      .card {
        background-color: var(--card-bg-light);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: var(--shadow);
        transition: transform 0.25s ease, box-shadow 0.25s ease;
        border: 1px solid var(--border-light);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 180px;
      }
      body.dark .card {
        background-color: var(--card-bg-dark);
        border-color: var(--border-dark);
      }
      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }
      .card-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }
      .card-icon {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        display: grid;
        place-items: center;
      }
      .card-icon svg {
        width: 28px;
        height: 28px;
        color: #fff;
      }
      .icon-aqua {
        background-color: #1abc9c;
      }
      .icon-red {
        background-color: #e74c3c;
      }
      .icon-green {
        background-color: #2ecc71;
      }
      .card-header-text .title {
        font-weight: 600;
        font-size: 1rem;
      }
      .card-header-text .subtitle {
        font-size: 0.85rem;
        color: #6c757d;
      }
      body.dark .card-header-text .subtitle {
        color: #adb5bd;
      }
      .card-body .counter {
        font-size: 2.8rem;
        font-weight: 700;
        line-height: 1;
        color: var(--primary-dark);
      }
      body.dark .card-body .counter {
        color: var(--text-light);
      }
      .card-body .items {
        font-size: 0.9rem;
        margin-top: 4px;
        color: #6c757d;
      }
      body.dark .card-body .items {
        color: #adb5bd;
      }
      .card-footer {
        margin-top: 1.5rem;
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--primary-light);
        display: flex;
        align-items: center;
        gap: 5px;
      }
      body.dark .card-footer {
        color: var(--accent-gold);
      }

      /* --- 6. Inventory, Requests & Notifications Styles --- */
      .inventory-card {
        background-color: var(--card-bg-light);
        border-radius: 8px;
        width: 100%;
        padding: 1.5rem 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-light);
      }
      body.dark .inventory-card {
        background-color: var(--card-bg-dark);
        border-color: var(--border-dark);
      }
      .inventory-card h2 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        font-size: 1.5rem;
        color: var(--primary-dark);
        border-bottom: 1px solid var(--border-light);
        padding-bottom: 0.75rem;
      }
      body.dark .inventory-card h2 {
        color: var(--accent-gold);
        border-bottom-color: var(--border-dark);
      }
      .filter-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }
      .search-bar {
        flex-grow: 1;
        min-width: 250px;
      }
      .search-bar input,
      .filter-select select,
      .filter-row button {
        width: 100%;
        padding: 10px 15px;
        border-radius: 6px;
        border: 1px solid var(--border-light);
        font-size: 1rem;
        background-color: var(--card-bg-light);
        color: var(--text-dark);
        transition: all 0.3s ease;
      }
      .filter-row button {
        width: auto;
        cursor: pointer;
        font-weight: 600;
        background-color: #e9ecef;
        border-color: #ced4da;
      }
      .filter-row button:hover {
        background-color: #dde1e5;
      }
      body.dark .search-bar input,
      body.dark .filter-select select,
      body.dark .filter-row button {
        background-color: #2a2a2e;
        border-color: var(--border-dark);
        color: var(--text-light);
      }
      body.dark .filter-row button {
        background-color: #343a40;
        border-color: #495057;
      }
      body.dark .filter-row button:hover {
        background-color: #495057;
      }
      .search-bar input:focus,
      .filter-select select:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 80, 59, 0.25);
      }
      .filter-select {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }
      .filter-select label {
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--text-subtle);
      }
      body.dark .filter-select label {
        color: var(--text-subtle-dark-mode);
      }

      .add-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        align-items: flex-end;
      }
      .add-form input,
      .add-form select {
        padding: 8px 12px;
        border-radius: 5px;
        border: 1px solid var(--border-light);
        font-size: 0.95rem;
        width: 100%;
        background-color: var(--card-bg-light);
        color: var(--text-dark);
      }
      body.dark .add-form input,
      body.dark .add-form select {
        background-color: var(--card-bg-dark);
        border-color: var(--border-dark);
        color: var(--text-light);
      }
      .add-form button {
        background-color: var(--primary-dark);
        color: var(--accent-gold);
        padding: 9px 20px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.2s;
        white-space: nowrap;
      }
      .add-form button:hover {
        background-color: var(--primary-light);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
        table-layout: fixed;
      }
      table th,
      table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid var(--border-light);
        word-wrap: break-word;
      }
      body.dark table th,
      body.dark table td {
        border-bottom-color: var(--border-dark);
      }
      table th {
        background-color: var(--background-light);
        color: var(--primary-dark);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.5px;
      }
      body.dark table th {
        background-color: var(--background-dark);
        color: var(--text-light);
      }
      table tr:last-child td {
        border-bottom: none;
      }
      table tbody tr:hover {
        background-color: #fcf8e3;
      }
      body.dark table tbody tr:hover {
        background-color: #2c2f33;
      }
      table td .status-select {
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid var(--border-light);
        font-weight: 500;
        background: transparent;
        color: var(--text-dark);
      }
      body.dark table td .status-select {
        border-color: var(--border-dark);
        color: var(--text-light);
      }
      body.dark table td .status-select option {
        background-color: var(--card-bg-dark);
      }
      .status-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        color: #343a40;
        text-align: center;
      }
      .status-Available {
        background-color: rgba(46, 204, 113, 0.18);
        color: #000;
      }
      .status-In-Use {
        background-color: rgba(255, 193, 7, 0.22);
        color: #000;
      }
      .status-Maintenance,
      .status-Damaged {
        background-color: rgba(220, 53, 69, 0.22);
        color: #000;
      }
      .status-Calibration {
        background-color: rgba(147, 112, 219, 0.22);
        color: #000;
      }
      .status-Pending {
        background-color: var(--warning);
      }
      .status-Approved {
        background-color: var(--success);
      }
      .status-Rejected {
        background-color: var(--danger);
      }
      .status-Returned {
        background-color: #6c757d;
      }
      .status-Calibration {
        background-color: var(--calibration);
      } /* <-- ADDED FROM ADMIN 4 */
      .actions-cell {
        display: flex;
        gap: 10px;
        padding: 15px;
        width: auto;
        flex-wrap: wrap;
        justify-content: flex-start;
      }
      .btn {
        padding: 6px 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        transition: opacity 0.2s;
        white-space: nowrap;
      }
      .btn:hover {
        opacity: 0.85;
      }
      .btn svg {
        width: 14px;
        height: 14px;
      }
      .btn-edit {
        background-color: var(--success);
        color: white;
      }
      .btn-delete {
        background-color: var(--danger);
        color: white;
      }
      .btn-restore {
        background-color: var(--info);
        color: white;
      }
      .btn-delete-permanent {
        background-color: #8b0000;
        color: white;
        font-weight: 700;
      }
      .btn-delete-permanent:hover {
        background-color: #a52a2a;
      }
      #notification-list .notification-item {
        background-color: var(--card-bg-light);
        border-left: 5px solid var(--primary-light);
        margin-bottom: 1rem;
        padding: 1rem;
        border-radius: 5px;
        box-shadow: var(--shadow);
      }
      body.dark #notification-list .notification-item {
        background-color: var(--card-bg-dark);
        border-left-color: var(--accent-gold);
      }
      #notification-list .notification-title {
        font-weight: bold;
        color: var(--primary-dark);
        margin-bottom: 0.25rem;
      }
      body.dark #notification-list .notification-title {
        color: var(--accent-gold);
      }
      #notification-list .notification-message {
        color: #6c757d;
      }
      body.dark #notification-list .notification-message {
        color: #adb5bd;
      }
      #notification-list .notification-time {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.5rem;
        text-align: right;
      }
      body.dark #notification-list .notification-time {
        color: #adb5bd;
      }

      /* --- 7. Modal & Toast Styles --- */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background-color: var(--card-bg-light);
        margin: auto;
        padding: 25px;
        width: 90%;
        max-width: 500px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }
      body.dark .modal-content {
        background-color: var(--card-bg-dark);
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }
      .modal-header h2 {
        margin: 0;
        color: var(--primary-dark);
      }
      body.dark .modal-header h2 {
        color: var(--text-light);
      }
      .close-button {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }
      .close-button:hover,
      .close-button:focus {
        color: var(--text-dark);
      }
      body.dark .close-button:hover,
      body.dark .close-button:focus {
        color: var(--text-light);
      }
      .modal-content form {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      .modal-content form label {
        font-weight: 600;
        margin-bottom: -10px;
      }
      .modal-content form input,
      .modal-content form textarea,
      .modal-content form select {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-light);
        border-radius: 5px;
        background-color: var(--card-bg-light);
        color: var(--text-dark);
      }
      body.dark .modal-content form input,
      body.dark .modal-content form textarea,
      body.dark .modal-content form select {
        background-color: var(--card-bg-dark);
        border-color: var(--border-dark);
        color: var(--text-light);
      }
      .modal-content form button {
        background-color: var(--primary-dark);
        color: white;
        padding: 12px;
        border: none;
        border-radius: 5px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 1rem;
      }
      #toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .toast {
        padding: 12px 20px;
        background-color: var(--primary-dark);
        color: white;
        border-radius: 6px;
        box-shadow: var(--shadow);
      }

      /* ADDED STYLES for Return Condition Modal */
      #returnConditionModal .modal-header h2 {
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--primary-dark);
      }
      body.dark #returnConditionModal .modal-header h2 {
        color: var(--text-light);
      }
      #returnConditionForm select {
        appearance: none; /* Remove default arrow */
        background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 16px;
        padding-right: 30px !important;
        font-weight: 600;
      }
      .modal-content p strong {
        color: var(--primary-dark);
      }
      body.dark .modal-content p strong {
        color: var(--accent-gold);
      }
      /* END ADDED STYLES */

      /* --- 8. Responsive Design --- */
      @media screen and (max-width: 992px) {
        .chart-container {
          grid-template-columns: 1fr;
        }
      }
      @media screen and (max-width: 768px) {
        body:not(.sidebar-collapsed) #sidebar {
          width: 80px;
        }
        body:not(.sidebar-collapsed) .logo-title,
        body:not(.sidebar-collapsed) nav a span {
          display: none;
        }
        body:not(.sidebar-collapsed) nav a {
          justify-content: center;
        }
        header,
        main {
          margin-left: 80px;
        }
        main {
          padding: 1.5rem;
        }
      }
      @media screen and (max-width: 600px) {
        body {
          padding-bottom: 60px;
        }
        #sidebar {
          bottom: 0;
          top: auto;
          width: 100%;
          height: 60px;
          flex-direction: row;
          align-items: center;
          justify-content: space-around;
          border-top: 1px solid var(--border-light);
          padding: 0;
        }
        body.dark #sidebar {
          border-top-color: var(--border-dark);
        }
        #sidebar .logo {
          display: none;
        }
        #sidebar nav {
          margin-top: 0;
          flex-direction: row;
          width: 100%;
          justify-content: space-around;
        }
        #sidebar nav a {
          border-left: none;
          border-top: 4px solid transparent;
        }
        #sidebar nav a.active {
          border-top-color: #fff;
          border-left-color: transparent;
        }
        .logout-link {
          display: none;
        }
        header,
        main {
          margin-left: 0;
        }
      }

      /* --- Period Buttons --- */
      .period-btn {
        background-color: #f0f0f0;
        color: var(--primary-dark);
        padding: 8px 16px;
        border-radius: 5px;
        border: 1px solid var(--border-light);
        cursor: pointer;
        font-weight: 600;
        margin-right: 10px;
        transition: background-color 0.2s, color 0.2s;
      }
      .period-btn:hover,
      .period-btn.active {
        background-color: var(--accent-gold);
        color: var(--primary-dark);
      }
      body.dark .period-btn {
        background-color: var(--background-dark);
        border-color: var(--border-dark);
        color: var(--text-light);
      }
      body.dark .period-btn:hover,
      body.dark .period-btn.active {
        background-color: var(--accent-gold);
        color: var(--primary-dark);
      }

      /* --- 9. Live Scan Styles (MERGED FROM ADMIN 4) --- */
      .live-scan-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        max-width: 1200px;
        margin: 0 auto;
      }

      .live-scan-container .form-group {
        margin-bottom: 1.5rem;
      }
      .live-scan-container .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
      }
      .live-scan-container .scan-input {
        font-size: 1.5rem;
        padding: 15px;
        text-align: center;
        border: 2px dashed var(--border-light);
        border-radius: 8px;
        width: 100%;
        background-color: var(--card-bg-light);
        color: var(--text-dark);
      }
      .prefix-input {
        font-size: 1.2rem;
        padding: 12px;
        text-align: center;
        border: 1px solid var(--border-light);
        border-radius: 6px;
        width: 100%;
      }
      body.dark .prefix-input {
        background-color: var(--card-bg-dark);
        border-color: var(--border-dark);
        color: var(--text-light);
      }

      body.dark .live-scan-container .scan-input {
        border-color: var(--border-dark);
        background-color: var(--card-bg-dark);
        color: var(--text-light);
      }
      .live-scan-container .scan-input:focus {
        border-style: solid;
        border-color: var(--primary-light);
        outline: none;
      }
      .live-scan-container .scan-input:read-only {
        background-color: var(--background-light);
        border-style: solid;
        cursor: not-allowed;
      }
      body.dark .live-scan-container .scan-input:read-only {
        background-color: var(--background-dark);
      }

      .scan-controls {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-bottom: 1.5rem;
      }
      .scan-controls label {
        font-weight: 600;
      }
      .scan-controls select {
        padding: 8px;
        border-radius: 5px;
        border: 1px solid var(--border-light);
      }

      .auto-submit-toggle {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-left: auto; /* Pushes it to the right */
      }
      .auto-submit-toggle label {
        cursor: pointer;
        user-select: none;
      }

      .status-box {
        margin-top: 1.5rem;
        padding: 1.5rem;
        border-radius: 8px;
        font-size: 1.2rem;
        font-weight: 500;
        text-align: center;
        min-height: 100px;
        display: flex;
        flex-direction: column; /* Added for multi-line content */
        align-items: center;
        justify-content: center;
        background-color: var(--background-light);
        border: 1px solid var(--border-light);
      }
      body.dark .status-box {
        background-color: var(--background-dark);
        border-color: var(--border-dark);
      }
      .status-box.success {
        border-left: 5px solid var(--success);
        color: var(--success);
      }
      .status-box.error {
        border-left: 5px solid var(--danger);
        color: var(--danger);
      }
      .status-box.info {
        border-left: 5px solid var(--info);
        color: var(--info);
      }
      /* NEW STATUS BOX FOR EQUIPMENT MODE */
      .status-box.equipment-ready {
        border-left: 5px solid var(--calibration);
        color: var(--calibration);
      }

      /* --- NEW BUTTON STYLES (FROM ADMIN 4) --- */
      .scan-action-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
        justify-content: center;
      }
      .scan-action-buttons button {
        padding: 10px 20px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.2s;
        display: none; /* Initially hidden, controlled by JS */
      }
      #scanAnotherItemBtn {
        background-color: var(--primary-light);
        color: white;
      }
      #scanAnotherItemBtn:hover {
        background-color: var(--primary-dark);
      }
      #cancelScanBtn {
        background-color: var(--danger);
        color: white;
      }
      #cancelScanBtn:hover {
        background-color: #a02c38;
      }
      #updateStatusBtn {
        /* New button for Equipment Mode */
        background-color: var(--calibration);
        color: white;
      }
      #updateStatusBtn:hover {
        background-color: #7b4fb0;
      }
      /* --- END NEW BUTTON STYLES --- */

      #capturedStudentIdDisplay {
        font-weight: 600;
        margin-top: 1rem;
        color: var(--primary-light);
      }
      body.dark #capturedStudentIdDisplay {
        color: var(--accent-gold);
      }

      #trackingDetailsContainer h3 {
        margin-top: 0;
        margin-bottom: 0.5rem;
        font-size: 1.25rem;
      }
      #trackingDetailsContainer .detail-item {
        font-weight: 600;
      }
      #trackingBorrowerInfo {
        background-color: #fff3cd;
        color: #664d03;
        padding: 1rem;
        border-radius: 6px;
        margin-top: 1rem;
        border: 1px solid #ffecb5;
      }
      body.dark #trackingBorrowerInfo {
        background-color: #332701;
        color: #ffc107;
        border-color: #664d03;
      }
      #trackingHistoryLog {
        margin-top: 1rem;
        font-family: monospace;
        font-size: 0.9rem;
        max-height: 200px;
        overflow-y: auto;
      }
      #trackingHistoryLog div {
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border-light);
      }
      body.dark #trackingHistoryLog div {
        border-bottom-color: var(--border-dark);
      }
    </style>
  </head>
  <body>
    <aside id="sidebar">
      <div class="logo">
        <img src="logo.png" alt="LabLinX Logo" />
        <div class="logo-title">LabLinX DLSU-D</div>
      </div>
      <nav>
        <a data-page="dashboard" class="active">
          <div class="link-content">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
              />
            </svg>
            <span>Dashboard</span>
          </div>
        </a>
        <a data-page="live-scan">
          <div class="link-content">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 013.75 9.375v-4.5zM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 01-1.125-1.125v-4.5zM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0113.5 9.375v-4.5z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M13.5 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 01-1.125-1.125v-4.5z"
              />
            </svg>
            <span>Live Scan</span>
          </div>
        </a>
        <a data-page="inventory">
          <div class="link-content">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"
              />
            </svg>
            <span>Inventory</span>
          </div>
        </a>
        <a data-page="requests">
          <div class="link-content">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"
              />
            </svg>
            <span>Requests</span>
          </div>
        </a>
        <a data-page="notifications">
          <div class="link-content">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
              />
            </svg>
            <span>Notifications</span>
          </div>
          <span id="notification-badge" class="notification-badge">0</span>
        </a>
        <a data-page="reports">
          <div class="link-content">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 17v-6a2 2 0 012-2h6M9 17H5a2 2 0 01-2-2v-6a2 2 0 012-2h4m6 10v4m0-4h4m-4 0H9"
              />
            </svg>
            <span>Reports</span>
          </div>
        </a>

        <a href="/logout" class="logout-link">
          <div class="link-content">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
              />
            </svg>
            <span>Log Out</span>
          </div>
        </a>
      </nav>
    </aside>

    <header>
      <div class="header-left">
        <button class="toggle-btn" title="Toggle Sidebar">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="top-actions">
        <button class="dark-toggle" title="Toggle Dark Mode">
          <svg
            class="sun-icon"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
          <svg
            class="moon-icon"
            style="display: none"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
        </button>
        <a href="#" class="profile">
          <img src="https://i.pravatar.cc/40" alt="User Profile Picture" />
        </a>
      </div>
    </header>

    <main>
      <div id="dashboard-content" class="page-content active">
        <h1>Dashboard</h1>
        <p class="page-subtitle">Overview of Facility Inventories</p>
        <section class="dashboard-cards">
          <article class="card">
            <div class="card-header">
              <div class="card-icon icon-aqua">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M8.25 3v1.5M4.5 8.25H3m18 0h-1.5M4.5 12H3m18 0h-1.5m-15 3.75H3m18 0h-1.5M8.25 21v-1.5M15.75 3v1.5M12 4.5v-1.5m0 18v-1.5M5.636 5.636l1.06-1.06M5.636 18.364l1.06 1.06M18.364 5.636l-1.06-1.06M18.364 18.364l-1.06 1.06M12 12a6 6 0 110-12 6 6 0 010 12z"
                  />
                </svg>
              </div>
              <div class="card-header-text">
                <div class="title">Total Equipment Units</div>
                <div class="subtitle">Sum of all quantities</div>
              </div>
            </div>
            <div class="card-body">
              <h2 class="counter" data-type="total">0</h2>
              <div class="items">Units</div>
            </div>
            <a
              href="javascript:void(0)"
              class="card-footer"
              onclick="showPage('inventory')"
              ><span>View Details</span
              ><svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                viewBox="0 0 16 16"
              >
                <path
                  fill-rule="evenodd"
                  d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"
                /></svg
            ></a>
          </article>
          <article class="card">
            <div class="card-header">
              <div class="card-icon icon-red">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m-3 0l3-3m0 0l-3-3m3 3H9"
                  />
                </svg>
              </div>
              <div class="card-header-text">
                <div class="title">Borrowed Items</div>
                <div class="subtitle">Units currently in use</div>
              </div>
            </div>
            <div class="card-body">
              <h2 class="counter" data-type="inUse">0</h2>
              <div class="items">Units</div>
            </div>
            <a
              href="javascript:void(0)"
              class="card-footer"
              onclick="showPage('inventory')"
              ><span>View Details</span
              ><svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                viewBox="0 0 16 16"
              >
                <path
                  fill-rule="evenodd"
                  d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"
                /></svg
            ></a>
          </article>
          <article class="card">
            <div class="card-header">
              <div class="card-icon icon-green">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3"
                  />
                </svg>
              </div>
              <div class="card-header-text">
                <div class="title">Items in Maintenance</div>
                <div class="subtitle">Item types needing attention</div>
              </div>
            </div>
            <div class="card-body">
              <h2 class="counter" data-type="maintenance">0</h2>
              <div class="items">Items</div>
            </div>
            <a
              href="javascript:void(0)"
              class="card-footer"
              onclick="showPage('inventory')"
              ><span>View Details</span
              ><svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                viewBox="0 0 16 16"
              >
                <path
                  fill-rule="evenodd"
                  d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"
                /></svg
            ></a>
          </article>
        </section>
      </div>

      <div id="live-scan-content" class="page-content">
        <h1>Live Scan Transaction</h1>
        <p class="page-subtitle">
          Process transactions and view real-time item status and history.
        </p>
        <div class="live-scan-container">
          <section class="inventory-card">
            <h2>Transaction Processor</h2>
            <div class="scan-controls">
              <label for="scanMode">Mode:</label>
              <select id="scanMode">
                <option value="Borrowing" selected>Borrowing</option>
                <option value="Returning">Returning</option>
                <option value="Status Check">Status Check</option>
                <option value="Equipment">Equipment Mode</option>
              </select>
              <div class="auto-submit-toggle">
                <input type="checkbox" id="autoSubmitCheck" checked />
                <label for="autoSubmitCheck">Auto-Submit</label>
              </div>
            </div>
            <form id="scanForm">
              <div class="form-group" id="studentIdPrefixGroup">
                <label for="studentIdPrefixInput"
                  >Prefix/Suffix for Student ID</label
                >
                <input
                  type="text"
                  id="studentIdPrefixInput"
                  class="prefix-input"
                  placeholder="Enter prefix/suffix"
                />
              </div>
              <div class="form-group" id="studentIdGroup">
                <label for="studentIdInput">1. Scan Student ID</label>
                <input
                  type="text"
                  id="studentIdInput"
                  class="scan-input"
                  placeholder="Scan Student ID to Borrow..."
                  autocomplete="off"
                />
              </div>
              <div id="itemIdGroup" style="display: none">
                <div class="form-group" id="itemIdPrefixGroup">
                  <label for="itemIdPrefixInput">Prefix/Suffix for Item</label>
                  <input
                    type="text"
                    id="itemIdPrefixInput"
                    class="prefix-input"
                    placeholder="Enter prefix/suffix"
                  />
                </div>
                <div class="form-group">
                  <label for="itemIdInput">2. Scan Item Barcode</label>
                  <input
                    type="text"
                    id="itemIdInput"
                    class="scan-input"
                    placeholder="Scan Item to Borrow..."
                    autocomplete="off"
                  />
                </div>
              </div>
            </form>
            <div id="scanStatus" class="status-box">Awaiting scan...</div>

            <div class="scan-action-buttons">
              <button id="scanAnotherItemBtn" onclick="scanAnotherItem()">
                Scan Another Item
              </button>
              <button id="cancelScanBtn" onclick="cancelTransaction()">
                Cancel Transaction
              </button>
              <button
                id="updateStatusBtn"
                style="display: none"
                onclick="updateEquipmentStatus()"
              >
                Update Status
              </button>
            </div>
          </section>
          <section class="inventory-card">
            <h2>Live Tracking Details</h2>
            <div id="trackingDetailsContainer">
              <p>Scan an item to see its details here.</p>
            </div>
          </section>
        </div>
      </div>

      <div id="inventory-content" class="page-content">
        <h1>Manage Facility Inventories</h1>

        <div id="inventory-active-container">
          <section class="inventory-card" style="padding: 1rem 2rem">
            <div
              class="filter-row"
              style="justify-content: flex-end; margin-bottom: 0"
            >
              <button id="toggleInventoryArchiveBtn">View Archives</button>
            </div>
          </section>
          <p
            class="page-subtitle"
            style="
              margin-top: 2.5rem;
              border-top: 1px solid var(--border-light);
              padding-top: 2.5rem;
            "
          >
            Tables & Chairs
          </p>

          <section class="inventory-card">
            <h2>Add New Furniture</h2>
            <form class="add-form" id="addFormFurniture">
              <input
                type="text"
                name="itemIdPrefix"
                placeholder="Item ID Prefix (e.g., TBL)"
                required
              />
              <input
                type="text"
                name="name"
                placeholder="Furniture Name"
                required
              />
              <input
                type="hidden"
                name="category"
                value="Tables &amp; Chairs"
              />
              <input
                type="number"
                name="quantity"
                placeholder="Quantity to create"
                min="1"
                required
              />
              <input
                type="text"
                name="location"
                placeholder="Location"
                required
              />
              <button type="submit">Add Item</button>
            </form>
          </section>

          <section class="inventory-card">
            <h2 id="furnitureTableTitle">Tables &amp; Chairs Inventory</h2>
            <div class="filter-row">
              <div class="search-bar">
                <input
                  type="text"
                  id="searchFurniture"
                  placeholder="Search tables &amp; chairs..."
                />
              </div>
              <div class="filter-select">
                <label for="inventoryStatusFilterFurniture">Status</label>
                <select id="inventoryStatusFilterFurniture">
                  <option value="All">All Statuses</option>
                  <option value="Available">Available</option>
                  <option value="In-Use">In-Use</option>
                  <option value="Maintenance">Maintenance</option>
                  <option value="Damaged">Damaged</option>
                  <option value="Calibration">Calibration</option>
                </select>
              </div>
            </div>
            <table id="tableFurniture">
              <thead>
                <tr>
                  <th>
                    <input
                      type="checkbox"
                      id="checkAllUnits"
                      onclick="toggleAllUnits(this)"
                    />
                    ID
                  </th>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Total Qty</th>
                  <th>Borrowed</th>
                  <th>Available</th>
                  <th>Location</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </section>

          <p
            class="page-subtitle"
            style="
              margin-top: 2.5rem;
              border-top: 1px solid var(--border-light);
              padding-top: 2.5rem;
            "
          >
            Computer Equipment
          </p>

          <section class="inventory-card">
            <h2>Add New Computer Equipment</h2>
            <form class="add-form" id="addFormComputer">
              <input
                type="text"
                name="itemIdPrefix"
                placeholder="Item ID Prefix (e.g., CPU)"
                required
              />
              <input
                type="text"
                name="name"
                placeholder="Equipment Name"
                required
              />
              <input type="hidden" name="category" value="Computer Lab" />
              <input
                type="number"
                name="quantity"
                placeholder="Quantity to create"
                min="1"
                required
              />
              <input
                type="text"
                name="location"
                placeholder="Location"
                required
              />
              <button type="submit">Add Item</button>
            </form>
          </section>

          <section class="inventory-card">
            <h2 id="computerTableTitle">Computer Lab Inventory</h2>
            <div class="filter-row">
              <div class="search-bar">
                <input
                  type="text"
                  id="searchComputer"
                  placeholder="Search computer equipment..."
                />
              </div>
              <div class="filter-select">
                <label for="inventoryStatusFilterComputer">Status</label>
                <select id="inventoryStatusFilterComputer">
                  <option value="All">All Statuses</option>
                  <option value="Available">Available</option>
                  <option value="In-Use">In-Use</option>
                  <option value="Maintenance">Maintenance</option>
                  <option value="Damaged">Damaged</option>
                  <option value="Calibration">Calibration</option>
                </select>
              </div>
            </div>
            <table id="tableComputer">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Total Qty</th>
                  <th>Borrowed</th>
                  <th>Available</th>
                  <th>Location</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </section>

          <p
            class="page-subtitle"
            style="
              margin-top: 2.5rem;
              border-top: 1px solid var(--border-light);
              padding-top: 2.5rem;
            "
          >
            Food Lab Equipment
          </p>

          <section class="inventory-card">
            <h2>Add New Food Lab Equipment</h2>
            <form class="add-form" id="addFormFood">
              <input
                type="text"
                name="itemIdPrefix"
                placeholder="Item ID Prefix (e.g., FDL)"
                required
              />
              <input
                type="text"
                name="name"
                placeholder="Equipment Name"
                required
              />
              <input type="hidden" name="category" value="Food Lab" />
              <input
                type="number"
                name="quantity"
                placeholder="Quantity to create"
                min="1"
                required
              />
              <input
                type="text"
                name="location"
                placeholder="Location"
                required
              />
              <button type="submit">Add Item</button>
            </form>
          </section>

          <section class="inventory-card">
            <h2 id="foodTableTitle">Food Lab Inventory</h2>
            <div class="filter-row">
              <div class="search-bar">
                <input
                  type="text"
                  id="searchFood"
                  placeholder="Search food lab equipment..."
                />
              </div>
              <div class="filter-select">
                <label for="inventoryStatusFilterFood">Status</label>
                <select id="inventoryStatusFilterFood">
                  <option value="All">All Statuses</option>
                  <option value="Available">Available</option>
                  <option value="In-Use">In-Use</option>
                  <option value="Maintenance">Maintenance</option>
                  <option value="Damaged">Damaged</option>
                  <option value="Calibration">Calibration</option>
                </select>
              </div>
            </div>
            <table id="tableFood">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Total Qty</th>
                  <th>Borrowed</th>
                  <th>Available</th>
                  <th>Location</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </section>

          <p
            class="page-subtitle"
            style="
              margin-top: 2.5rem;
              border-top: 1px solid var(--border-light);
              padding-top: 2.5rem;
            "
          >
            Music Equipment
          </p>

          <section class="inventory-card">
            <h2>Add New Music Equipment</h2>
            <form class="add-form" id="addFormMusic">
              <input
                type="text"
                name="itemIdPrefix"
                placeholder="Item ID Prefix (e.g., MSC)"
                required
              />
              <input
                type="text"
                name="name"
                placeholder="Instrument Name"
                required
              />
              <input type="hidden" name="category" value="Music Instruments" />
              <input
                type="number"
                name="quantity"
                placeholder="Quantity to create"
                min="1"
                required
              />
              <input
                type="text"
                name="location"
                placeholder="Location"
                required
              />
              <button type="submit">Add Item</button>
            </form>
          </section>

          <section class="inventory-card">
            <h2 id="musicTableTitle">Music Instruments Inventory</h2>
            <div class="filter-row">
              <div class="search-bar">
                <input
                  type="text"
                  id="searchMusic"
                  placeholder="Search music equipment..."
                />
              </div>
              <div class="filter-select">
                <label for="inventoryStatusFilterMusic">Status</label>
                <select id="inventoryStatusFilterMusic">
                  <option value="All">All Statuses</option>
                  <option value="Available">Available</option>
                  <option value="In-Use">In-Use</option>
                  <option value="Maintenance">Maintenance</option>
                  <option value="Damaged">Damaged</option>
                  <option value="Calibration">Calibration</option>
                </select>
              </div>
            </div>
            <table id="tableMusic">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Total Qty</th>
                  <th>Borrowed</th>
                  <th>Available</th>
                  <th>Location</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </section>
        </div>

        <div id="inventory-archive-container" style="display: none">
          <section class="inventory-card">
            <h2>Archived Facility Equipment</h2>
            <div class="filter-row">
              <div class="search-bar">
                <input
                  type="text"
                  id="searchInventoryArchive"
                  placeholder="Search archived equipment..."
                />
              </div>
            </div>
            <table id="inventoryArchiveTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Total Qty</th>
                  <th>Location</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="inventoryArchiveTableBody"></tbody>
            </table>
          </section>
        </div>
      </div>

      <div
        id="bulkActionBar"
        style="
          position: fixed;
          bottom: 20px;
          left: 50%;
          transform: translateX(-50%);
          background-color: var(--primary-dark);
          padding: 10px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
          display: none;
          z-index: 999;
        "
      >
        <span
          id="selectedCount"
          style="
            color: var(--accent-gold);
            font-weight: 600;
            margin-right: 20px;
          "
          >0 Items Selected</span
        >
        <button class="btn btn-restore">Bulk Restore</button>
        <button class="btn btn-delete-permanent">Cancel Selection</button>
      </div>
      <div id="requests-content" class="page-content">
        <h1 id="requests-title">Manage Student Requests</h1>
        <p class="page-subtitle">
          Approve or reject pending equipment requests.
        </p>
        <section class="inventory-card">
          <div class="filter-row">
            <div class="search-bar">
              <input
                type="text"
                id="requestSearch"
                placeholder="Search by student, item name, or ID..."
              />
            </div>
            <div class="filter-select">
              <label for="requestStatusFilter">Filter by Status</label>
              <select id="requestStatusFilter">
                <option value="All">All Statuses</option>
                <option value="Pending">Pending</option>
                <option value="Approved">Approved</option>
                <option value="Rejected">Rejected</option>
                <option value="Returned">Returned</option>
              </select>
            </div>
            <button id="toggleTrashViewBtn">View Trash</button>
          </div>
          <table id="requestsTable">
            <thead>
              <tr>
                <th>Student Name</th>
                <th>Item ID</th>
                <th>Item Name</th>
                <th>Start Date</th>
                <th>Due Date</th>
                <th>Quantity</th>
                <th>Reason</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="requestsTableBody"></tbody>
          </table>
        </section>
      </div>

      <div id="notifications-content" class="page-content">
        <h1>Notifications</h1>
        <p class="page-subtitle">Latest activities and alerts.</p>
        <div id="notification-list"></div>
      </div>
      <div id="reports-content" class="page-content">
        <h1>Generate Reports</h1>
        <p class="page-subtitle">View and print inventory usage reports.</p>
        <section class="inventory-card">
          <select
            id="reportType"
            required
            style="
              padding: 8px;
              border-radius: 5px;
              border: 1px solid var(--border-light);
              margin-bottom: 1rem;
              width: 200px;
            "
          >
            <option value="">Select Report Type</option>
            <option value="inventory">Inventory Report</option>
            <option value="requests">Requests Report</option>
            <option value="usage">Usage Report</option>
            <option value="accountability">User Accountability</option>
          </select>
          <div style="margin-bottom: 1rem">
            <button id="dailyBtn" class="period-btn active">Daily</button>
            <button id="weeklyBtn" class="period-btn">Weekly</button>
            <button id="yearlyBtn" class="period-btn">Yearly</button>
          </div>
          <button
            id="generateReportBtn"
            style="
              background-color: var(--primary-dark);
              color: var(--accent-gold);
              padding: 10px 20px;
              border-radius: 5px;
              border: none;
              cursor: pointer;
              font-weight: 600;
            "
          >
            Generate Report
          </button>
        </section>
        <section
          class="inventory-card"
          id="reportResult"
          style="
            display: none;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 0.95rem;
          "
        ></section>
        <button
          id="printReportBtn"
          style="
            display: none;
            background-color: var(--primary-dark);
            color: var(--accent-gold);
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            margin-top: 1rem;
          "
        >
          Print Report
        </button>
      </div>
    </main>

    <div id="editModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="editModalTitle">Edit Item</h2>
          <span class="close-button">&times;</span>
        </div>
        <form id="editForm"></form>
      </div>
    </div>

    <div id="statusEditModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Edit Request Status</h2>
          <span class="close-button">&times;</span>
        </div>
        <form id="statusEditForm">
          <input type="hidden" id="statusRequestId" />
          <label for="statusSelect">Status</label>
          <select id="statusSelect" required>
            <option value="Pending">Pending</option>
            <option value="Approved">Approved</option>
            <option value="Rejected">Rejected</option>
            <option value="Returned">Returned</option>
          </select>
          <button type="submit">Update Status</button>
        </form>
      </div>
    </div>

    <div id="returnConditionModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Return Condition Report </h2>
          <span class="close-button" id="closeReturnConditionModal"
            >&times;</span
          >
        </div>
        <form id="returnConditionForm">
          <input type="hidden" id="returnConditionItemId" />
          <input type="hidden" id="returnConditionBorrowerName" />

          <p style="margin-bottom: 1rem">
            **Item:** <span id="modalItemName" style="font-weight: 600"></span>
          </p>
          <p style="margin-bottom: 1.5rem">
            **Borrowed By:**
            <span id="modalBorrowerName" style="font-weight: 600"></span>
          </p>

          <label for="conditionSelect">Select Return Condition</label>
          <select id="conditionSelect" required style="margin-bottom: 1rem">
            <option value="Good" selected>1 - Good Condition </option>
            <option value="Damaged">2 - Damaged </option>
            <option value="Lost">3 - Lost </option>
          </select>

          <label for="damageNotes" id="damageNotesLabel" style="display: none"
            >Notes on Damage/Loss (Required)</label
          >
          <textarea
            id="damageNotes"
            placeholder="Enter details about the damage, or confirm the item is lost."
            style="display: none; height: 80px"
          ></textarea>

          <button type="submit" id="submitConditionBtn">Submit Return</button>
        </form>
      </div>
    </div>
    <div id="toast-container"></div>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // --- 1. CONFIGURATION & STATE ---
        const apiBaseUrl = 'https://lablinx-dlsu-d-xf2i.onrender.com';
        const originalFetch = window.fetch.bind(window);
        window.fetch = (input, init) => {
          if (typeof input === 'string' && input.startsWith('/')) {
            return originalFetch(`${apiBaseUrl}${input}`, init);
          }
          return originalFetch(input, init);
        };
        const inventoryTypes = {
          Furniture: {
            api: '/api/inventory4',
            store: [],
            tableBody: document.querySelector('#tableFurniture tbody'),
            searchInput: document.getElementById('searchFurniture'),
            addForm: document.getElementById('addFormFurniture'),
            statusFilter: document.getElementById(
              'inventoryStatusFilterFurniture'
            ),
          },
          Computer: {
            api: '/api/inventory5',
            store: [],
            tableBody: document.querySelector('#tableComputer tbody'),
            searchInput: document.getElementById('searchComputer'),
            addForm: document.getElementById('addFormComputer'),
            statusFilter: document.getElementById(
              'inventoryStatusFilterComputer'
            ),
          },
          Food: {
            api: '/api/inventory6',
            store: [],
            tableBody: document.querySelector('#tableFood tbody'),
            searchInput: document.getElementById('searchFood'),
            addForm: document.getElementById('addFormFood'),
            statusFilter: document.getElementById('inventoryStatusFilterFood'),
          },
          Music: {
            api: '/api/inventory8',
            store: [],
            tableBody: document.querySelector('#tableMusic tbody'),
            searchInput: document.getElementById('searchMusic'),
            addForm: document.getElementById('addFormMusic'),
            statusFilter: document.getElementById('inventoryStatusFilterMusic'),
          },
        };

        // MODIFIED: Added archive state
        let allRequestsData = [],
          notifications = [],
          seenRequestIds = new Set();
        let isViewingInventoryArchive = false;
        let combinedArchivedInventory = [];
        let isViewingTrash = false;
        const tableTitleMap = {
          Furniture: document.getElementById('furnitureTableTitle'),
          Computer: document.getElementById('computerTableTitle'),
          Food: document.getElementById('foodTableTitle'),
          Music: document.getElementById('musicTableTitle'),
        };
        const tableTitleText = {
          Furniture: {
            active: 'Tables & Chairs Inventory',
            archive: 'Archived Tables & Chairs',
          },
          Computer: {
            active: 'Computer Lab Inventory',
            archive: 'Archived Computer Lab',
          },
          Food: {
            active: 'Food Lab Inventory',
            archive: 'Archived Food Lab',
          },
          Music: {
            active: 'Music Instruments Inventory',
            archive: 'Archived Music Instruments',
          },
        };
        const categoryFilters = {
          Furniture: 'Tables & Chairs',
          Computer: 'Computer Lab',
          Food: 'Food Lab',
          Music: 'Music Instruments',
        };
        let selectedArchivedItems = [];

        const body = document.body;
        const logoutLink = document.querySelector('.logout-link');
        if (logoutLink) {
          logoutLink.addEventListener('click', (event) => {
            event.preventDefault();
            window.location.href = `${apiBaseUrl}/logout`;
          });
        }
        const editModal = document.getElementById('editModal');
        const statusEditModal = document.getElementById('statusEditModal');
        const editForm = document.getElementById('editForm');
        const requestsTableBody = document.getElementById('requestsTableBody');
        const notificationList = document.getElementById('notification-list');
        const notificationBadge = document.getElementById('notification-badge');

        const requestSearch = document.getElementById('requestSearch');
        const requestStatusFilter = document.getElementById(
          'requestStatusFilter'
        );
        const toggleTrashViewBtn =
          document.getElementById('toggleTrashViewBtn');
        const requestsTitle = document.getElementById('requests-title');

        // --- LIVE SCAN (MERGED FROM ADMIN 4) ---
        const scanForm = document.getElementById('scanForm');
        const scanMode = document.getElementById('scanMode');
        const scanStatus = document.getElementById('scanStatus');
        const trackingDetailsContainer = document.getElementById(
          'trackingDetailsContainer'
        );
        const autoSubmitCheck = document.getElementById('autoSubmitCheck');
        const studentIdPrefixInput = document.getElementById(
          'studentIdPrefixInput'
        );
        const studentIdInput = document.getElementById('studentIdInput');
        const itemIdPrefixInput = document.getElementById('itemIdPrefixInput');
        const itemIdInput = document.getElementById('itemIdInput');
        const studentIdPrefixGroup = document.getElementById(
          'studentIdPrefixGroup'
        );
        const studentIdGroup = document.getElementById('studentIdGroup');
        const itemIdGroup = document.getElementById('itemIdGroup');
        let currentBorrowingStudentId = null;
        let scanDebounceTimer = null;
        let scannedEquipmentId = null; // <-- ADDED

        // --- ADDED: Auto-submit handlers (moved from setupEventListeners to match admin_panel2.html) ---
        const handleAutoSubmit = (event) => {
          clearTimeout(scanDebounceTimer);
          if (autoSubmitCheck.checked) {
            scanDebounceTimer = setTimeout(() => {
              if (event.target.value.trim() !== '') {
                processScan(event.target);
              }
            }, 100);
          }
        };
        const disableAutoSubmit = () => {
          itemIdInput.removeEventListener('input', handleAutoSubmit);
          studentIdInput.removeEventListener('input', handleAutoSubmit);
        };
        const enableAutoSubmit = () => {
          itemIdInput.addEventListener('input', handleAutoSubmit);
          studentIdInput.addEventListener('input', handleAutoSubmit);
        };

        const scanAnotherItemBtn =
          document.getElementById('scanAnotherItemBtn'); // <-- ADDED
        const cancelScanBtn = document.getElementById('cancelScanBtn'); // <-- ADDED
        const updateStatusBtn = document.getElementById('updateStatusBtn'); // <-- ADDED
        // --- END LIVE SCAN ---

        // --- ADDED: Inventory Archive Selectors ---
        const toggleInventoryArchiveBtn = document.getElementById(
          'toggleInventoryArchiveBtn'
        );
        const inventoryActiveContainer = document.getElementById(
          'inventory-active-container'
        );
        const inventoryArchiveContainer = document.getElementById(
          'inventory-archive-container'
        );
        const inventoryArchiveTableBody = document.getElementById(
          'inventoryArchiveTableBody'
        );
        const searchInventoryArchive = document.getElementById(
          'searchInventoryArchive'
        );

        // --- REPORTS VARIABLES ---
        const reportTypeSelect = document.getElementById('reportType');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const reportResult = document.getElementById('reportResult');
        const printReportBtn = document.getElementById('printReportBtn');
        let selectedPeriod = 'daily';
        const periodBtns = document.querySelectorAll('.period-btn');

        // --- 2. INITIALIZATION ---
        function initializeApp() {
          setupEventListeners();
          showPage('dashboard');
          fetchAdminNotifications();
          connectWebSocket();
        }

        // --- FIX: Function to dynamically handle ALL report types (All buttons enabled) ---
        function toggleReportPeriodButtons() {
          periodBtns.forEach((btn) => {
            btn.disabled = false;
          });
        }

        // --- MERGED EVENT LISTENERS ---
        function setupEventListeners() {
          document
            .querySelector('.toggle-btn')
            .addEventListener('click', () =>
              body.classList.toggle('sidebar-collapsed')
            );

          const darkToggle = document.querySelector('.dark-toggle');
          darkToggle.addEventListener('click', () => {
            body.classList.toggle('dark');
            const isDarkMode = body.classList.contains('dark');
            localStorage.setItem('dark-mode', isDarkMode);
            darkToggle.querySelector('.sun-icon').style.display = isDarkMode
              ? 'none'
              : 'block';
            darkToggle.querySelector('.moon-icon').style.display = isDarkMode
              ? 'block'
              : 'none';
          });

          if (localStorage.getItem('dark-mode') === 'true') {
            body.classList.add('dark');
            darkToggle.querySelector('.sun-icon').style.display = 'none';
            darkToggle.querySelector('.moon-icon').style.display = 'block';
          }

          document
            .querySelectorAll('#sidebar nav a[data-page]')
            .forEach((link) => {
              link.addEventListener('click', (e) => {
                e.preventDefault();
                showPage(link.dataset.page);
              });
            });

          const mainContentArea = document.querySelector('main');
          mainContentArea.addEventListener('click', (event) => {
            const liveScanPage = document.getElementById('live-scan-content');
            // UPDATED: Added check for new buttons
            if (
              liveScanPage.classList.contains('active') &&
              !event.target.closest(
                '.live-scan-container form, .live-scan-container select, .scan-action-buttons'
              )
            ) {
              if (itemIdGroup.style.display !== 'none') {
                itemIdPrefixInput.focus();
              } else if (studentIdGroup.style.display !== 'none') {
                studentIdPrefixInput.focus();
              }
            }
          });

          for (const type in inventoryTypes) {
            inventoryTypes[type].addForm.addEventListener('submit', (e) =>
              handleAddItem(e, type)
            );
            inventoryTypes[type].searchInput.addEventListener('input', () =>
              renderTable(type)
            );
            inventoryTypes[type].statusFilter.addEventListener('change', () =>
              renderTable(type)
            );
          }

          requestSearch.addEventListener('input', renderRequestsTable);
          requestStatusFilter.addEventListener('change', renderRequestsTable);
          toggleTrashViewBtn.addEventListener('click', toggleRequestView);

          editForm.addEventListener('submit', handleUpdateItem);
          editModal.querySelector('.close-button').onclick = () =>
            (editModal.style.display = 'none');
          statusEditModal.querySelector('.close-button').onclick = () =>
            (statusEditModal.style.display = 'none');
          document.getElementById('closeReturnConditionModal').onclick = () =>
            (document.getElementById('returnConditionModal').style.display =
              'none');

          window.addEventListener('click', (event) => {
            if (event.target == editModal) editModal.style.display = 'none';
            if (event.target == statusEditModal)
              statusEditModal.style.display = 'none';
            if (event.target == document.getElementById('returnConditionModal'))
              document.getElementById('returnConditionModal').style.display =
                'none';
          });

          document
            .getElementById('statusEditForm')
            .addEventListener('submit', (e) => {
              e.preventDefault();
              const requestId =
                document.getElementById('statusRequestId').value;
              const newStatus = document.getElementById('statusSelect').value;
              handleRequest(requestId, newStatus);
              statusEditModal.style.display = 'none';
            });

          toggleInventoryArchiveBtn.addEventListener(
            'click',
            toggleInventoryArchiveView
          );
          searchInventoryArchive.addEventListener('input', () => {
            if (isViewingInventoryArchive) {
              for (const type in inventoryTypes) {
                renderTable(type);
              }
            }
          });

          // --- Reports Event Listeners ---
          reportTypeSelect.addEventListener(
            'change',
            toggleReportPeriodButtons
          );

          periodBtns.forEach((btn) => {
            btn.addEventListener('click', () => {
              periodBtns.forEach((b) => b.classList.remove('active'));
              btn.classList.add('active');
              selectedPeriod = btn.id.replace('Btn', '');
            });
          });

          // --- Live Scan Listeners (MERGED FROM ADMIN 4) ---
          scanMode.addEventListener('change', resetScannerUI);
          scanForm.addEventListener('submit', (e) => {
            e.preventDefault();
            processScan(document.activeElement);
          });

          // --- MODIFIED: Use the auto-submit handlers (already defined above) ---
          enableAutoSubmit();

          // ADDED: Event listeners for new buttons
          scanAnotherItemBtn.addEventListener('click', scanAnotherItem);
          cancelScanBtn.addEventListener('click', cancelTransaction);
          updateStatusBtn.addEventListener('click', updateEquipmentStatus);
          // --- END ---

          // NEW EVENT LISTENERS FOR RETURN CONDITION MODAL
          document
            .getElementById('returnConditionForm')
            .addEventListener('submit', window.handleReturnConditionSubmission);

          document
            .getElementById('conditionSelect')
            .addEventListener('change', (e) => {
              const notesLabel = document.getElementById('damageNotesLabel');
              const notesTextarea = document.getElementById('damageNotes');
              if (['Damaged', 'Lost'].includes(e.target.value)) {
                notesLabel.style.display = 'block';
                notesTextarea.style.display = 'block';
                notesTextarea.required = true;
              } else {
                notesLabel.style.display = 'none';
                notesTextarea.style.display = 'none';
                notesTextarea.required = false;
              }
            });
        }

        // --- 3. PAGE NAVIGATION & CONTENT LOADING ---
        window.showPage = (pageId) => {
          document
            .querySelectorAll('.page-content')
            .forEach((p) => p.classList.remove('active'));
          document.getElementById(`${pageId}-content`).classList.add('active');
          document
            .querySelectorAll('#sidebar nav a[data-page]')
            .forEach((l) =>
              l.classList.toggle('active', l.dataset.page === pageId)
            );

          if (pageId === 'dashboard') {
            updateDashboard();
          } else if (pageId === 'inventory') {
            isViewingInventoryArchive = false;
            inventoryActiveContainer.style.display = 'block';
            inventoryArchiveContainer.style.display = 'none';
            toggleInventoryArchiveBtn.textContent = 'View Archives';
            for (const type in inventoryTypes) fetchInventory(type);
          } else if (pageId === 'requests') {
            isViewingTrash = false;
            fetchAllRequests();
          } else if (pageId === 'notifications') {
            renderNotifications();
          } else if (pageId === 'live-scan') {
            initializeLiveScan();
          } else if (pageId === 'reports') {
            toggleReportPeriodButtons();
          }
        };

        // --- 4. DASHBOARD LOGIC ---
        async function updateDashboard() {
          try {
            const dataArrays = await Promise.all(
              Object.values(inventoryTypes).map((type) =>
                fetch(type.api).then((res) => res.json())
              )
            );
            const combinedData = [].concat(...dataArrays);
            const metrics = {
              totalEquipment: combinedData.reduce(
                (sum, item) =>
                  sum + (item.originalQuantity || item.quantity || 0),
                0
              ),
              inUse: combinedData.reduce(
                (sum, item) =>
                  sum +
                  ((item.originalQuantity || item.quantity || 0) -
                    (item.quantity || 0)),
                0
              ),
              maintenance: combinedData.filter(
                (item) =>
                  item.status === 'Maintenance' ||
                  item.status === 'Damaged' ||
                  item.status === 'Calibration'
              ).length, // <-- ADDED CALIBRATION
            };
            document
              .querySelector('.counter[data-type="total"]')
              .setAttribute('data-target', metrics.totalEquipment);
            document
              .querySelector('.counter[data-type="inUse"]')
              .setAttribute('data-target', metrics.inUse);
            document
              .querySelector('.counter[data-type="maintenance"]')
              .setAttribute('data-target', metrics.maintenance);
            animateCounters();
          } catch (error) {
            showToast('Error fetching dashboard data.');
          }
        }
        function animateCounters() {
          document
            .querySelectorAll('#dashboard-content .counter')
            .forEach((counter) => {
              counter.innerText = '0';
              const update = () => {
                const target = +counter.getAttribute('data-target');
                const count = +counter.innerText;
                const increment = Math.max(1, Math.ceil((target - count) / 10));
                if (count < target) {
                  counter.innerText = `${Math.min(target, count + increment)}`;
                  setTimeout(update, 40);
                } else {
                  counter.innerText = target;
                }
              };
              update();
            });
        }

        // --- 5. LIVE SCAN FUNCTIONS (MERGED FROM ADMIN 4) ---
        function clearTrackingDetails() {
          trackingDetailsContainer.innerHTML =
            '<p>Scan an item to see its details here.</p>';
        }
        function initializeLiveScan() {
          resetScannerUI();
        }

        // UPDATED resetScannerUI from Admin 4
        function resetScannerUI() {
          currentBorrowingStudentId = null;
          scannedEquipmentId = null;
          studentIdInput.value = '';
          itemIdInput.value = '';
          studentIdPrefixInput.value = '';
          itemIdPrefixInput.value = '';
          studentIdInput.readOnly = false;
          scanStatus.textContent = 'Awaiting scan...';
          scanStatus.className = 'status-box';
          scanAnotherItemBtn.style.display = 'none';
          cancelScanBtn.style.display = 'none';
          updateStatusBtn.style.display = 'none';

          const mode = scanMode.value;

          // Hide all groups by default
          studentIdPrefixGroup.style.display = 'none';
          studentIdGroup.style.display = 'none';
          itemIdGroup.style.display = 'none';

          if (mode === 'Borrowing') {
            studentIdPrefixGroup.style.display = 'block';
            studentIdGroup.style.display = 'block';
            itemIdGroup.style.display = 'none';
            studentIdInput.placeholder = 'Scan student ID to BORROW...';
            studentIdPrefixInput.focus();
          } else if (
            mode === 'Returning' ||
            mode === 'Status Check' ||
            mode === 'Equipment'
          ) {
            studentIdPrefixGroup.style.display = 'none';
            studentIdGroup.style.display = 'none';
            itemIdGroup.style.display = 'block';
            if (mode === 'Returning') {
              itemIdInput.placeholder = 'Scan item to RETURN...';
            } else if (mode === 'Status Check') {
              itemIdInput.placeholder = 'Scan item for STATUS CHECK...';
            } else if (mode === 'Equipment') {
              itemIdInput.placeholder = 'Scan item to change status...';
            }
            itemIdPrefixInput.focus();
          }

          clearTrackingDetails();
        }

        // ADDED: scanAnotherItem from Admin 4
        window.scanAnotherItem = () => {
          const mode = scanMode.value;
          if (mode === 'Borrowing' && currentBorrowingStudentId) {
            itemIdInput.value = '';
            itemIdPrefixInput.value = '';
            scanStatus.textContent = `Student ID **${currentBorrowingStudentId}** captured. Scan next item.`;
            scanStatus.className = 'status-box info';
            scanAnotherItemBtn.style.display = 'none';
            cancelScanBtn.style.display = 'inline-block';
            itemIdPrefixInput.focus();
          } else if (
            mode === 'Equipment' ||
            mode === 'Returning' ||
            mode === 'Status Check'
          ) {
            scannedEquipmentId = null;
            itemIdInput.value = '';
            itemIdPrefixInput.value = '';
            scanStatus.textContent = `Awaiting scan for next item...`;
            scanStatus.className = 'status-box';
            updateStatusBtn.style.display = 'none';
            scanAnotherItemBtn.style.display = 'none';
            cancelScanBtn.style.display = 'none';
            clearTrackingDetails();
            itemIdPrefixInput.focus();
          } else {
            resetScannerUI();
          }
        };

        // ADDED: cancelTransaction from Admin 4
        window.cancelTransaction = () => {
          showToast('Transaction cancelled. Scanner reset.');
          resetScannerUI();
        };

        // ADDED: renderEquipmentStatusChange from Admin 4
        function renderEquipmentStatusChange(itemData) {
          scannedEquipmentId = itemData.itemId;
          const statusClass = itemData.status.replace(/[^a-zA-Z0-9]/g, '');
          trackingDetailsContainer.innerHTML = `
                <h3>${itemData.name} (${itemData.itemId})</h3>
                <p>
                    <strong>Current Status:</strong> <span class="status-badge status-${statusClass}">${
            itemData.status
          }</span><br>
                    <strong>Available Qty:</strong> ${
                      itemData.quantity || 0
                    } / ${itemData.originalQuantity || 0}
                </p>
                <div class="form-group" style="margin-top: 1.5rem;">
                    <label for="newEquipmentStatus">Change Status To:</label>
                    <select id="newEquipmentStatus" class="prefix-input">
                        <option value="Available" ${
                          itemData.status === 'Available' ? 'selected' : ''
                        }>Available</option>
                        <option value="Maintenance" ${
                          itemData.status === 'Maintenance' ? 'selected' : ''
                        }>Maintenance</option>
                        <option value="Calibration" ${
                          itemData.status === 'Calibration' ? 'selected' : ''
                        }>Calibration</option>
                        <option value="Damaged" ${
                          itemData.status === 'Damaged' ? 'selected' : ''
                        }>Damaged</option>
                        <option value="In-Use" disabled>In-Use (System-managed)</option>
                    </select>
                </div>`;
          scanStatus.textContent = `Item **${itemData.itemId}** is ready for status change.`;
          scanStatus.className = 'status-box equipment-ready';
          updateStatusBtn.style.display = 'inline-block';
          scanAnotherItemBtn.style.display = 'none';
          cancelScanBtn.style.display = 'inline-block';
        }

        // ADDED: updateEquipmentStatus from Admin 4
        window.updateEquipmentStatus = async () => {
          const newStatus = document.getElementById('newEquipmentStatus').value;
          const itemId = scannedEquipmentId;
          if (!itemId || !newStatus || newStatus === 'In-Use') return;

          // Find the item in any of the stores
          let originalItem = null;
          let apiToCall = null;
          for (const type in inventoryTypes) {
            originalItem = inventoryTypes[type].store.find(
              (i) => i.itemId === itemId
            );
            if (originalItem) {
              apiToCall = inventoryTypes[type].api;
              break;
            }
          }

          if (!originalItem) {
            showToast(`Error: Item ${itemId} not found locally.`, 'error');
            return;
          }

          try {
            scanStatus.textContent = `Updating status for ${itemId}...`;
            scanStatus.className = 'status-box info';
            updateStatusBtn.style.display = 'none';

            // Logic from Admin 4: Set quantity based on status
            const isNowAvailable = newStatus === 'Available';
            const isNowUnavailable = [
              'Maintenance',
              'Calibration',
              'Damaged',
            ].includes(newStatus);

            const updateData = {
              status: newStatus,
              // If it's becoming unavailable, set available qty to 0
              // If it's becoming available, set available qty to total qty
              quantity: isNowUnavailable
                ? 0
                : isNowAvailable
                ? originalItem.originalQuantity
                : originalItem.quantity,
            };

            const response = await fetch(`${apiToCall}/${itemId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(updateData),
            });
            if (!response.ok)
              throw new Error(
                (await response.json()).message ||
                  'Failed to update equipment status.'
              );

            showToast(
              `Status for ${itemId} updated to **${newStatus}**!`,
              'success'
            );
            scanStatus.textContent = `Success: Item **${itemId}** is now **${newStatus}**.`;
            scanStatus.className = 'status-box success';

            // Refetch inventory for the correct type
            for (const type in inventoryTypes) {
              if (inventoryTypes[type].api === apiToCall) {
                fetchInventory(type);
                break;
              }
            }

            setTimeout(() => fetchAndDisplayItemDetails(itemId), 500);
            scanAnotherItemBtn.style.display = 'inline-block';
            cancelScanBtn.style.display = 'inline-block';
          } catch (error) {
            showToast(`Error: ${error.message}`, 'error');
            scanStatus.textContent = `Error: ${error.message}`;
            scanStatus.className = 'status-box error';
            updateStatusBtn.style.display = 'inline-block';
          }
        };

        // UPDATED: fetchAndDisplayItemDetails from Admin 4
        async function fetchAndDisplayItemDetails(itemId) {
          trackingDetailsContainer.innerHTML = '<p>Loading item details...</p>';
          try {
            const response = await fetch(`/api/item-details/${itemId}`);
            if (!response.ok) {
              if (response.status === 404) {
                throw new Error(
                  `Item ID **${itemId}** not found in the database.`
                );
              }
              throw new Error(`Failed to fetch details for ${itemId}.`);
            }
            const data = await response.json();
            const originalQty = data.originalQuantity || data.quantity || 0;
            const availableQty = data.quantity || 0;
            const borrowedQty = originalQty - availableQty;
            // Use the item's status, but default to In-Use if borrowed
            const currentStatus =
              borrowedQty > 0 &&
              data.status !== 'Maintenance' &&
              data.status !== 'Calibration' &&
              data.status !== 'Damaged'
                ? 'In-Use'
                : data.status || 'Available';
            const statusClass = currentStatus.replace(/[^a-zA-Z0-9]/g, '');

            let trackingHTML = `
                    <h3>${data.name}</h3>
                    <p>
                        <strong>ID:</strong> ${data.itemId} |
                        <strong>Category:</strong> ${data.category} |
                        <strong>Location:</strong> ${data.location}
                    </p>
                    <p>
                        <strong>Current Status:</strong> <span class="status-badge status-${statusClass}">${currentStatus}</span> |
                        <strong>Available Qty:</strong> ${availableQty} / ${originalQty}
                    </p>`;
            if (borrowedQty > 0 && data.currentLoan) {
              trackingHTML += `<div id="trackingBorrowerInfo"><p class="detail-item">Currently Borrowed By:</p><span>${
                data.currentLoan.studentName
              } (${
                data.currentLoan.studentID
              })</span><br><span><strong>Due Date:</strong> ${new Date(
                data.currentLoan.dueDate
              ).toLocaleDateString()}</span></div>`;
            } else if (
              currentStatus === 'Maintenance' ||
              currentStatus === 'Calibration' ||
              currentStatus === 'Damaged'
            ) {
              trackingHTML += `<div id="trackingBorrowerInfo" style="background-color: var(--danger); color: white; border-color: #d1d5db;"><p class="detail-item">ITEM UNDER ${currentStatus.toUpperCase()}</p></div>`;
            }
            trackingHTML += `<h4>History</h4><div id="trackingHistoryLog">`;
            if (data.history && data.history.length > 0) {
              data.history
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .forEach((log) => {
                  trackingHTML += `<div><strong>${log.action}</strong> by ${
                    log.studentName || 'N/A'
                  } on ${new Date(log.timestamp).toLocaleString()}</div>`;
                });
            } else {
              trackingHTML += `<div><div>No transaction history for this item.</div>`;
            }
            trackingHTML += `</div>`;
            trackingDetailsContainer.innerHTML = trackingHTML;
            return { success: true, status: currentStatus, itemData: data };
          } catch (error) {
            trackingDetailsContainer.innerHTML = `<p style="color: var(--danger);">**Error:** ${error.message}</p>`;
            return { success: false, message: error.message };
          }
        }

        // NEW GLOBAL FUNCTION TO HANDLE MODAL SUBMISSION
        window.handleReturnConditionSubmission = async (e) => {
          e.preventDefault();
          const modal = document.getElementById('returnConditionModal');
          const finalItemId = document.getElementById(
            'returnConditionItemId'
          ).value;
          const returnCondition =
            document.getElementById('conditionSelect').value;
          let damageNotes = document.getElementById('damageNotes').value.trim();

          if (
            ['Damaged', 'Lost'].includes(returnCondition) &&
            damageNotes === ''
          ) {
            showToast(
              'Notes on damage/loss are required for non-Good conditions.',
              'error'
            );
            return;
          }

          modal.style.display = 'none';
          disableAutoSubmit();

          try {
            const response = await fetch('/api/return-by-barcode', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                itemId: finalItemId,
                condition: returnCondition,
                damageNotes: damageNotes,
              }),
            });
            const result = await response.json();
            if (!response.ok)
              throw new Error(result.message || 'Failed to process return.');

            scanStatus.textContent = result.message;
            scanStatus.className = 'status-box success';
            showToast(result.message, 'success');
            fetchAndDisplayItemDetails(finalItemId); // Re-fetch details after return

            // Refetch all inventories
            for (const type in inventoryTypes) fetchInventory(type);
          } catch (error) {
            scanStatus.textContent = error.message;
            scanStatus.className = 'status-box error';
            showToast(error.message, 'error');
          } finally {
            // Reset UI for next scan
            scanAnotherItemBtn.style.display = 'inline-block';
            cancelScanBtn.style.display = 'inline-block';
            enableAutoSubmit();
            itemIdPrefixInput.focus();
          }
        };

        // UPDATED: processScan from Admin 4
        async function processScan(triggeredInput) {
          const mode = scanMode.value;
          const isStudentInput = triggeredInput === studentIdInput;
          const isItemInput = triggeredInput === itemIdInput;

          // Consolidate prefix/suffix logic
          const finalItemId =
            (itemIdPrefixInput.value || '') + (itemIdInput.value || '');
          const finalStudentId =
            (studentIdPrefixInput.value || '') + (studentIdInput.value || '');

          if (
            mode === 'Borrowing' &&
            isStudentInput &&
            finalStudentId.trim() !== ''
          ) {
            currentBorrowingStudentId = finalStudentId.trim();
            studentIdInput.readOnly = true;
            scanStatus.textContent = `Student ID **${currentBorrowingStudentId}** captured. Now scan the item.`;
            scanStatus.className = 'status-box info';
            itemIdGroup.style.display = 'block';
            itemIdPrefixInput.focus();
            cancelScanBtn.style.display = 'inline-block';
            return;
          }

          if (isItemInput && finalItemId.trim() !== '') {
            const itemId = finalItemId.trim();
            disableAutoSubmit();
            itemIdInput.value = '';
            itemIdPrefixInput.value = '';

            const itemDetailsResult = await fetchAndDisplayItemDetails(itemId);
            if (!itemDetailsResult.success) {
              scanStatus.textContent = `Error: ${itemDetailsResult.message}`;
              scanStatus.className = 'status-box error';
              scanAnotherItemBtn.style.display = 'inline-block';
              cancelScanBtn.style.display = 'inline-block';
              enableAutoSubmit();
              itemIdPrefixInput.focus();
              return;
            }

            if (mode === 'Borrowing' && currentBorrowingStudentId) {
              const studentID = currentBorrowingStudentId;
              if (
                itemDetailsResult.status === 'Maintenance' ||
                itemDetailsResult.status === 'Calibration' ||
                itemDetailsResult.status === 'Damaged'
              ) {
                scanStatus.textContent = `Error: Item **${itemId}** is under ${itemDetailsResult.status} and cannot be borrowed.`;
                scanStatus.className = 'status-box error';
                showToast(
                  `Error: Item ${itemId} under ${itemDetailsResult.status}.`,
                  'error'
                );
              } else {
                try {
                  const response = await fetch('/api/borrow-by-barcode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ itemId: itemId, studentID }),
                  });
                  const result = await response.json();
                  if (!response.ok)
                    throw new Error(
                      result.message || 'Failed to process borrowing.'
                    );
                  scanStatus.textContent = result.message;
                  scanStatus.className = 'status-box success';
                  showToast(result.message, 'success');
                  for (const type in inventoryTypes) fetchInventory(type);
                } catch (error) {
                  scanStatus.textContent = error.message;
                  scanStatus.className = 'status-box error';
                  showToast(error.message, 'error');
                } finally {
                  enableAutoSubmit();
                }
              }
              scanAnotherItemBtn.style.display = 'inline-block';
              cancelScanBtn.style.display = 'inline-block';
            } else if (mode === 'Returning') {
              // This logic is now handled by the modal
              if (
                itemDetailsResult.itemData &&
                itemDetailsResult.itemData.currentLoan
              ) {
                const borrowerName =
                  itemDetailsResult.itemData.currentLoan.studentName;
                const modal = document.getElementById('returnConditionModal');
                document.getElementById('returnConditionItemId').value = itemId;
                document.getElementById('modalItemName').textContent =
                  itemDetailsResult.itemData.name;
                document.getElementById(
                  'modalBorrowerName'
                ).textContent = `${borrowerName} (${itemDetailsResult.itemData.currentLoan.studentID})`;

                document.getElementById('conditionSelect').value = 'Good';
                document.getElementById('damageNotes').value = '';
                document.getElementById('damageNotesLabel').style.display =
                  'none';
                document.getElementById('damageNotes').style.display = 'none';
                document.getElementById('damageNotes').required = false;

                modal.style.display = 'flex';
              } else {
                scanStatus.textContent = `Error: No active loan found for item ID ${itemId}. Cannot return.`;
                scanStatus.className = 'status-box error';
                showToast(
                  `Error: No active loan found for ${itemId}.`,
                  'error'
                );
                scanAnotherItemBtn.style.display = 'inline-block';
                cancelScanBtn.style.display = 'inline-block';
                enableAutoSubmit();
              }
            } else if (mode === 'Status Check') {
              scanStatus.textContent = `Item **${itemId}** Status: **${itemDetailsResult.status}**`;
              scanStatus.className = `status-box info`;
              scanAnotherItemBtn.style.display = 'inline-block';
              cancelScanBtn.style.display = 'inline-block';
            } else if (mode === 'Equipment') {
              renderEquipmentStatusChange(itemDetailsResult.itemData);
            }

            enableAutoSubmit();
            if (mode !== 'Returning') itemIdPrefixInput.focus();
          }
        }

        // --- 6. INVENTORY CRUD & RENDERING ---
        async function fetchInventory(type) {
          const config = inventoryTypes[type];
          try {
            const response = await fetch(config.api);
            if (!response.ok)
              throw new Error(`Failed to fetch ${type} inventory`);
            const payload = await response.json();
            config.store = Array.isArray(payload) ? payload : [];
            if (
              !isViewingInventoryArchive &&
              document
                .getElementById('inventory-content')
                .classList.contains('active')
            ) {
              renderTable(type);
            }
          } catch (error) {
            showToast(error.message);
            renderTable(type);
          }
        }

        function renderTable(type) {
          const config = inventoryTypes[type];
          const tableBody = config.tableBody;
          const table = tableBody.closest('table');
          const thead = table.querySelector('thead');
          const isArchiveView = isViewingInventoryArchive;

          toggleInventoryArchiveBtn.textContent = isArchiveView
            ? 'View Active Inventory'
            : 'View Archives';

          if (tableTitleMap[type]) {
            tableTitleMap[type].textContent = isArchiveView
              ? tableTitleText[type].archive
              : tableTitleText[type].active;
          }

          if (config.addForm) {
            const elements = Array.from(config.addForm.elements);
            elements.forEach((el) => {
              if (el.tagName === 'BUTTON') {
                el.disabled = isArchiveView;
              } else {
                el.disabled = isArchiveView;
              }
            });
            config.addForm.style.opacity = isArchiveView ? '0.6' : '1';
            config.addForm.style.pointerEvents = isArchiveView
              ? 'none'
              : 'auto';
          }

          selectedArchivedItems = [];
          renderBulkActionBar();

          const searchTerm = config.searchInput.value.toLowerCase();
          const archiveSearchTerm = searchInventoryArchive.value
            ? searchInventoryArchive.value.toLowerCase()
            : '';
          const statusFilterValue = config.statusFilter.value;

          const filteredData = config.store.filter((item) => {
            const originalQty = item.originalQuantity || item.quantity || 0;
            const borrowedQty = originalQty - (item.quantity || 0);
            const displayStatus =
              borrowedQty > 0 &&
              !['Maintenance', 'Damaged', 'Calibration'].includes(
                item.status || ''
              )
                ? 'In-Use'
                : item.status || 'Available';
            const matchesSearch = Object.values(item).some((val) =>
              String(val ?? '')
                .toLowerCase()
                .includes(searchTerm)
            );
            const matchesArchiveSearch =
              !isArchiveView ||
              archiveSearchTerm === '' ||
              [item.itemId, item.name, item.location, item.category]
                .map((val) => String(val ?? '').toLowerCase())
                .some((val) => val.includes(archiveSearchTerm));
            const matchesStatus =
              statusFilterValue === 'All' ||
              displayStatus === statusFilterValue ||
              (statusFilterValue === 'Maintenance' &&
                ['Damaged', 'Maintenance'].includes(item.status));
            return matchesSearch && matchesStatus && matchesArchiveSearch;
          });

          if (thead) {
            thead.innerHTML = '';
          }
          tableBody.innerHTML = '';

          if (filteredData.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding: 20px;">No ${
              isArchiveView ? 'archived ' : ''
            }equipment found.</td></tr>`;
            return;
          }

          const groupedData = filteredData.reduce((groups, item) => {
            const key = item.name;
            if (!groups[key]) {
              const prefixMatch = item.itemId.match(/^([A-Z]+)-\d+$/i);
              groups[key] = {
                items: [],
                prefix: prefixMatch ? prefixMatch[1].toUpperCase() : 'N/A',
                category: item.category,
                totalQuantity: 0,
                totalBorrowed: 0,
                location: item.location,
                modelItemId: item.itemId,
              };
            }
            groups[key].items.push(item);
            groups[key].totalQuantity += item.originalQuantity || 0;
            groups[key].totalBorrowed +=
              (item.originalQuantity || 0) - (item.quantity || 0);
            return groups;
          }, {});

          if (thead) {
            const headerRow = thead.insertRow(0);
            headerRow.innerHTML = `
              <th><input type="checkbox" id="checkAllUnits" onclick="toggleAllUnits(this)"> ID</th>
              <th>NAME</th>
              <th>CATEGORY</th>
              <th>TOTAL QTY</th>
              <th>BORROWED</th>
              <th>AVAILABLE</th>
              <th>LOCATION</th>
              <th>STATUS</th>
              <th>ACTIONS</th>
            `;
          }

          Object.keys(groupedData)
            .sort()
            .forEach((groupName, index) => {
              const group = groupedData[groupName];
              const groupId = `group-${type}-${index + 1}`;
              const totalAvailable =
                group.totalQuantity - group.totalBorrowed || 0;

              let headerStatus = 'Available';
              if (group.totalBorrowed > 0) {
                headerStatus = 'In-Use';
              } else if (
                group.items.some((item) =>
                  [
                    'Maintenance',
                    'Damaged',
                    'Calibration',
                    'Decommissioned',
                  ].includes(item.status)
                )
              ) {
                headerStatus =
                  group.items[0].status === 'Decommissioned'
                    ? 'Decommissioned'
                    : group.items[0].status || 'Available';
              } else if (isArchiveView) {
                headerStatus = 'Decommissioned';
              }

              const headerStatusClass = headerStatus.replace(
                /[^a-zA-Z0-9]/g,
                ''
              );
              const isGroupChecked = group.items.every((item) =>
                selectedArchivedItems.includes(item.itemId)
              );

              const groupHeaderRow = tableBody.insertRow();
              groupHeaderRow.id = `${groupId}-header`;
              groupHeaderRow.classList.add('inventory-group-header');

              const headerActionsHtml = isArchiveView
                ? `
                    <button
                      class="btn btn-restore"
                      onclick="handleModelArchiveClick(event, '${group.modelItemId}', '${groupName}', '${type}')"
                    >
                      Restore Model
                    </button>
                    <button
                      class="btn btn-delete-permanent"
                      onclick="handleModelDeleteClick(event, '${group.modelItemId}', '${groupName}', '${type}')"
                    >
                      Delete Permanently
                    </button>
                  `
                : `
                    <button
                      class="btn btn-edit"
                      data-item-ids="${group.items
                        .map((i) => i.itemId)
                        .join('|')}"
                      onclick="handleModelEditClick(event, '${type}', '${
                    group.modelItemId
                  }')"
                    >
                      Edit Model
                    </button>
                    <button
                      class="btn btn-delete"
                      onclick="handleModelArchiveClick(event, '${
                        group.modelItemId
                      }', '${groupName}', '${type}')"
                    >
                      Archive Model
                    </button>
                  `;

              groupHeaderRow.innerHTML = `
                <td colspan="2" style="cursor:pointer; font-weight:700;">
                  <input
                    type="checkbox"
                    id="checkGroup-${groupId}"
                    onclick="event.stopPropagation(); toggleGroupUnits(this, '${groupId}', '${type}')"
                    style="margin-right:5px;"
                    ${isGroupChecked ? 'checked' : ''}
                  >
                  <span onclick="toggleGroup('${groupId}')"> <strong>${
                group.prefix
              } (${groupName})</strong></span>
                </td>
                <td>${group.category}</td>
                <td>${group.totalQuantity}</td>
                <td>${group.totalBorrowed}</td>
                <td>${totalAvailable}</td>
                <td>${group.location}</td>
                <td><span class="status-badge status-${headerStatusClass}">${headerStatus}</span></td>
                <td class="actions-cell">${headerActionsHtml}</td>
              `;

              group.items
                .sort((a, b) => a.itemId.localeCompare(b.itemId))
                .forEach((item) => {
                  const borrowedQty =
                    (item.originalQuantity || 0) - (item.quantity || 0);
                  const availableQty = item.quantity || 0;
                  const displayStatus =
                    borrowedQty > 0 &&
                    !['Maintenance', 'Damaged', 'Calibration'].includes(
                      item.status || ''
                    )
                      ? 'In-Use'
                      : item.status || 'Available';
                  const statusClass = displayStatus.replace(
                    /[^a-zA-Z0-9]/g,
                    ''
                  );

                  const actionsHtml = isArchiveView
                    ? `
                        <button class="btn btn-restore" onclick="restoreInventoryItem('${item.itemId}')">Restore</button>
                        <button class="btn btn-delete-permanent" onclick="deleteInventoryItemPermanently('${item.itemId}')">Delete Permanently</button>
                      `
                    : `
                        <button class="btn btn-edit" onclick="openEditModal('${type}', '${item.itemId}')">Edit</button>
                        <button class="btn btn-delete" onclick="archiveInventoryItem('${type}', '${item.itemId}')">Archive</button>
                      `;

                  const itemRow = tableBody.insertRow();
                  itemRow.classList.add('inventory-item-detail', groupId);
                  itemRow.style.display = 'none';
                  itemRow.innerHTML = `
                    <td style="padding-left:15px; width:120px;">
                      <input
                        type="checkbox"
                        data-item-id="${item.itemId}"
                        data-group-id="${groupId}"
                        onclick="event.stopPropagation(); toggleItemSelection('${
                          item.itemId
                        }')"
                        ${
                          selectedArchivedItems.includes(item.itemId)
                            ? 'checked'
                            : ''
                        }
                      >
                      <span style="padding-left:5px;">${item.itemId}</span>
                    </td>
                    <td>${item.name}</td>
                    <td colspan="4" style="color:#6c757d; font-style:italic; text-align:left;"> Unit Detail </td>
                    <td>${item.location}</td>
                    <td><span class="status-badge status-${statusClass}">${displayStatus}</span></td>
                    <td class="actions-cell">${actionsHtml}</td>
                  `;
                });
            });
        }

        function renderBulkActionBar() {
          const actionBar = document.getElementById('bulkActionBar');
          const countSpan = document.getElementById('selectedCount');
          const restoreBtn = actionBar.querySelector('.btn-restore');
          const deleteBtn = actionBar.querySelector('.btn-delete-permanent');
          const count = selectedArchivedItems.length;

          countSpan.textContent = `${count} Item${
            count === 1 ? '' : 's'
          } Selected`;
          actionBar.style.display = count > 0 ? 'flex' : 'none';

          if (count === 0) {
            restoreBtn.onclick = null;
            deleteBtn.onclick = null;
            return;
          }

          if (isViewingInventoryArchive) {
            restoreBtn.textContent = 'Bulk Restore';
            restoreBtn.style.backgroundColor = 'var(--info)';
            restoreBtn.onclick = window.bulkRestoreSelected;

            deleteBtn.textContent = 'Delete Permanently';
            deleteBtn.style.display = 'inline-block';
            deleteBtn.onclick = window.bulkDeleteSelected;
          } else {
            restoreBtn.textContent = 'Bulk Archive';
            restoreBtn.style.backgroundColor = 'var(--danger)';
            restoreBtn.onclick = window.bulkArchiveSelected;

            deleteBtn.textContent = 'Cancel Selection';
            deleteBtn.style.display = 'inline-block';
            deleteBtn.onclick = () => {
              selectedArchivedItems = [];
              document
                .querySelectorAll(
                  '.inventory-item-detail input[type="checkbox"]'
                )
                .forEach((cb) => {
                  cb.checked = false;
                });
              const masterCheckbox = document.getElementById('checkAllUnits');
              if (masterCheckbox) masterCheckbox.checked = false;
              updateMasterAndBulkActionUI();
              showToast('Selection cancelled.', 'warning');
            };
          }
        }

        function updateMasterAndBulkActionUI() {
          renderBulkActionBar();
          const allUnits = document.querySelectorAll(
            '.inventory-item-detail input[type="checkbox"]'
          );
          const masterCheckbox = document.getElementById('checkAllUnits');
          if (masterCheckbox) {
            masterCheckbox.checked =
              allUnits.length > 0 &&
              selectedArchivedItems.length === allUnits.length;
          }
        }

        window.toggleGroup = (groupId) => {
          const detailRows = document.querySelectorAll(`.${groupId}`);
          const headerRow = document.getElementById(`${groupId}-header`);
          if (!headerRow) return;

          const isVisible =
            detailRows.length > 0 && detailRows[0].style.display !== 'none';
          detailRows.forEach((row) => {
            row.style.display = isVisible ? 'none' : '';
          });

          const span = headerRow.querySelector('span');
          if (span) {
            span.innerHTML = span.innerHTML.replace(
              /[]/,
              isVisible ? '' : ''
            );
          }
        };

        window.toggleGroupUnits = (masterCheckbox, groupId, type) => {
          const individualCheckboxes = document.querySelectorAll(
            `.inventory-item-detail input[type="checkbox"][data-group-id="${groupId}"]`
          );
          const isChecking = masterCheckbox.checked;

          individualCheckboxes.forEach((cb) => {
            cb.checked = isChecking;
            const itemId = cb.getAttribute('data-item-id');
            const index = selectedArchivedItems.indexOf(itemId);
            if (isChecking && index === -1) {
              selectedArchivedItems.push(itemId);
            } else if (!isChecking && index > -1) {
              selectedArchivedItems.splice(index, 1);
            }
          });

          updateMasterAndBulkActionUI();
        };

        window.toggleItemSelection = (itemId) => {
          const index = selectedArchivedItems.indexOf(itemId);
          if (index > -1) {
            selectedArchivedItems.splice(index, 1);
          } else {
            selectedArchivedItems.push(itemId);
          }
          updateMasterAndBulkActionUI();
        };

        window.toggleAllUnits = (checkbox) => {
          const allUnitCheckboxes = document.querySelectorAll(
            '.inventory-item-detail input[type="checkbox"]'
          );
          selectedArchivedItems = [];
          allUnitCheckboxes.forEach((cb) => {
            cb.checked = checkbox.checked;
            if (checkbox.checked) {
              selectedArchivedItems.push(cb.getAttribute('data-item-id'));
            }
          });
          updateMasterAndBulkActionUI();
        };

        function resolveItemTypeById(itemId) {
          return Object.keys(inventoryTypes).find((inventoryType) =>
            inventoryTypes[inventoryType].store.some(
              (item) => item.itemId === itemId
            )
          );
        }

        window.bulkArchiveSelected = async () => {
          if (selectedArchivedItems.length === 0)
            return showToast('No items selected.', 'warning');
          if (
            !confirm(
              `Archive ${selectedArchivedItems.length} selected item${
                selectedArchivedItems.length === 1 ? '' : 's'
              }?`
            )
          )
            return;
          try {
            let archivedCount = 0;
            for (const itemId of selectedArchivedItems) {
              const type = resolveItemTypeById(itemId);
              if (!type) continue;
              const response = await fetch(
                `${inventoryTypes[type].api}/${itemId}`,
                { method: 'DELETE' }
              );
              if (response.ok) {
                archivedCount += 1;
              }
            }
            showToast(`Archived ${archivedCount} item(s).`, 'success');
            selectedArchivedItems = [];
            for (const inventoryType in inventoryTypes) {
              fetchInventory(inventoryType);
            }
            if (isViewingInventoryArchive) {
              fetchArchivedInventory();
            } else {
              renderBulkActionBar();
            }
          } catch (error) {
            showToast(`Error during bulk archive: ${error.message}`, 'error');
          }
        };

        window.bulkRestoreSelected = async () => {
          if (selectedArchivedItems.length === 0)
            return showToast('No items selected.', 'warning');
          if (
            !confirm(
              `Restore ${selectedArchivedItems.length} archived item${
                selectedArchivedItems.length === 1 ? '' : 's'
              }?`
            )
          )
            return;
          try {
            let restored = 0;
            for (const itemId of selectedArchivedItems) {
              const response = await fetch(
                `/api/inventory/restore/${encodeURIComponent(itemId)}`,
                { method: 'PUT' }
              );
              if (response.ok) {
                restored += 1;
              }
            }
            showToast(`Restored ${restored} item(s).`, 'success');
            selectedArchivedItems = [];
            fetchArchivedInventory();
            for (const inventoryType in inventoryTypes) {
              fetchInventory(inventoryType);
            }
          } catch (error) {
            showToast(`Error during bulk restore: ${error.message}`, 'error');
          }
        };

        window.bulkDeleteSelected = async () => {
          if (selectedArchivedItems.length === 0)
            return showToast('No items selected.', 'warning');
          if (
            !confirm(
              `WARNING: Permanently delete ${
                selectedArchivedItems.length
              } item${
                selectedArchivedItems.length === 1 ? '' : 's'
              }? This cannot be undone.`
            )
          )
            return;
          try {
            let deleted = 0;
            for (const itemId of selectedArchivedItems) {
              const response = await fetch(
                `/api/inventory/permanent/${encodeURIComponent(itemId)}`,
                { method: 'DELETE' }
              );
              if (response.ok) deleted += 1;
            }
            showToast(`Deleted ${deleted} item(s).`, 'success');
            selectedArchivedItems = [];
            fetchArchivedInventory();
          } catch (error) {
            showToast(`Error during bulk delete: ${error.message}`, 'error');
          }
        };

        window.handleModelArchiveClick = async (
          event,
          itemId,
          groupName,
          type
        ) => {
          event.stopPropagation();
          if (isViewingInventoryArchive) {
            if (!confirm(`Restore all archived units of ${groupName}?`)) return;
            try {
              const itemsToRestore = inventoryTypes[type].store.filter(
                (item) => item.name === groupName
              );
              let restored = 0;
              for (const item of itemsToRestore) {
                const response = await fetch(
                  `/api/inventory/restore/${encodeURIComponent(item.itemId)}`,
                  { method: 'PUT' }
                );
                if (response.ok) restored += 1;
              }
              showToast(`Restored ${restored} item(s).`, 'success');
              fetchArchivedInventory();
              for (const inventoryType in inventoryTypes) {
                fetchInventory(inventoryType);
              }
            } catch (error) {
              showToast(`Error restoring model: ${error.message}`, 'error');
            }
            return;
          }
          if (
            !confirm(
              `Archive all units for ${groupName}? You can restore them from Archives.`
            )
          )
            return;
          try {
            const itemsToArchive = inventoryTypes[type].store.filter(
              (item) => item.name === groupName
            );
            let archived = 0;
            for (const item of itemsToArchive) {
              const response = await fetch(
                `${inventoryTypes[type].api}/${item.itemId}`,
                { method: 'DELETE' }
              );
              if (response.ok) archived += 1;
            }
            showToast(
              `Archived ${archived} item(s) for ${groupName}.`,
              'success'
            );
            fetchInventory(type);
            if (isViewingInventoryArchive) {
              fetchArchivedInventory();
            } else {
              renderBulkActionBar();
            }
          } catch (error) {
            showToast(`Error archiving model: ${error.message}`, 'error');
          }
        };

        window.handleModelDeleteClick = async (
          event,
          itemId,
          groupName,
          type
        ) => {
          event.stopPropagation();
          if (
            !confirm(
              `WARNING: Permanently delete all archived units for ${groupName}? This cannot be undone.`
            )
          )
            return;
          try {
            const itemsToDelete = inventoryTypes[type].store.filter(
              (item) => item.name === groupName
            );
            let deleted = 0;
            for (const item of itemsToDelete) {
              const response = await fetch(
                `/api/inventory/permanent/${encodeURIComponent(item.itemId)}`,
                { method: 'DELETE' }
              );
              if (response.ok) deleted += 1;
            }
            showToast(`Deleted ${deleted} item(s).`, 'success');
            fetchArchivedInventory();
          } catch (error) {
            showToast(`Error deleting model: ${error.message}`, 'error');
          }
        };

        window.handleModelEditClick = (event, type, itemId) => {
          event.stopPropagation();
          const button = event.currentTarget;
          const itemIdsAttr = button.getAttribute('data-item-ids');
          const itemIds = itemIdsAttr ? itemIdsAttr.split('|') : [itemId];
          openEditModal(type, itemId, itemIds);
        };

        function findNextSequenceId(prefix, items) {
          let maxNum = 0;
          const prefixPattern = new RegExp(`^${prefix}-(\\d+)$`, 'i');
          items.forEach((item) => {
            const match = item.itemId?.match(prefixPattern);
            if (match) {
              const num = parseInt(match[1], 10);
              if (!Number.isNaN(num) && num > maxNum) {
                maxNum = num;
              }
            }
          });
          return maxNum + 1;
        }

        async function handleAddItem(e, type) {
          e.preventDefault();
          const config = inventoryTypes[type];
          const form = e.target;
          const prefix = form
            .querySelector('[name="itemIdPrefix"]')
            .value.toUpperCase()
            .trim();
          const name = form.querySelector('[name="name"]').value.trim();
          const category = form.querySelector('[name="category"]').value;
          const quantity = parseInt(
            form.querySelector('[name="quantity"]').value,
            10
          );
          const location = form.querySelector('[name="location"]').value.trim();

          if (!prefix) {
            showToast('Item ID Prefix cannot be empty.', 'error');
            return;
          }
          if (!name) {
            showToast('Name is required.', 'error');
            return;
          }
          if (!Number.isInteger(quantity) || quantity <= 0) {
            showToast('Quantity must be 1 or more.', 'error');
            return;
          }

          const nextSequenceNumber = findNextSequenceId(prefix, config.store);
          const itemsToCreate = [];
          const maxDigits = Math.max(
            2,
            String(nextSequenceNumber + quantity - 1).length
          );

          for (let i = 0; i < quantity; i += 1) {
            const sequence = String(nextSequenceNumber + i).padStart(
              maxDigits,
              '0'
            );
            itemsToCreate.push({
              itemId: `${prefix}-${sequence}`,
              name,
              category,
              quantity: 1,
              originalQuantity: 1,
              location,
              status: 'Available',
            });
          }

          try {
            const response = await fetch(config.api, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(itemsToCreate),
            });
            if (!response.ok) {
              const errorBody = await response.json().catch(() => ({}));
              throw new Error(
                errorBody.message || `Failed to add ${quantity} items.`
              );
            }
            showToast(
              `Successfully added ${quantity} items (IDs: ${
                itemsToCreate[0].itemId
              } - ${itemsToCreate[itemsToCreate.length - 1].itemId}).`,
              'success'
            );
            form.reset();
            fetchInventory(type);
          } catch (error) {
            showToast(`Error: ${error.message}`, 'error');
          }
        }
        async function handleUpdateItem(e) {
          e.preventDefault();
          const editFormElement = document.getElementById('editForm');
          const formType = editFormElement.dataset.type;
          if (formType === 'inventory') {
            const itemId = document.getElementById('editItemId').value;
            const type = document.getElementById('editItemType').value;
            const config = inventoryTypes[type];
            const itemIdsAttr = editFormElement.dataset.itemIds || itemId;
            const itemIds = itemIdsAttr.split(',').filter(Boolean);

            const updatedData = {
              name: document.getElementById('editItemName').value.trim(),
              category: document.getElementById('editCategory').value,
              location: document.getElementById('editLocation').value.trim(),
            };

            try {
              await Promise.all(
                itemIds.map(async (id) => {
                  const response = await fetch(`${config.api}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData),
                  });
                  if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({}));
                    throw new Error(
                      errorBody.message || `Failed to update item ${id}`
                    );
                  }
                })
              );
              showToast('Item updated successfully!', 'success');
              editModal.style.display = 'none';
              if (isViewingInventoryArchive) {
                fetchArchivedInventory();
              } else {
                fetchInventory(type);
              }
            } catch (error) {
              showToast(`Error: ${error.message}`, 'error');
            }
          } else if (formType === 'request') {
            const requestId = document.getElementById('editRequestId').value;
            const updatedData = {
              itemName: document.getElementById('editItemName').value,
              quantity: parseInt(document.getElementById('editQuantity').value),
              reason: document.getElementById('editReason').value,
              startDate: document.getElementById('editStartDate').value,
              dueDate: document.getElementById('editDueDate').value,
            };
            try {
              const response = await fetch(`/api/edit-request/${requestId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedData),
              });
              const result = await response.json();
              if (!response.ok)
                throw new Error(result.message || 'Failed to update request');
              showToast('Request updated successfully!');
              editModal.style.display = 'none';
              fetchAllRequests();
            } catch (error) {
              showToast(`Error: ${error.message}`);
            }
          }
        }

        // --- 7. REQUESTS & NOTIFICATIONS LOGIC ---
        async function fetchAdminNotifications() {
          try {
            const response = await fetch('/api/admin/notifications');
            if (!response.ok) throw new Error('Could not fetch notifications.');
            notifications = await response.json();
            if (
              document
                .getElementById('notifications-content')
                .classList.contains('active')
            ) {
              renderNotifications();
            }
            updateNotificationBadge();
          } catch (error) {
            console.error(error);
          }
        }
        const updateNotificationBadge = () => {
          const unreadCount = notifications.filter((n) => !n.isRead).length;
          notificationBadge.textContent = unreadCount;
          notificationBadge.style.display =
            unreadCount > 0 ? 'inline-block' : 'none';
        };
        const renderNotifications = () => {
          notificationList.innerHTML = '';
          if (notifications.length === 0) {
            notificationList.innerHTML = '<p>No new notifications.</p>';
          } else {
            notifications.forEach((n) => {
              const item = document.createElement('div');
              item.className = 'notification-item';
              item.innerHTML = `
                        <div class="notification-title">${n.title}</div>
                        <div class="notification-message">${n.message}</div>
                        <div class="notification-time">${new Date(
                          n.createdAt
                        ).toLocaleString()}</div>`;
              notificationList.appendChild(item);
            });
          }
          fetch('/api/notifications/mark-read', { method: 'POST' });
          notifications.forEach((n) => (n.isRead = true));
          updateNotificationBadge();
        };

        const toggleRequestView = () => {
          isViewingTrash = !isViewingTrash;
          if (isViewingTrash) {
            fetchDeletedRequests();
          } else {
            fetchAllRequests();
          }
        };
        async function fetchDeletedRequests() {
          try {
            const response = await fetch('/api/deleted-requests');
            if (!response.ok)
              throw new Error('Failed to fetch deleted requests');
            allRequestsData = await response.json();
            if (
              document
                .getElementById('requests-content')
                .classList.contains('active')
            ) {
              isViewingTrash = true;
              renderRequestsTable();
            }
          } catch (error) {
            showToast(error.message);
          }
        }

        const fetchAllRequests = async () => {
          try {
            if (isViewingTrash) return;
            const response = await fetch('/api/admin3-requests');
            if (!response.ok) throw new Error('Failed to fetch requests');
            allRequestsData = await response.json();

            if (
              document
                .getElementById('requests-content')
                .classList.contains('active')
            ) {
              renderRequestsTable();
            }
          } catch (error) {
            showToast(error.message);
            if (
              document
                .getElementById('requests-content')
                .classList.contains('active')
            ) {
              requestsTableBody.innerHTML = `<tr><td colspan="9" style="text-align:center;">Failed to load requests.</td></tr>`;
            }
          }
        };

        const renderRequestsTable = () => {
          requestsTitle.textContent = isViewingTrash
            ? 'Deleted Requests (Trash)'
            : 'Manage Student Requests';
          toggleTrashViewBtn.textContent = isViewingTrash
            ? 'View Active Requests'
            : 'View Trash';
          requestStatusFilter.style.display = isViewingTrash ? 'none' : 'block';

          const searchTerm = requestSearch.value.toLowerCase();
          const currentStatus = requestStatusFilter.value;

          let filtered = allRequestsData.filter((req) => {
            const matchesSearch =
              req.studentName.toLowerCase().includes(searchTerm) ||
              req.itemName.toLowerCase().includes(searchTerm) ||
              req.itemId.toLowerCase().includes(searchTerm);
            const matchesStatus =
              isViewingTrash ||
              currentStatus === 'All' ||
              req.status === currentStatus;
            return matchesSearch && matchesStatus;
          });

          requestsTableBody.innerHTML = '';
          const sortedData = filtered.sort(
            (a, b) => new Date(b.requestDate) - new Date(a.requestDate)
          );
          if (sortedData.length === 0) {
            const message = isViewingTrash
              ? 'The trash is empty.'
              : 'No student requests found.';
            requestsTableBody.innerHTML = `<tr><td colspan="9" style="text-align:center;">${message}</td></tr>`;
            return;
          }
          sortedData.forEach((req) => {
            const row = requestsTableBody.insertRow();
            const startDate = req.startDate
              ? new Date(req.startDate).toLocaleDateString()
              : 'N/A';
            const dueDate = req.dueDate
              ? new Date(req.dueDate).toLocaleDateString()
              : 'N/A';

            let actions;
            if (isViewingTrash) {
              actions = `
                        <button class="btn btn-restore" onclick="restoreRequest('${req._id}')">Restore</button>
                        <button class="btn btn-delete" onclick="deleteRequestPermanently('${req._id}')">Delete Permanently</button>`;
            } else {
              actions = `
                        <button class="btn btn-edit" onclick="openEditRequestModal('${req._id}')">Edit</button>
                        <button class="btn" style="background-color:var(--primary-light); color:white;" onclick="openStatusEditModal('${req._id}')">Status</button>
                        <button class="btn btn-delete" onclick="moveRequestToTrash('${req._id}')">Delete</button>`;
            }

            row.innerHTML = `
                    <td>${req.studentName}</td><td>${req.itemId}</td><td>${
              req.itemName
            }</td>
                    <td>${startDate}</td><td>${dueDate}</td><td>${
              req.quantity
            }</td><td>${req.reason}</td>
                    <td><span class="status-badge status-${req.status.replace(
                      /[^a-zA-Z0-9]/g,
                      ''
                    )}">${req.status}</span></td>
                    <td class="actions-cell">${actions}</td>`;
          });
        };

        window.handleRequest = async (requestId, newStatus) => {
          try {
            const response = await fetch(`/api/update-request/${requestId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ status: newStatus }),
            });
            const result = await response.json();
            if (!response.ok)
              throw new Error(result.message || `Failed to update request`);
            showToast(result.message || `Request updated successfully.`);

            fetchAllRequests();
            fetchAdminNotifications();
            for (const type in inventoryTypes) fetchInventory(type);
          } catch (error) {
            showToast(`Error: ${error.message}`);
          }
        };

        window.moveRequestToTrash = async (requestId) => {
          if (
            !confirm('Are you sure you want to move this request to the trash?')
          )
            return;
          try {
            const res = await fetch(`/api/requests/${requestId}/delete`, {
              method: 'PUT',
            });
            const result = await res.json();
            if (!res.ok) throw new Error(result.message);
            showToast(result.message);
            fetchAllRequests();
          } catch (error) {
            showToast(`Error: ${error.message}`);
          }
        };
        window.restoreRequest = async (requestId) => {
          if (!confirm('Are you sure you want to restore this request?'))
            return;
          try {
            const res = await fetch(`/api/requests/${requestId}/restore`, {
              method: 'PUT',
            });
            const result = await res.json();
            if (!res.ok) throw new Error(result.message);
            showToast(result.message);
            fetchDeletedRequests();
          } catch (error) {
            showToast(`Error: ${error.message}`);
          }
        };
        window.deleteRequestPermanently = async (requestId) => {
          if (
            !confirm(
              'WARNING: This will permanently delete the request and cannot be undone. Are you sure?'
            )
          )
            return;
          try {
            const res = await fetch(`/api/requests/${requestId}/permanent`, {
              method: 'DELETE',
            });
            const result = await res.json();
            if (!res.ok) throw new Error(result.message);
            showToast(result.message);
            fetchDeletedRequests();
          } catch (error) {
            showToast(`Error: ${error.message}`);
          }
        };

        // --- 8. WINDOW-SCOPED FUNCTIONS for inline on-click ---
        window.openEditModal = (type, itemId, itemIds = [itemId]) => {
          const config = inventoryTypes[type];
          const itemsToEdit = config.store.filter((i) =>
            itemIds.includes(i.itemId)
          );
          const item = itemsToEdit[0];
          if (!item) return;

          const totalQuantityToShow = itemsToEdit.length;
          document.getElementById(
            'editModalTitle'
          ).innerText = `Edit ${type} Model: ${item.name}`;
          editForm.innerHTML = `
            <input type="hidden" id="editItemId" value="${item.itemId}">
            <input type="hidden" id="editItemType" value="${type}">
            <label for="editItemName">Equipment Name</label>
            <input type="text" id="editItemName" value="${item.name}" required />
            <label for="editCategory">Category</label>
            <input type="text" id="editCategory" value="${item.category}" readonly />
            <input type="hidden" id="editQuantity" value="${totalQuantityToShow}" />
            <label for="editLocation">Location</label>
            <input type="text" id="editLocation" value="${item.location}" required />
            <button type="submit">Save Changes</button>
          `;
          editForm.dataset.type = 'inventory';
          editForm.dataset.itemIds = itemIds.join(',');
          editForm.onsubmit = handleUpdateItem;
          editModal.style.display = 'flex';
        };
        window.openEditRequestModal = (requestId) => {
          const request = allRequestsData.find((r) => r._id === requestId);
          if (request) {
            document.getElementById('editModalTitle').innerText =
              'Edit Request';
            editForm.innerHTML = `
                    <input type="hidden" id="editRequestId" value="${
                      request._id
                    }">
                    <label for="editItemName">Item Name</label><input type="text" id="editItemName" value="${
                      request.itemName
                    }" required />
                    <label for="editQuantity">Quantity</label><input type="number" id="editQuantity" value="${
                      request.quantity
                    }" min="1" required />
                    <label for="editReason">Reason</label><textarea id="editReason" required>${
                      request.reason
                    }</textarea>
                    <label for="editStartDate">Start Date</label><input type="date" id="editStartDate" value="${
                      request.startDate
                        ? new Date(request.startDate)
                            .toISOString()
                            .split('T')[0]
                        : ''
                    }" required />
                    <label for="editDueDate">Due Date</label><input type="date" id="editDueDate" value="${
                      request.dueDate
                        ? new Date(request.dueDate).toISOString().split('T')[0]
                        : ''
                    }" required />
                    <button type="submit">Save Changes</button>`;
            editForm.dataset.type = 'request';
            editForm.onsubmit = handleUpdateItem;
            editModal.style.display = 'flex';
          }
        };

        // UPDATED: updateStatus to handle "In-Use" better
        window.updateStatus = async (type, selectElement, itemId) => {
          const newStatus = selectElement.value;
          const currentItem = inventoryTypes[type].store.find(
            (i) => i.itemId === itemId
          );
          if (!currentItem) return;

          const originalQty =
            currentItem.originalQuantity || currentItem.quantity || 0;
          const borrowedQty = originalQty - (currentItem.quantity || 0);

          if (
            newStatus === 'In-Use' ||
            (borrowedQty > 0 && newStatus !== 'In-Use')
          ) {
            showToast(
              "Status 'In-Use' is set automatically. To change status, all items must be returned first."
            );
            const actualStatus =
              borrowedQty > 0 ? 'In-Use' : currentItem.status || 'Available';
            selectElement.value = actualStatus;
            return;
          }

          try {
            // Logic from Admin 4: Set quantity based on status
            const isNowAvailable = newStatus === 'Available';
            const isNowUnavailable = [
              'Maintenance',
              'Calibration',
              'Damaged',
            ].includes(newStatus);

            const updateData = {
              status: newStatus,
              // If it's becoming unavailable, set available qty to 0
              // If it's becoming available, set available qty to total qty
              quantity: isNowUnavailable
                ? 0
                : isNowAvailable
                ? currentItem.originalQuantity
                : currentItem.quantity,
            };

            const response = await fetch(
              `${inventoryTypes[type].api}/${itemId}`,
              {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updateData),
              }
            );
            if (!response.ok) throw new Error('Failed to update status');
            showToast(`Status for ${itemId} updated to ${newStatus}.`);
            selectElement.className = `status-select status-${newStatus.replace(
              /[^a-zA-Z0-9]/g,
              ''
            )}`;
            fetchInventory(type);
          } catch (error) {
            showToast(`Error: ${error.message}`);
            fetchInventory(type);
          }
        };
        window.openStatusEditModal = (requestId) => {
          const request = allRequestsData.find((r) => r._id === requestId);
          if (request) {
            document.getElementById('statusRequestId').value = request._id;
            document.getElementById('statusSelect').value = request.status;
            statusEditModal.style.display = 'flex';
          }
        };

        window.archiveInventoryItem = async (type, itemId) => {
          if (
            !confirm(
              `Are you sure you want to archive item ${itemId}? This moves it to the decommissioned status.`
            )
          )
            return;
          try {
            const response = await fetch(
              `${inventoryTypes[type].api}/${itemId}`,
              { method: 'DELETE' }
            );
            if (!response.ok) throw new Error('Failed to archive item');
            showToast('Item archived successfully.');
            fetchInventory(type);
            if (isViewingInventoryArchive) {
              fetchArchivedInventory();
            }
          } catch (error) {
            showToast(`Error: ${error.message}`);
          }
        };
        function encodeItemId(value) {
          if (typeof value !== 'string') return '';
          return encodeURIComponent(value);
        }
        function escapeAttribute(value) {
          return String(value)
            .replace(/&/g, '&amp;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
        }
        window.restoreInventoryItem = async (itemId) => {
          if (!itemId) {
            showToast('Error: Missing item identifier to restore.');
            return;
          }
          if (!confirm('Are you sure you want to restore this item?')) return;
          try {
            const res = await fetch(
              `/api/inventory/restore/${encodeItemId(itemId)}`,
              {
                method: 'PUT',
              }
            );
            const result = await res.json();
            if (!res.ok) throw new Error(result.message);
            showToast(result.message);
            fetchArchivedInventory();
            for (const type in inventoryTypes) fetchInventory(type);
          } catch (error) {
            showToast(`Error: ${error.message}`);
          }
        };
        window.deleteInventoryItemPermanently = async (itemId) => {
          if (!itemId) {
            showToast('Error: Missing item identifier to delete.');
            return;
          }
          if (
            !confirm(
              'WARNING: This will permanently delete the item and all its history. Are you sure?'
            )
          )
            return;
          try {
            const res = await fetch(
              `/api/inventory/permanent/${encodeItemId(itemId)}`,
              {
                method: 'DELETE',
              }
            );
            const result = await res.json();
            if (!res.ok) throw new Error(result.message);
            showToast(result.message);
            fetchArchivedInventory();
          } catch (error) {
            showToast(`Error: ${error.message}`);
          }
        };

        async function fetchArchivedInventory() {
          try {
            const response = await fetch('/api/archived-inventory');
            if (!response.ok)
              throw new Error('Failed to fetch archived inventory');
            const payload = await response.json();
            const archiveData = Array.isArray(payload) ? payload : [];
            combinedArchivedInventory = archiveData;
            Object.entries(inventoryTypes).forEach(
              ([inventoryType, config]) => {
                const categoryLabel = categoryFilters[inventoryType];
                config.store = archiveData.filter(
                  (item) =>
                    (item.category || '').toLowerCase() ===
                    (categoryLabel || '').toLowerCase()
                );
              }
            );
            isViewingInventoryArchive = true;
            if (
              document
                .getElementById('inventory-content')
                .classList.contains('active')
            ) {
              for (const type in inventoryTypes) {
                renderTable(type);
              }
            }
          } catch (error) {
            showToast(error.message);
          }
        }
        const toggleInventoryArchiveView = () => {
          inventoryArchiveContainer.style.display = 'none';
          inventoryActiveContainer.style.display = 'block';
          if (isViewingInventoryArchive) {
            isViewingInventoryArchive = false;
            for (const type in inventoryTypes) {
              fetchInventory(type);
            }
          } else {
            fetchArchivedInventory();
          }
        };

        // --- 9. UTILITIES ---
        window.showToast = (message) => {
          const container = document.getElementById('toast-container');
          const toast = document.createElement('div');
          toast.className = 'toast';
          toast.textContent = message;
          container.appendChild(toast);
          setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 500);
          }, 3000);
        };

        // --- 10. Reports Feature (Copied from Admin 3, as it's already correct) ---
        reportTypeSelect.addEventListener('change', () => {
          const selectedType = reportTypeSelect.value;
          const needsPeriod = selectedType !== '';

          periodBtns.forEach((btn) => {
            btn.disabled = !needsPeriod;
          });
          if (selectedType) {
            periodBtns.forEach((b) => b.classList.remove('active'));
            document.getElementById('dailyBtn').classList.add('active');
            selectedPeriod = 'daily';
          } else {
            periodBtns.forEach((b) => b.classList.remove('active'));
            document.getElementById('dailyBtn').classList.add('active');
          }
        });

        periodBtns.forEach((btn) => {
          btn.addEventListener('click', () => {
            periodBtns.forEach((b) => b.classList.remove('active'));
            btn.classList.add('active');
            selectedPeriod = btn.id.replace('Btn', '');
          });
        });

        generateReportBtn.addEventListener('click', async () => {
          const selectedReportType = reportTypeSelect.value;
          reportResult.style.display = 'none';
          printReportBtn.style.display = 'none';
          if (!selectedReportType) {
            showToast('Please select a report type.');
            return;
          }

          try {
            await fetch('/api/reports', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ reportType: selectedReportType }),
            });
          } catch (e) {
            console.error('Failed to log report generation', e);
          }
          showToast('Generating report...');

          try {
            const now = new Date();
            let reportText = '';
            let startDate;

            switch (selectedPeriod) {
              case 'daily':
                startDate = new Date(
                  now.getFullYear(),
                  now.getMonth(),
                  now.getDate()
                );
                break;
              case 'weekly':
                const day = now.getDay();
                startDate = new Date(
                  now.getFullYear(),
                  now.getMonth(),
                  now.getDate() - (day === 0 ? 6 : day - 1)
                );
                break;
              case 'yearly':
                startDate = new Date(now.getFullYear(), 0, 1);
                break;
              default:
                startDate = new Date(0);
            }

            const startDateStr = startDate.toLocaleDateString('en-US', {
              month: 'numeric',
              day: 'numeric',
              year: 'numeric',
            });
            const endDateStr = now.toLocaleDateString('en-US', {
              month: 'numeric',
              day: 'numeric',
              year: 'numeric',
            });

            const inventoryDataArrays = await Promise.all(
              Object.values(inventoryTypes).map((type) =>
                fetch(type.api).then((res) => res.json())
              )
            );
            const allInventory = [].concat(...inventoryDataArrays);

            const requestsResponse = await fetch('/api/admin3-requests');
            if (!requestsResponse.ok)
              throw new Error('Failed to fetch requests');
            const allRequests = await requestsResponse.json();

            const filteredRequests = allRequests.filter(
              (r) => new Date(r.requestDate) >= startDate
            );
            const filteredReturnedRequests = allRequests.filter(
              (r) =>
                r.status === 'Returned' && new Date(r.requestDate) >= startDate
            );

            reportText += `<b>Report Type:</b> ${
              reportTypeSelect.options[reportTypeSelect.selectedIndex].text
            } (${selectedPeriod})<br>`;
            reportText += `<b>Date Range:</b> ${startDateStr} - ${endDateStr}<br><br>`;

            if (selectedReportType === 'inventory') {
              const inventoryForReport = allInventory;
              const totalItems = inventoryForReport.reduce(
                (sum, i) => sum + (i.originalQuantity || i.quantity || 0),
                0
              );
              const availableItems = inventoryForReport.reduce(
                (sum, i) => sum + (i.quantity || 0),
                0
              );
              const inUseItems = totalItems - availableItems;
              const maintenanceItems = inventoryForReport.filter(
                (i) =>
                  i.status === 'Maintenance' ||
                  i.status === 'Damaged' ||
                  i.status === 'Calibration'
              ).length; // <-- ADDED CALIBRATION

              reportText += `<b>Summary (Current Active Inventory):</b><br>Total Items: ${totalItems}<br>Available Items: ${availableItems}<br>Items In Use: ${inUseItems}<br>Items Under Maintenance/Damaged/Calibration: ${maintenanceItems}<br><br>`;
              reportText += `<table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; width: 100%;">`;
              reportText += `<thead><tr><th>ID</th><th>Name</th><th>Category</th><th>Total Qty</th><th>Borrowed</th><th>Available</th><th>Location</th><th>Status</th></tr></thead><tbody>`;

              inventoryForReport.forEach((item) => {
                const originalQty = item.originalQuantity || item.quantity || 0;
                const availableQty = item.quantity || 0;
                const borrowedQty = originalQty - availableQty;
                const displayStatus =
                  borrowedQty > 0 ? 'In-Use' : item.status || 'Available';
                reportText += `<tr><td>${item.itemId}</td><td>${item.name}</td><td>${item.category}</td><td>${originalQty}</td><td>${borrowedQty}</td><td>${availableQty}</td><td>${item.location}</td><td>${displayStatus}</td></tr>`;
              });
              reportText += `</tbody></table>`;
            } else if (selectedReportType === 'requests') {
              reportText += `<b>Summary (Requests Submitted in Period):</b><br>Total Requests in Period: ${
                filteredRequests.length
              }<br>Pending: ${
                filteredRequests.filter((r) => r.status === 'Pending').length
              }<br>Approved: ${
                filteredRequests.filter((r) => r.status === 'Approved').length
              }<br>Rejected: ${
                filteredRequests.filter((r) => r.status === 'Rejected').length
              }<br>Returned: ${
                filteredRequests.filter((r) => r.status === 'Returned').length
              }<br><br>`;
              reportText += `<table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; width: 100%;">`;
              reportText += `<thead><tr><th>Requester</th><th>Item</th><th>Qty</th><th>Status</th><th>Date Submitted</th></tr></thead><tbody>`;
              filteredRequests.forEach((req) => {
                reportText += `<tr><td>${req.studentName}</td><td>${
                  req.itemName
                }</td><td>${req.quantity}</td><td>${
                  req.status
                }</td><td>${new Date(
                  req.requestDate
                ).toLocaleDateString()}</td></tr>`;
              });
              reportText += `</tbody></table>`;
            } else if (selectedReportType === 'usage') {
              const approvedRequestsInPeriod = filteredRequests.filter(
                (r) => r.status === 'Approved'
              );
              const usageMap = {};
              approvedRequestsInPeriod.forEach((req) => {
                usageMap[req.itemName] =
                  (usageMap[req.itemName] || 0) + req.quantity;
              });

              reportText += `<b>Summary:</b><br>Total Items Borrowed (Approved) in Period: ${approvedRequestsInPeriod.reduce(
                (sum, r) => sum + r.quantity,
                0
              )}<br><br>`;
              reportText += `<b>Most Used Items:</b><br><table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; width: 100%;">`;
              reportText += `<thead><tr><th>Item Name</th><th>Quantity Borrowed (in period)</th></tr></thead><tbody>`;
              const usageData = Object.entries(usageMap).sort(
                (a, b) => b[1] - a[1]
              );

              if (usageData.length === 0) {
                reportText += `<tr><td colspan="2" style="text-align:center;">No items were approved for borrowing during this period.</td></tr>`;
              } else {
                usageData.forEach(([name, count]) => {
                  reportText += `<tr><td>${name}</td><td>${count}</td></tr>`;
                });
              }
              reportText += `</tbody></table>`;
            } else if (selectedReportType === 'accountability') {
              const accountabilityMap = filteredReturnedRequests.reduce(
                (acc, req) => {
                  const studentId = req.studentId;
                  if (!acc[studentId]) {
                    acc[studentId] = {
                      studentName: req.studentName,
                      totalReturned: 0,
                      damaged: 0,
                      good: 0,
                      incidents: [],
                    };
                  }
                  const isDamagedOrLost =
                    req.returnCondition === 'Damaged' ||
                    req.returnCondition === 'Lost';
                  const conditionKey = isDamagedOrLost ? 'damaged' : 'good';
                  acc[studentId][conditionKey] += req.quantity;
                  acc[studentId].totalReturned += req.quantity;
                  if (isDamagedOrLost) {
                    acc[studentId].incidents.push({
                      itemName: req.itemName,
                      condition: req.returnCondition,
                      notes: req.damageNotes || 'No notes provided.',
                      date: new Date(req.requestDate).toLocaleDateString(),
                    });
                  }
                  return acc;
                },
                {}
              );

              const accountabilityData = await fetch(
                '/api/reports/user-accountability'
              ).then((res) => res.json());

              reportText += `<b>Summary:</b><br>Total Items Returned in Period: ${filteredReturnedRequests.reduce(
                (sum, r) => sum + r.quantity,
                0
              )}<br><br>`;
              reportText += `<h2>User Accountability Report Summary (Time-Filtered Returns)</h2>`;
              reportText += `<p>Data reflects the quantity of items marked 'Returned' in the selected period, grouped by condition.</p><br>`;
              reportText += `<table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; width: 100%;">`;
              reportText += `<thead><tr><th>Student Name</th><th>Total Returned</th><th style="color:var(--success);">Returned Good</th><th style="color:var(--danger);">Damaged/Lost</th></tr></thead><tbody>`;

              const finalData = Object.values(accountabilityMap).sort((a, b) =>
                a.studentName.localeCompare(b.studentName)
              );

              if (finalData.length === 0) {
                reportText += `<tr><td colspan="4" style="text-align:center;">No items were returned during this period.</td></tr>`;
              } else {
                finalData.forEach((student) => {
                  reportText += `<tr>
                                <td>${student.studentName}</td>
                                <td>${student.totalReturned}</td>
                                <td style="color:var(--success); font-weight:600;">${student.good}</td>
                                <td style="color:var(--danger); font-weight:600;">${student.damaged}</td>
                            </tr>`;
                  if (student.incidents && student.incidents.length > 0) {
                    reportText += `
                                <tr style="background-color: ${
                                  body.classList.contains('dark')
                                    ? '#343a40'
                                    : '#f8f9fa'
                                };">
                                    <td colspan="4" style="padding-left: 30px; border-bottom: none;">
                                        <details open>
                                            <summary style="font-weight: 600; color: var(--danger);">View Damaged/Lost Items (${
                                              student.incidents.length
                                            } items)</summary>
                                            <table style="width: 95%; margin: 10px 0; border: 1px solid var(--border-light);">
                                                <thead>
                                                    <tr style="font-size: 0.8rem;">
                                                        <th style="width: 30%; background-color: #fcebeb; color: var(--text-dark);">Item Name</th>
                                                        <th style="width: 15%; background-color: #fcebeb; color: var(--text-dark);">Condition</th>
                                                        <th style="width: 45%; background-color: #fcebeb; color: var(--text-dark);">Notes</th>
                                                        <th style="width: 10%; background-color: #fcebeb; color: var(--text-dark);">Date</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${student.incidents
                                                      .map(
                                                        (inc) => `
                                                        <tr>
                                                            <td>${
                                                              inc.itemName
                                                            }</td>
                                                            <td style="color: ${
                                                              inc.condition ===
                                                              'Lost'
                                                                ? 'var(--danger)'
                                                                : 'var(--warning)'
                                                            }; font-weight: 600;">${
                                                          inc.condition
                                                        }</td>
                                                            <td>${
                                                              inc.notes
                                                            }</td>
                                                            <td>${inc.date}</td>
                                                        </tr>
                                                    `
                                                      )
                                                      .join('')}
                                                </tbody>
                                            </table>
                                        </details>
                                    </td>
                                </tr>`;
                  }
                });
              }
              reportText += `</tbody></table>`;

              reportText += `<br><h2>All-Time Pending Incidents Summary</h2>`;
              reportText += `<p>This table shows all students with **currently pending** (unresolved) damaged/lost item incidents, regardless of the selected period.</p><br>`;
              reportText += `<table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; width: 100%;">`;
              reportText += `<thead><tr><th>Student Name</th><th>Pending Incidents</th></tr></thead><tbody>`;

              const pendingIncidents = accountabilityData.filter(
                (s) => s.pendingIncidents > 0
              );
              if (pendingIncidents.length === 0) {
                reportText += `<tr><td colspan="2" style="text-align:center;">No students have pending incidents.</td></tr>`;
              } else {
                pendingIncidents.forEach((student) => {
                  reportText += `<tr><td>${student.studentName}</td><td style="color:var(--danger); font-weight:600;">${student.pendingIncidents}</td></tr>`;
                });
              }
              reportText += `</tbody></table>`;
            }

            reportResult.innerHTML = reportText;
            reportResult.style.display = 'block';
            printReportBtn.style.display = 'inline-block';
            showToast('Report generated.');
          } catch (error) {
            periodBtns.forEach((btn) => (btn.disabled = false));
            reportResult.innerHTML = `Error: ${error.message}`;
            reportResult.style.display = 'block';
            printReportBtn.style.display = 'none';
            showToast(`Error generating report: ${error.message}`);
          }
        });
        printReportBtn.addEventListener('click', () => {
          const printWindow = window.open('', '', 'width=800,height=600');
          printWindow.document.write(
            `<html><head><title>LabLinX Report</title><style>body { font-family: 'Times New Roman', serif; padding: 20px; font-size: 11pt; } table { border-collapse: collapse; width: 100%; margin-top: 15px; font-size: 10pt; } th, td { border: 1px solid #000; padding: 6px; text-align: left; } th { background-color: #f0f0f0; color: #000; font-weight: bold; text-transform: uppercase; } b { color: #000; } .report-header { text-align: center; margin-bottom: 25px; } .report-header img { width: 80px; height: 80px; margin-bottom: 10px; } .report-header h2 { margin: 0; font-size: 18pt; color: #00503B; font-weight: bold; } .report-header h3 { margin: 5px 0 0 0; font-size: 14pt; color: #007A5A; } .report-info { text-align: left; margin-top: 15px; border-bottom: 2px solid #000; padding-bottom: 10px; } .report-info b { font-weight: 700; }</style></head><body><div class="report-header"><img src="logo.png" alt="University Logo" class="logo-image"><h2>De La Salle University - Dasmarias</h2><h3>LabLinX Inventory Management System</h3></div><div class="report-content">${reportResult.innerHTML}</div></body></html>`
          );
          printWindow.document.close();
          printWindow.focus();
          setTimeout(() => {
            printWindow.print();
          }, 300);
        });

        // --- ADDED: WebSocket Function ---
        function connectWebSocket() {
          const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
          const wsHost = `${window.location.hostname}:3000`;
          const ws = new WebSocket(`${protocol}://${wsHost}`);

          ws.onopen = () => {
            console.log('WebSocket Connected');
          };

          ws.onmessage = (event) => {
            try {
              const message = JSON.parse(event.data);
              if (message.type === 'refresh') {
                console.log('Refresh signal received');
                showToast('Data refreshed in real-time.');
                const activePage = document.querySelector(
                  '.page-content.active'
                );
                if (activePage) {
                  const pageId = activePage.id.replace('-content', '');
                  if (pageId === 'dashboard') {
                    updateDashboard();
                  } else if (pageId === 'inventory') {
                    if (isViewingInventoryArchive) {
                      fetchArchivedInventory();
                    } else {
                      for (const type in inventoryTypes) fetchInventory(type);
                    }
                  } else if (pageId === 'requests') {
                    if (isViewingTrash) {
                      fetchDeletedRequests();
                    } else {
                      fetchAllRequests();
                    }
                  } else if (pageId === 'notifications') {
                    fetchAdminNotifications();
                  }
                }
                if (activePage.id !== 'notifications-content') {
                  fetchAdminNotifications();
                }
              }
            } catch (e) {
              console.error('Error processing WebSocket message:', e);
            }
          };

          ws.onclose = () => {
            console.log('WebSocket Disconnected. Reconnecting in 3s...');
            setTimeout(connectWebSocket, 3000);
          };

          ws.onerror = (err) => {
            console.error('WebSocket Error:', err);
          };
        }

        // --- GO! ---
        initializeApp();
      });
    </script>
  </body>
</html>
